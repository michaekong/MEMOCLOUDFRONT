<!DOCTYPE html>
<html lang="en">
<head>
<title>Course - News Post</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="Course Project">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="styles/bootstrap4/bootstrap.min.css">
<link href="plugins/fontawesome-free-5.0.1/css/fontawesome-all.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="styles/news_post_styles.css">
<link rel="stylesheet" type="text/css" href="styles/news_post_responsive.css">
<style>
  .modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    overflow: auto;
  }
  
  .modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 30px;
    border: 1px solid #888;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  }
  
  .modal-content h2 {
    margin-bottom: 20px;
    color: #333;
  }
  
  .modal-content label {
    display: block;
    margin-top: 15px;
    margin-bottom: 5px;
    font-weight: 600;
    color: #555;
  }
  
  .modal-content input[type="text"],
  .modal-content input[type="file"],
  .modal-content select,
  .modal-content textarea {
    width: 100%;
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
  }
  
  .modal-content input:focus,
  .modal-content select:focus,
  .modal-content textarea:focus {
    border-color: #667eea;
    outline: none;
  }
  
  .modal-content textarea {
    min-height: 150px;
    resize: vertical;
    font-family: inherit;
  }
  
  .modal-content input[type="checkbox"] {
    width: auto;
    margin-right: 8px;
  }
  
  .error {
    background: #fee;
    color: #c33;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 15px;
  }
  
  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, white 0%, #f59e0b 100%);
    color: white;
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }
  
  .btn-secondary {
    background: #6c757d;
    color: white;
  }
  
  .btn-warning {
    background: #f59e0b;
    color: white;
    margin-right: 5px;
  }
  
  .btn-danger {
    background: #ef4444;
    color: white;
  }
  
  .btn-sm {
    padding: 6px 12px;
    font-size: 12px;
  }
  
  #adminPanel {
    margin-top: 30px;
    text-align: center;
  }
  
  .news_post_actions {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
  }
</style>
<script>
  const BASE_URL = 'https://memocloudfront.vercel.app/api';
  const UNIV_SLUG = 'ecole-des-travaux';
  let TOKEN = localStorage.getItem('authToken');
  let USER_ROLE = null;
</script>
</head>
<body>

<div class="super_container">

	<!-- Header -->

	<header class="header d-flex flex-row">
		<div class="header_content d-flex flex-row align-items-center">
			<!-- Logo -->
			<div class="logo_container">
				<div class="logo">
					<img src="images/logo.png" alt="">
					
				</div>
			</div>

			<!-- Main Navigation -->
			<nav class="main_nav_container">
				<div class="main_nav">
					<ul class="main_nav_list">
						<li class="main_nav_item"><a href="index.html">home</a></li>
						<li class="main_nav_item"><a href="#">about us</a></li>
						<li class="main_nav_item"><a href="courses.html">courses</a></li>
						<li class="main_nav_item"><a href="elements.html">elements</a></li>
						<li class="main_nav_item"><a href="news_post.html">news</a></li>
						<li class="main_nav_item"><a href="contact.html">contact</a></li>
            <li class="main_nav_item"><a href="admin1.html">Admin</a></li>
					</ul>
				</div>
			</nav>
		</div>
		<div class="header_side d-flex flex-row justify-content-center align-items-center">
			<img src="images/phone-call.svg" alt="">
			<span>(237) 222 23 09 44 / (237) 222 22 18 16</span>
		</div>

		<!-- Hamburger -->
		<div class="hamburger_container">
			<i class="fas fa-bars trans_200"></i>
		</div>

	</header>
	
	<!-- Menu -->
	<div class="menu_container menu_mm">

		<!-- Menu Close Button -->
		<div class="menu_close_container">
			<div class="menu_close"></div>
		</div>

		<!-- Menu Items -->
		<div class="menu_inner menu_mm">
			<div class="menu menu_mm">
				<ul class="menu_list menu_mm">
					<li class="menu_item menu_mm"><a href="index.html">Home</a></li>
					<li class="menu_item menu_mm"><a href="#">About us</a></li>
					<li class="menu_item menu_mm"><a href="courses.html">Courses</a></li>
					<li class="menu_item menu_mm"><a href="elements.html">Elements</a></li>
					<li class="menu_item menu_mm"><a href="news_post.html">News</a></li>
					<li class="menu_item menu_mm"><a href="contact.html">Contact</a></li>
					<li class="menu_item menu_mm"><a href="memoire.html">Memoires</a></li>
					<li class="menu_item menu_mm"><a href="register.html">Register</a></li>
          <li class="menu_item menu_mm"><a href="admin1.html">Admin</a></li>
          
				</ul>

				<!-- Menu Social -->
				
				<div class="menu_social_container menu_mm">
					<ul class="menu_social menu_mm">
						<li class="menu_social_item menu_mm"><a href="#"><i class="fab fa-pinterest"></i></a></li>
						<li class="menu_social_item menu_mm"><a href="#"><i class="fab fa-linkedin-in"></i></a></li>
						<li class="menu_social_item menu_mm"><a href="#"><i class="fab fa-instagram"></i></a></li>
						<li class="menu_social_item menu_mm"><a href="#"><i class="fab fa-facebook-f"></i></a></li>
						<li class="menu_social_item menu_mm"><a href="#"><i class="fab fa-twitter"></i></a></li>
					</ul>
				</div>

				<div class="menu_copyright menu_mm">Colorlib All rights reserved</div>
			</div>

		</div>

	</div>
	
	<!-- Home -->

	<!-- ==========================================
   PULSE HERO ‚Äì TITRE SUR IMAGE
   ========================================== -->
<!-- PULSE HERO -->
<section class="pulse-hero">
    <div class="pulse-hero-bg" style="background-image:url(images/news_background.jpg)"></div>
    <div class="pulse-hero-overlay">
        <h1 class="pulse-hero-title">PulseNews</h1>
        <p class="pulse-hero-subtitle">L‚Äôactualit√© du campus en un clin d‚Äô≈ìil</p>
       <button class="pulse-hero-cta" id="discoverBtn">
  <span class="btn-txt">D√©couvrir</span>
  <span class="btn-ico"></span>
</button>
</section>
<!-- Bouton m√©moire (admin uniquement) -->
<button class="pulse-fab-admin" id="fabAddNews" onclick="openNewsModal()" style="display:none">
    <i class="fas fa-plus"></i>
</button>

<div class="filter-wrapper">
    <button class="filter-toggle-btn" onclick="toggleFilterPanel()">
        <i class="fas fa-filter"></i> Filtres
        <i class="fas fa-chevron-down arrow"></i>
    </button>

    <div class="filter-panel" id="filterPanel">
        <div class="filter-grid">

            <!-- Cat√©gorie -->
            <div class="filter-group">
                <label>Cat√©gorie</label>
                <select id="filterTopic" onchange="applyFilters()">
                    <option value="">Toutes</option>
                    <option value="general">G√©n√©ral</option>
                    <option value="event">√âv√©nement</option>
                    <option value="award">R√©compense</option>
                    <option value="research">Recherche</option>
                    <option value="alumni">Alumni</option>
                </select>
            </div>

            <!-- Statut -->
            <div class="filter-group">
                <label>Statut</label>
                <select id="filterStatus" onchange="applyFilters()">
                    <option value="">Tous</option>
                    <option value="published">Publi√©es</option>
                    <option value="draft">Brouillons</option>
                </select>
            </div>

            <!-- Filtre temporel -->
            <div class="filter-group">
                <label>P√©riode</label>
                <select id="filterTime" onchange="applyFilters()">
                    <option value="">Toute p√©riode</option>
                    <option value="today">Aujourd‚Äôhui</option>
                    <option value="week">Cette semaine</option>
                    <option value="month">Ce mois-ci</option>
                    <option value="custom">Personnalis√©e</option>
                </select>
            </div>

            <!-- Dates personnalis√©es (affich√©es si "Personnalis√©e" s√©lectionn√©e) -->
            <div class="filter-group custom-dates" id="customDates" style="display:none;">
                <label>Du</label>
                <input type="date" id="dateFrom" onchange="applyFilters()">
                <label>Au</label>
                <input type="date" id="dateTo" onchange="applyFilters()">
            </div>

            <!-- Recherche texte -->
            <div class="filter-group full-width">
                <label>Rechercher</label>
                <input type="text" id="filterSearch" placeholder="Titre ou mot-cl√©..." onkeyup="applyFilters()">
            </div>

            <!-- Bouton r√©initialiser -->
            <div class="filter-group full-width reset-line">
                <button class="btn btn-filter-reset" onclick="resetFilters()">
                    <i class="fas fa-undo"></i> R√©initialiser
                </button>
            </div>

        </div>
    </div>
</div>
	<!-- News -->

	<div class="news">
		<div class="container">
			<div class="row">
				
				<!-- News Post Column -->

				<div class="col-lg-8">
					
					<div class="news_post_container">
						<!-- News Post -->
						<div class="news_posts" id="newsContainer">
    <div class="news_loading">
        <p>Chargement des actualit√©s...</p>
    </div>
</div>
						<!-- Bouton ADMIN uniquement -->
						

						<!-- Modal Ajout / √âdition -->
						<div id="newsModal" class="modal">
							<div class="modal-content">
								<h2 id="modalTitle">Nouvelle news</h2>
								<div id="newsError" style="display:none;"></div>
								<form id="newsForm">
									<input type="hidden" id="newsId">
									
									<label>Titre *</label>
									<input type="text" name="title" required placeholder="Entrez le titre de la news">
									
									<label>Chap√¥ (r√©sum√© court)</label>
									<input type="text" name="headline" placeholder="R√©sum√© en une ligne">
									
									<label>Contenu *</label>
									<textarea name="body" required placeholder="Contenu complet de la news"></textarea>
									
									<label>Image de couverture</label>
									<input type="file" name="cover" accept="image/*">
									<small style="color: #999;">Formats accept√©s: JPG, PNG, GIF</small>
									
									<label>Cat√©gorie</label>
									<select name="topics">
										<option value="general">G√©n√©ral</option>
										<option value="event">√âv√©nement</option>
										<option value="award">R√©compense</option>
										<option value="research">Recherche</option>
										<option value="alumni">Alumni</option>
									</select>
									
									<label style="display: flex; align-items: center; margin-top: 15px;">
										<input type="checkbox" name="is_published" checked>
										<span>Publier imm√©diatement</span>
									</label>
									
									<div style="margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
										<button type="button" class="btn btn-secondary" onclick="closeNewsModal()">Annuler</button>
										<button type="submit" class="btn btn-primary">üíæ Enregistrer</button>
									</div>
								</form>
							</div>
						</div>
					</div>

					
							

					</div>

					
				

						

					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Footer -->

	<footer class="footer">
		<div class="container">
			
			<!-- Newsletter -->


			<!-- Footer Content -->

			<div class="footer_content">
				<div class="row">

					<!-- Footer Column - About -->
					<div class="col-lg-3 footer_col">

						<!-- Logo -->
						<div class="logo_container">
							<div class="logo">
								<img src="images/logo.png" alt="">
										
							</div>
						</div>

						<p class="footer_about_text">In aliquam, augue a gravida rutrum, ante nisl fermentum nulla, vitae tempor nisl ligula vel nunc. Proin quis mi malesuada, finibus tortor fermentum, tempor lacus.</p>

					</div>

					<!-- Footer Column - Menu -->

					<div class="col-lg-3 footer_col">
						<div class="footer_column_title">Menu</div>
						<div class="footer_column_content">
							<ul>
								<li class="footer_list_item"><a href="index.html">Home</a></li>
								<li class="footer_list_item"><a href="#">About Us</a></li>
								<li class="footer_list_item"><a href="courses.html">Courses</a></li>
								<li class="footer_list_item"><a href="news_post.html">News</a></li>
								<li class="footer_list_item"><a href="contact.html">Contact</a></li>
                <li class="footer_list_item"><a href="admin1.html">Admin</a></li>
							</ul>
						</div>
					</div>

					<!-- Footer Column - Usefull Links -->

					<div class="col-lg-3 footer_col">
						<div class="footer_column_title">Usefull Links</div>
						<div class="footer_column_content">
							<ul>
								<li class="footer_list_item"><a href="#">Testimonials</a></li>
								<li class="footer_list_item"><a href="#">FAQ</a></li>
								<li class="footer_list_item"><a href="#">Community</a></li>
								<li class="footer_list_item"><a href="#">Campus Pictures</a></li>
								<li class="footer_list_item"><a href="#">Tuitions</a></li>
							</ul>
						</div>
					</div>

					<!-- Footer Column - Contact -->

					<div class="col-lg-3 footer_col">
						<div class="footer_column_title">Contact</div>
						<div class="footer_column_content">
							<ul>
								<li class="footer_contact_item">
									<div class="footer_contact_icon">
										<img src="images/placeholder.svg" alt="https://www.flaticon.com/authors/lucy-g">
									</div>
									Rue Elig-Effa Yaound√©-Cameroun
								</li>
								<li class="footer_contact_item">
									<div class="footer_contact_icon">
										<img src="images/smartphone.svg" alt="https://www.flaticon.com/authors/lucy-g">
									</div>
									(237) 222 23 09 44 / (237) 222 22 18 16
								</li>
								<li class="footer_contact_item">
									<div class="footer_contact_icon">
										<img src="images/envelope.svg" alt="https://www.flaticon.com/authors/lucy-g">
									</div>contact@enstp.cm
								</li>
							</ul>
						</div>
					</div>

				</div>
			</div>

			<!-- Footer Copyright -->

			<div class="footer_bar d-flex flex-column flex-sm-row align-items-center">
				<div class="footer_copyright">
					<span><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | This template is made with <i class="fa fa-heart" aria-hidden="true"></i> by <a href="https://colorlib.com" target="_blank">Colorlib</a>
<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. --></span>
				</div>
				<div class="footer_social ml-sm-auto">
					<ul class="menu_social">
						<li class="menu_social_item"><a href="#"><i class="fab fa-pinterest"></i></a></li>
						<li class="menu_social_item"><a href="#"><i class="fab fa-linkedin-in"></i></a></li>
						<li class="menu_social_item"><a href="#"><i class="fab fa-instagram"></i></a></li>
						<li class="menu_social_item"><a href="#"><i class="fab fa-facebook-f"></i></a></li>
						<li class="menu_social_item"><a href="#"><i class="fab fa-twitter"></i></a></li>
					</ul>
				</div>
			</div>

		</div>
	</footer>

</div>
<button class="pulse-fab-admin" id="fabAddNews" onclick="openNewsModal()" style="display:none">
    <i class="fas fa-plus"></i>
</button>

<script>

// ==========================================
// üîê GESTION DE L'AUTHENTIFICATION
// ==========================================
async function loadUserRole() {
  if (!TOKEN) {
    console.log('‚ö†Ô∏è Pas de token, mode visiteur');
    return;
  }
  
  try {
    const res = await fetch(`${BASE_URL}/auth/me/`, {
      headers: { Authorization: `Bearer ${TOKEN}` }
    });
    
    if (!res.ok) {
      console.error('‚ùå Erreur chargement utilisateur');
      return;
    }
    
    const user = await res.json();
    console.log('‚úÖ Utilisateur:', user.full_name);
    
    const roleRes = await fetch(`${BASE_URL}/universites/auth/${UNIV_SLUG}/my-role/`, {
      headers: { Authorization: `Bearer ${TOKEN}` }
    });
    
    if (roleRes.ok) {
      const roleData = await roleRes.json();
      USER_ROLE = roleData.role;
      console.log('‚úÖ R√¥le:', USER_ROLE);
      
     
	  	if (['admin', 'superadmin', 'bigboss'].includes(USER_ROLE)) {
    document.getElementById('fabAddNews').style.display = 'flex';
}
    }
  } catch (e) {
    console.error('‚ùå Erreur:', e);
  }
}

// ==========================================
// üì∞ CHARGEMENT DES NEWS
// ==========================================
// ==========================================
  

let allNews = []; // ‚úÖ Stocke toutes les news pour filtrer

async function loadNews() {
    try {
        const headers = {};
        if (TOKEN) headers.Authorization = `Bearer ${TOKEN}`;

        const res = await fetch(`${BASE_URL}/universites/universities/${UNIV_SLUG}/news/`, { headers });
        if (!res.ok) throw new Error('Erreur chargement des news');

        allNews = await res.json();
        applyFilters();

    } catch (e) {
        console.error('‚ùå Erreur chargement news:', e);
        // ‚¨áÔ∏è MESSAGE DESIGN DANS LA CHARTE PULSE
        document.getElementById('newsContainer').innerHTML = `
            <div class="pulse-auth-card">
                <div class="pulse-auth-icon">
                    <i class="fas fa-lock"></i>
                </div>
                <h3 class="pulse-auth-title">Actualit√©s prot√©g√©es</h3>
                <p class="pulse-auth-text">
                    Veuillez vous connecter pour acc√©der aux actualit√©s du campus.
                </p>
                <button class="pulse-auth-btn" onclick="window.location.href='register.html'">
                    Se connecter
                </button>
            </div>
        `;
    }
}
document.getElementById('discoverBtn')
        .addEventListener('click', () =>
           document.getElementById('newsContainer')
                   .scrollIntoView({behavior:'smooth'})
        );
function applyFilters() {
    const topic = document.getElementById('filterTopic').value;
    const status = document.getElementById('filterStatus').value;
    const search = document.getElementById('filterSearch').value.toLowerCase();

    const filtered = allNews.filter(n => {
        const matchesTopic = !topic || n.topics === topic;
        const matchesStatus = !status || (status === 'published' ? n.is_published : !n.is_published);
        const matchesSearch = !search || n.title.toLowerCase().includes(search) || (n.headline && n.headline.toLowerCase().includes(search));
        
        return matchesTopic && matchesStatus && matchesSearch;
    });

    renderNews(filtered);
}

function renderNews(news) {
    const container = document.getElementById('newsContainer');
    const categoryLabels = {
        'general': 'G√©n√©ral',
        'event': '√âv√©nement',
        'award': 'R√©compense',
        'research': 'Recherche',
        'alumni': 'Alumni'
    };

    if (news.length === 0) {
        container.innerHTML = `
            <div class="news_empty">
                <h3>Aucune actualit√© trouv√©e</h3>
                <p>Essayez d‚Äôajuster vos filtres.</p>
            </div>
        `;
        return;
    }

    container.innerHTML = '';
    news.reverse().forEach(n => {
        const publishDate = new Date(n.publish_at || n.created_at);
        const day = String(publishDate.getDate()).padStart(2, '0');
        const month = publishDate.toLocaleDateString('fr-FR', { month: 'short' });
        const isAdmin = ['admin', 'superadmin', 'bigboss'].includes(USER_ROLE);

        container.innerHTML += `
            <div class="news_post" onclick="showNewsDetail(${n.id})" style="cursor: pointer;">
                <div class="news_post_image">
                    <img src="${n.cover_url || 'images/news_1.jpg'}" alt="${n.title}">
                </div>
                <div class="news_post_content">
                    <div class="news_post_top">
                        <div class="news_post_date_container">
                            <div class="news_post_date">
                                <div>${day}</div>
                                <div>${month}</div>
                            </div>
                        </div>
                        <div class="news_post_title_container">
                            <div class="news_post_title">
                                <a href="#">${n.title}</a>
                            </div>
                            <div class="news_post_meta">
                                <span class="news_post_author">
                                    <i class="fas fa-tag"></i> ${categoryLabels[n.topics] || n.topics}
                                </span>
                                ${!n.is_published ? '<span class="badge draft">Brouillon</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="news_post_text">
                        <p>${n.headline || n.body.substring(0, 200) + '...'}</p>
                        <span class="news_post_read_more">Lire la suite</span>
                    </div>
                    ${isAdmin ? `
                    <div class="news_post_actions">
                        <button class="btn btn-warning btn-sm" onclick="editNews(event, ${n.id})">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteNews(${n.id}, '${n.title.replace(/'/g, "\\'")}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
}

function resetFilters() {
    document.getElementById('filterTopic').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterSearch').value = '';
    applyFilters();
}
// ‚úÖ Fermer la modal avec la touche √âchap
document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('newsModal');
        if (modal && modal.style.display === 'block') {
            closeNewsModal();
        }

        const detailModal = document.getElementById('newsDetailModal');
        if (detailModal) {
            detailModal.style.display = 'none';
            document.body.removeChild(detailModal);
        }
    }
});
// Add this function to show news details
// Fixed showNewsDetail function
function showNewsDetail(id) {
    const modal = document.createElement('div');
    modal.className = 'news_detail_modal';
    modal.id = 'newsDetailModal';
    
    // Show loading state
    modal.innerHTML = `
        <div class="news_detail_content">
            <div class="news_loading">
                <p>Chargement...</p>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = 'block';
    
    // Prepare headers with authentication if available
    const headers = {
        'Content-Type': 'application/json',
    };
    
    if (TOKEN) {
        headers.Authorization = `Bearer ${TOKEN}`;
    }
 
    // Fetch news details
    fetch(`${BASE_URL}/universites/universities/${UNIV_SLUG}/news/${id}/`, {
        headers: headers
    })
    .then(res => {
        if (!res.ok) {
            if (res.status === 401) {
                throw new Error('Non autoris√© - Veuillez vous connecter');
            }
            throw new Error(`Erreur ${res.status}: ${res.statusText}`);
        }
        return res.json();
    })
    .then(news => {
        if (!news) {
            throw new Error('Aucune donn√©e re√ßue');
        }
        
        const publishDate = new Date(news.publish_at || news.created_at);
        const categoryLabels = {
            'general': 'G√©n√©ral',
            'event': '√âv√©nement',
            'award': 'R√©compense',
            'research': 'Recherche',
            'alumni': 'Alumni'
        };
        
        // Safely handle body content
        const bodyContent = news.body || '';
        const formattedBody = bodyContent
            .replace(/\n/g, '<br>')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        
        modal.innerHTML = `
            <div class="news_detail_content">
                <div class="news_detail_header">
                    <img src="${news.cover_url || 'images/news_1.jpg'}" alt="${news.title || 'News'}">
                    <div class="news_detail_header_overlay">
                        <h1 class="news_detail_title">${news.title || 'Sans titre'}</h1>
                        <div class="news_detail_meta">
                            <span><i class="fas fa-tag"></i> ${categoryLabels[news.topics] || news.topics || 'Non cat√©goris√©'}</span>
                            <span><i class="fas fa-calendar"></i> ${publishDate.toLocaleDateString('fr-FR')}</span>
                            ${!news.is_published ? '<span class="badge draft"><i class="fas fa-eye-slash"></i> Brouillon</span>' : ''}
                        </div>
                    </div>
                    <span class="news_detail_close">&times;</span>
                </div>
                <div class="news_detail_body">
                    ${news.headline ? `<p style="font-size: 18px; font-style: italic; color: #666; margin-bottom: 20px;">${news.headline}</p>` : ''}
                    <div>${formattedBody || '<p>Aucun contenu disponible</p>'}</div>
                </div>
            </div>
        `;
        
        // Add close functionality
        modal.querySelector('.news_detail_close').onclick = () => {
            modal.style.display = 'none';
            document.body.removeChild(modal);
        };
        
        // Close on outside click
        modal.onclick = (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
                document.body.removeChild(modal);
            }
        };
    })
    .catch(error => {
        console.error('Error loading news details:', error);
        
        let errorMessage = 'Impossible de charger les d√©tails de l\'actualit√©.';
        if (error.message.includes('401')) {
            errorMessage = 'Veuillez vous connecter pour voir le contenu complet.';
        } else if (error.message.includes('404')) {
            errorMessage = 'Cette actualit√© n\'existe pas ou a √©t√© supprim√©e.';
        }
        
        modal.innerHTML = `
            <div class="news_detail_content">
                <div class="error" style="padding: 30px; text-align: center;">
                    <h3>‚ùå Erreur</h3>
                    <p>${errorMessage}</p>
                    <button onclick="document.body.removeChild(document.getElementById('newsDetailModal'))" class="btn btn-primary">Fermer</button>
                </div>
            </div>
        `;
    });
}
// ==========================================
// ‚úèÔ∏è GESTION DU MODAL
// ==========================================
function openNewsModal(id = null) {
  document.getElementById('newsModal').style.display = 'block';
  document.getElementById('newsId').value = id || '';
  document.getElementById('modalTitle').textContent = id ? 'Modifier la news' : 'Nouvelle news';
  document.getElementById('newsError').style.display = 'none';
  
  if (!id) {
    document.getElementById('newsForm').reset();
  }
}

function closeNewsModal() {
  document.getElementById('newsModal').style.display = 'none';
  document.getElementById('newsForm').reset();
  document.getElementById('newsError').style.display = 'none';
}

// Fermer le modal en cliquant en dehors
window.onclick = function(event) {
  const modal = document.getElementById('newsModal');
  if (event.target == modal) {
    closeNewsModal();
  }
}

// ==========================================
// ‚úèÔ∏è √âDITION D'UNE NEWS
// ==========================================
// ‚úÖ Ajoutez un param√®tre `event` √† la fonction
async function editNews(event, id) {
    event.stopPropagation(); // ‚úÖ Emp√™che l‚Äôouverture des d√©tails

    try {
        const res = await fetch(`${BASE_URL}/universites/universities/${UNIV_SLUG}/news/${id}/`, {
            headers: { Authorization: `Bearer ${TOKEN}` }
        });

        if (!res.ok) throw new Error('Erreur chargement de la news');

        const n = await res.json();

        // ‚úÖ Ouvre la modal formulaire
        openNewsModal(id);

        // ‚úÖ Remplit les champs
        document.querySelector('[name="title"]').value = n.title;
        document.querySelector('[name="headline"]').value = n.headline || '';
        document.querySelector('[name="body"]').value = n.body;
        document.querySelector('[name="topics"]').value = n.topics;
        document.querySelector('[name="is_published"]').checked = n.is_published;

    } catch (e) {
        console.error('‚ùå Erreur:', e);
        alert('‚ùå Impossible de charger la news');
    }
}

// ==========================================
// üóëÔ∏è SUPPRESSION D'UNE NEWS
// ==========================================
async function deleteNews(id, title) {
  if (!confirm(`üóëÔ∏è Voulez-vous vraiment supprimer cette news ?\n\n"${title}"\n\nCette action est irr√©versible.`)) {
    return;
  }
  
  try {
    const res = await fetch(`${BASE_URL}/universites/universities/${UNIV_SLUG}/news/${id}/`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${TOKEN}` }
    });
    
    if (res.ok || res.status === 204) {
      alert('‚úÖ News supprim√©e avec succ√®s');
      loadNews();
    } else {
      throw new Error('Erreur lors de la suppression');
    }
  } catch (e) {
    console.error('‚ùå Erreur:', e);
    alert('‚ùå Erreur lors de la suppression');
  }
}

// ==========================================
// üíæ SOUMISSION DU FORMULAIRE
// ==========================================
document.getElementById('newsForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const errorDiv = document.getElementById('newsError');
  errorDiv.style.display = 'none';
  
  try {
    // üìù R√©cup√©ration des donn√©es
    const title = document.querySelector('[name="title"]').value.trim();
    const headline = document.querySelector('[name="headline"]').value.trim();
    const body = document.querySelector('[name="body"]').value.trim();
    const topics = document.querySelector('[name="topics"]').value;
    const isPublished = document.querySelector('[name="is_published"]').checked;
    const coverFile = document.querySelector('[name="cover"]').files[0];
    
    // ‚ö†Ô∏è NE PAS ENVOYER LE SLUG - Le backend le g√©n√®re automatiquement
    const formData = new FormData();
    formData.append('title', title);
    formData.append('headline', headline);
    formData.append('body', body);
    formData.append('topics', topics);
    formData.append('is_published', isPublished);
    formData.append('publish_at', new Date().toISOString());
    
    if (coverFile) {
      formData.append('cover', coverFile);
    }
    
    // üîç Debug
    console.log('üì§ Envoi des donn√©es:');
    for (let [key, value] of formData.entries()) {
      console.log(`  ${key}:`, value instanceof File ? value.name : value);
    }
    
    const id = document.getElementById('newsId').value;
    const url = id 
      ? `${BASE_URL}/universites/universities/${UNIV_SLUG}/news/${id}/`
      : `${BASE_URL}/universites/universities/${UNIV_SLUG}/news/`;
    const method = id ? 'PATCH' : 'POST';
    
    console.log(`üöÄ ${method} ${url}`);
    
    const res = await fetch(url, {
      method,
      headers: { 
        Authorization: `Bearer ${TOKEN}`
        // ‚ö†Ô∏è NE PAS mettre Content-Type avec FormData
      },
      body: formData
    });
    
    if (!res.ok) {
      const errorText = await res.text();
      console.error('‚ùå Erreur serveur:', errorText);
      
      let errorMsg = 'Erreur lors de l\'enregistrement';
      try {
        const errorJson = JSON.parse(errorText);
        errorMsg = Object.entries(errorJson)
          .map(([key, val]) => `${key}: ${Array.isArray(val) ? val.join(', ') : val}`)
          .join('\n');
      } catch {
        errorMsg = errorText;
      }
      
      throw new Error(errorMsg);
    }
    
    const result = await res.json();
    console.log('‚úÖ Succ√®s:', result);
    
    alert(`‚úÖ News ${id ? 'modifi√©e' : 'cr√©√©e'} avec succ√®s !`);
    closeNewsModal();
    loadNews();
    
  } catch (err) {

    console.error('‚ùå Erreur:', err);
    errorDiv.textContent = `‚ùå ${err.message}`;
    errorDiv.style.display = 'block';
  }
});
function toggleFilterPanel() {
    const panel = document.getElementById('filterPanel');
    const btn = document.querySelector('.filter-toggle-btn');
    panel.classList.toggle('open');
    btn.classList.toggle('active');
}

function applyFilters() {
    const topic = document.getElementById('filterTopic').value;
    const status = document.getElementById('filterStatus').value;
    const time = document.getElementById('filterTime').value;
    const search = document.getElementById('filterSearch').value.toLowerCase();

    // ‚úÖ Affiche/masque les dates personnalis√©es
    const customDates = document.getElementById('customDates');
    customDates.style.display = time === 'custom' ? 'flex' : 'none';

    const now = new Date();
    const filtered = allNews.filter(n => {
        const date = new Date(n.publish_at || n.created_at);
        const matchesTopic = !topic || n.topics === topic;
        const matchesStatus = !status || (status === 'published' ? n.is_published : !n.is_published);
        const matchesSearch = !search || n.title.toLowerCase().includes(search) || (n.headline && n.headline.toLowerCase().includes(search));

        let matchesTime = true;
        if (time === 'today') {
            matchesTime = date.toDateString() === now.toDateString();
        } else if (time === 'week') {
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            matchesTime = date >= weekAgo;
        } else if (time === 'month') {
            const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
            matchesTime = date >= monthAgo;
        } else if (time === 'custom') {
            const from = document.getElementById('dateFrom').value ? new Date(document.getElementById('dateFrom').value) : null;
            const to = document.getElementById('dateTo').value ? new Date(document.getElementById('dateTo').value) : null;
            if (from) matchesTime = matchesTime && date >= from;
            if (to) matchesTime = matchesTime && date <= to;
        }

        return matchesTopic && matchesStatus && matchesSearch && matchesTime;
    });

    renderNews(filtered);
}

function resetFilters() {
    document.getElementById('filterTopic').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterTime').value = '';
    document.getElementById('filterSearch').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    document.getElementById('customDates').style.display = 'none';
    applyFilters();
}
// ==========================================
// üöÄ INITIALISATION
// ==========================================
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üöÄ Initialisation de la page news');
  await loadUserRole();
  await loadNews();
});
</script>

<script src="js/jquery-3.2.1.min.js"></script>
<script src="styles/bootstrap4/popper.js"></script>
<script src="styles/bootstrap4/bootstrap.min.js"></script>
<script src="plugins/greensock/TweenMax.min.js"></script>
<script src="plugins/greensock/TimelineMax.min.js"></script>
<script src="plugins/scrollmagic/ScrollMagic.min.js"></script>
<script src="plugins/greensock/animation.gsap.min.js"></script>
<script src="plugins/greensock/ScrollToPlugin.min.js"></script>
<script src="plugins/scrollTo/jquery.scrollTo.min.js"></script>
<script src="plugins/easing/easing.js"></script>
<script src="js/news_post_custom.js"></script>

</body>
</html>