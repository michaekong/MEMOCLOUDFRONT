<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemoCloud Admin - Utilisateurs</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Configuration Tailwind -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                yellow: '#ffb606',
                dark: '#3a3a3a',
                light: '#f5f7fa',
              }
            },
            animation: {
              'fade-in': 'fadeIn 0.3s ease-out',
              'slide-up': 'slideUp 0.3s ease-out',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              slideUp: {
                '0%': { transform: 'translateY(20px)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              }
            }
          }
        }
      }
    </script>

    <style>
      body {
        background-color: #f5f7fa;
        color: #3a3a3a;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      
      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

      .step-dot { transition: all 0.3s; }
      .step-dot.active { @apply bg-brand-yellow ring-4 ring-brand-yellow/20; }
      .step-dot.completed { @apply bg-green-500; }
      
      /* Role Badges */
      .badge-admin { @apply bg-orange-100 text-orange-800 border border-orange-200; }
      .badge-superadmin { @apply bg-red-100 text-red-800 border border-red-200; }
      .badge-professeur { @apply bg-blue-100 text-blue-800 border border-blue-200; }
      .badge-standard { @apply bg-gray-100 text-gray-800 border border-gray-200; }
      .badge-bigboss { @apply bg-purple-100 text-purple-800 border border-purple-200; }
    </style>
</head>
<body class="min-h-screen flex flex-col text-sm md:text-base">

    <!-- APP CONTAINER -->
    <div id="app" class="flex-1 flex flex-col">
        <!-- Loader Initial -->
        <div class="fixed inset-0 flex items-center justify-center bg-brand-light z-[100]" id="initialLoader">
            <div class="flex flex-col items-center gap-4">
                <i class="fas fa-circle-notch fa-spin text-5xl text-brand-yellow"></i>
                <p class="text-brand-dark font-bold animate-pulse">Chargement des utilisateurs...</p>
            </div>
        </div>
    </div>

    <!-- TEMPLATES -->
    
    <!-- Header Template -->
    <template id="header-template">
        <header class="bg-brand-dark text-white shadow-lg sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-brand-yellow flex items-center justify-center text-brand-dark font-bold text-xl shadow-lg">
                        <i class="fas fa-users-cog"></i>
                    </div>
                    <h1 class="text-xl font-bold tracking-tight">Admin<span class="text-brand-yellow">Utilisateurs</span></h1>
                </div>
                <div class="flex items-center gap-4 bg-white/10 px-4 py-2 rounded-full border border-white/5">
                    <div class="flex flex-col items-end leading-tight">
                        <span class="text-sm font-bold text-brand-yellow" id="header-username">Chargement...</span>
                        <span class="text-[10px] text-gray-300 uppercase tracking-wider" id="header-role">...</span>
                    </div>
                    <button onclick="app.logout()" class="text-gray-400 hover:text-white transition-colors p-2 hover:bg-white/10 rounded-full" title="Déconnexion">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>
    </template>

    <!-- Main Content Template -->
    <template id="main-template">
        <main class="flex-1 max-w-7xl w-full mx-auto px-4 py-8 animate-fade-in">
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" id="statsContainer">
                <!-- Injected via JS -->
            </div>

            <!-- Barre d'outils -->
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="relative w-full md:w-96 group">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-brand-yellow transition-colors"></i>
                    <input type="text" id="searchInput" placeholder="Rechercher (nom, email)..." 
                           class="w-full pl-10 pr-4 py-3 bg-gray-50 border-2 border-transparent rounded-lg focus:bg-white focus:border-brand-yellow/50 focus:ring-0 transition-all outline-none"
                           onkeyup="app.handleSearch(this.value)">
                </div>
                <button onclick="app.openAddModal()" 
                        class="w-full md:w-auto px-6 py-3 bg-brand-yellow text-brand-dark font-bold rounded-lg shadow-md hover:bg-yellow-400 hover:shadow-lg transition-all flex items-center justify-center gap-2 transform active:scale-95">
                    <i class="fas fa-user-plus"></i> <span>Ajouter Utilisateur</span>
                </button>
            </div>

            <!-- État vide -->
            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-gray-400">
                <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-users-slash text-3xl opacity-30 text-brand-dark"></i>
                </div>
                <p class="text-lg font-medium">Aucun utilisateur trouvé</p>
            </div>

            <!-- Tableau Desktop -->
            <div id="desktopTable" class="hidden md:block bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs font-bold tracking-wider border-b border-gray-100">
                        <tr>
                            <th class="px-6 py-4">Utilisateur</th>
                            <th class="px-6 py-4">Email</th>
                            <th class="px-6 py-4">Rôle</th>
                            <th class="px-6 py-4">Date Inscription</th>
                            <th class="px-6 py-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-100 text-brand-dark"></tbody>
                </table>
            </div>

            <!-- Cartes Mobile -->
            <div id="mobileCards" class="md:hidden grid grid-cols-1 gap-4"></div>
        </main>
    </template>

    <!-- Modal Formulaire Ajout (Wizard) -->
    <div id="formModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-brand-dark/80 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh] animate-slide-up">
            
            <!-- Header Modal -->
            <div class="bg-brand-dark text-white p-6 flex justify-between items-center shrink-0">
                <div>
                    <h2 class="text-xl font-bold">Nouvel Utilisateur</h2>
                    <!-- Indicateur d'étapes -->
                    <div class="flex gap-2 mt-3">
                        <div class="step-dot w-8 h-1.5 rounded-full bg-gray-600" id="step-dot-1"></div>
                        <div class="step-dot w-8 h-1.5 rounded-full bg-gray-600" id="step-dot-2"></div>
                        <div class="step-dot w-8 h-1.5 rounded-full bg-gray-600" id="step-dot-3"></div>
                    </div>
                </div>
                <button onclick="app.closeModal('formModal')" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Body Modal -->
            <div class="p-6 overflow-y-auto flex-1 relative">
                <div id="modalError" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>
                
                <form id="addUserForm" onsubmit="return false;">
                    
                    <!-- ÉTAPE 1: Identité -->
                    <div id="step-1" class="space-y-5">
                        <h3 class="font-bold text-gray-400 uppercase text-xs">Informations Personnelles</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="block text-sm font-bold text-brand-dark mb-1">Prénom <span class="text-red-500">*</span></label>
                                <input type="text" name="prenom" required class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-brand-yellow focus:ring-0 outline-none transition-colors bg-gray-50">
                            </div>
                            <div class="form-group">
                                <label class="block text-sm font-bold text-brand-dark mb-1">Nom <span class="text-red-500">*</span></label>
                                <input type="text" name="nom" required class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-brand-yellow focus:ring-0 outline-none transition-colors bg-gray-50">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-bold text-brand-dark mb-1">Sexe <span class="text-red-500">*</span></label>
                            <div class="grid grid-cols-2 gap-4">
                                <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="sexe" value="M" checked class="text-brand-yellow focus:ring-brand-yellow">
                                    <span>Masculin</span>
                                </label>
                                <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="sexe" value="F" class="text-brand-yellow focus:ring-brand-yellow">
                                    <span>Féminin</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- ÉTAPE 2: Connexion -->
                    <div id="step-2" class="hidden space-y-5">
                        <h3 class="font-bold text-gray-400 uppercase text-xs">Identifiants de connexion</h3>
                        <div class="form-group">
                            <label class="block text-sm font-bold text-brand-dark mb-1">Email <span class="text-red-500">*</span></label>
                            <input type="email" name="email" required class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-brand-yellow focus:ring-0 outline-none transition-colors bg-gray-50">
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-bold text-brand-dark mb-1">Mot de passe <span class="text-red-500">*</span></label>
                            <input type="password" name="password1" required class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-brand-yellow focus:ring-0 outline-none transition-colors bg-gray-50">
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-bold text-brand-dark mb-1">Confirmer Mot de passe <span class="text-red-500">*</span></label>
                            <input type="password" name="password2" required class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-brand-yellow focus:ring-0 outline-none transition-colors bg-gray-50">
                        </div>
                    </div>

                    <!-- ÉTAPE 3: Profil & Rôle -->
                    <div id="step-3" class="hidden space-y-5">
                        <h3 class="font-bold text-gray-400 uppercase text-xs">Profil & Permissions</h3>
                        
                        <div class="form-group">
                            <label class="block text-sm font-bold text-brand-dark mb-1">Rôle <span class="text-red-500">*</span></label>
                            <select name="role" id="roleSelect" required class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-brand-yellow focus:ring-0 outline-none bg-white">
                                <!-- Options injectées par JS selon les droits -->
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="block text-sm font-bold text-brand-dark mb-1">LinkedIn (Optionnel)</label>
                            <div class="relative">
                                <i class="fab fa-linkedin absolute left-3 top-3.5 text-blue-600"></i>
                                <input type="url" name="realisation_linkedin" class="w-full pl-10 pr-3 py-3 border-2 border-gray-200 rounded-lg focus:border-brand-yellow focus:ring-0 outline-none transition-colors bg-gray-50" placeholder="https://linkedin.com/in/...">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="block text-sm font-bold text-brand-dark mb-1">Photo de profil</label>
                            <div class="p-6 border-2 border-dashed border-gray-300 rounded-xl hover:border-brand-yellow hover:bg-brand-yellow/5 transition-all text-center relative">
                                <input type="file" name="photo_profil" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="app.handleFileLabel(this)">
                                <i class="fas fa-camera text-2xl text-gray-300 mb-2"></i>
                                <p class="text-xs text-gray-500" id="photoLabel">Cliquez pour ajouter une photo</p>
                            </div>
                        </div>
                    </div>

                </form>
            </div>

            <!-- Footer Modal -->
            <div class="p-4 bg-gray-50 border-t border-gray-100 flex justify-between shrink-0">
                <button id="btnPrev" onclick="app.prevStep()" class="px-5 py-2.5 rounded-lg text-gray-600 font-bold hover:bg-gray-200 disabled:opacity-50 transition-colors" disabled>
                    Précédent
                </button>
                <button id="btnNext" onclick="app.nextStep()" class="px-6 py-2.5 rounded-lg bg-brand-yellow text-brand-dark font-bold hover:bg-yellow-400 shadow-md transition-colors flex items-center gap-2">
                    Suivant <i class="fas fa-arrow-right text-sm"></i>
                </button>
                <button id="btnSave" onclick="app.submitAddUser()" class="hidden px-6 py-2.5 rounded-lg bg-brand-dark text-white font-bold hover:bg-black shadow-lg transition-colors flex items-center gap-2">
                    <i class="fas fa-save"></i> Créer Utilisateur
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Modification Rôle -->
    <div id="editRoleModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-brand-dark/90 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-slide-up">
            <h3 class="text-xl font-bold text-brand-dark mb-4">Modifier le rôle</h3>
            <div id="editRoleError" class="hidden mb-4 p-2 bg-red-100 text-red-700 text-sm rounded"></div>
            
            <form id="editRoleForm" onsubmit="return false;" class="space-y-4">
                <input type="hidden" id="editUserId">
                <div>
                    <label class="block text-sm font-bold text-gray-500 mb-1">Utilisateur</label>
                    <input type="text" id="editUserName" disabled class="w-full p-2 bg-gray-100 border border-gray-200 rounded text-gray-600">
                </div>
                <div>
                    <label class="block text-sm font-bold text-brand-dark mb-1">Nouveau Rôle</label>
                    <select id="editUserRole" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-brand-yellow outline-none bg-white font-bold">
                        <!-- Options injectées par JS -->
                    </select>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-100 mt-4">
                    <button onclick="app.closeModal('editRoleModal')" class="px-4 py-2 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">Annuler</button>
                    <button onclick="app.submitEditRole()" class="px-4 py-2 bg-brand-yellow text-brand-dark font-bold rounded-lg shadow hover:bg-yellow-400">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const CONFIG = {
            API_URL: 'https://memocloudbackend.onrender.com/api',
            UNIV_SLUG: 'ecole-des-travaux',
            ALLOWED_ROLES: ['admin', 'superadmin', 'bigboss']
        };

        const ROLE_HIERARCHY = {
            'standard': 0,
            'professeur': 1,
            'admin': 2,
            'superadmin': 3,
            'bigboss': 4
        };

        const ROLE_LABELS = {
            'standard': 'Étudiant',
            'professeur': 'Professeur',
            'admin': 'Administrateur',
            'superadmin': 'Super Admin',
            'bigboss': 'BIG BOSS'
        };

        const state = {
            currentUser: null,
            currentUserRole: null,
            users: [],
            filteredUsers: [],
            currentStep: 1
        };

        const app = {
            async init() {
                const token = localStorage.getItem('authToken');
                if (!token) return this.redirectLogin();

                try {
                    await this.loadCurrentUser(token);
                    if (!this.checkAccess()) return;
                    await this.loadUsers(token);
                    this.renderApp();
                } catch (e) {
                    console.error(e);
                    alert("Erreur de chargement: " + e.message);
                }
            },

            redirectLogin() {
                window.location.href = '/login.html';
            },

            checkAccess() {
                const myLevel = ROLE_HIERARCHY[state.currentUserRole] || 0;
                if (myLevel < 2) { // Less than admin
                    document.body.innerHTML = `
                        <div class="h-screen flex flex-col items-center justify-center bg-brand-light text-center p-4">
                            <i class="fas fa-lock text-red-500 text-6xl mb-4"></i>
                            <h1 class="text-2xl font-bold text-brand-dark">Accès Restreint</h1>
                            <p class="text-gray-600 mt-2">Vous n'avez pas les permissions pour gérer les utilisateurs.</p>
                            <button onclick="window.history.back()" class="mt-4 px-6 py-2 bg-brand-dark text-white rounded-lg">Retour</button>
                        </div>
                    `;
                    return false;
                }
                return true;
            },

            async loadCurrentUser(token) {
                // User info
                const resMe = await fetch(`${CONFIG.API_URL}/auth/me/`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!resMe.ok) throw new Error('Auth failed');
                state.currentUser = await resMe.json();

                // Role
                const resRole = await fetch(`${CONFIG.API_URL}/universites/auth/${CONFIG.UNIV_SLUG}/my-role/`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!resRole.ok) throw new Error('Role fetch failed');
                const data = await resRole.json();
                state.currentUserRole = data.role;
            },

            async loadUsers(token) {
                const res = await fetch(`${CONFIG.API_URL}/auth/${CONFIG.UNIV_SLUG}/users/?ordering=-id`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(!res.ok) throw new Error("Impossible de charger la liste");
                const users = await res.json();
                
                // Fetch roles for each user (Parallel)
                // Note: Optimization would be to have role in list endpoint, but following existing logic:
                const usersWithRoles = await Promise.all(users.map(async u => {
                    try {
                        const rRes = await fetch(`${CONFIG.API_URL}/universites/auth/universities/${CONFIG.UNIV_SLUG}/user-role/${u.id}/`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if(rRes.ok) {
                            const rData = await rRes.json();
                            return { ...u, role: rData.role };
                        }
                    } catch(e) {}
                    return { ...u, role: 'standard' };
                }));

                state.users = usersWithRoles;
                state.filteredUsers = usersWithRoles;
            },

            renderApp() {
                document.getElementById('initialLoader').remove();

                // Header
                const hTmpl = document.getElementById('header-template').content.cloneNode(true);
                hTmpl.querySelector('#header-username').textContent = state.currentUser.full_name;
                hTmpl.querySelector('#header-role').textContent = ROLE_LABELS[state.currentUserRole] || state.currentUserRole;
                document.getElementById('app').appendChild(hTmpl);

                // Main
                const mTmpl = document.getElementById('main-template').content.cloneNode(true);
                document.getElementById('app').appendChild(mTmpl);

                this.renderStats();
                this.renderList();
            },

            renderStats() {
                const stats = {
                    total: state.users.length,
                    admin: state.users.filter(u => ['admin','superadmin','bigboss'].includes(u.role)).length,
                    prof: state.users.filter(u => u.role === 'professeur').length,
                    student: state.users.filter(u => u.role === 'standard').length
                };

                const cards = [
                    { label: 'Total', val: stats.total, color: 'bg-brand-dark', icon: 'fa-users' },
                    { label: 'Administrateurs', val: stats.admin, color: 'bg-orange-500', icon: 'fa-user-shield' },
                    { label: 'Professeurs', val: stats.prof, color: 'bg-blue-500', icon: 'fa-chalkboard-teacher' },
                    { label: 'Étudiants', val: stats.student, color: 'bg-green-500', icon: 'fa-user-graduate' },
                ];

                const container = document.getElementById('statsContainer');
                container.innerHTML = cards.map(c => `
                    <div class="${c.color} text-white p-4 rounded-xl shadow-lg flex items-center justify-between">
                        <div>
                            <p class="text-xs uppercase opacity-80 font-bold">${c.label}</p>
                            <p class="text-3xl font-bold mt-1">${c.val}</p>
                        </div>
                        <i class="fas ${c.icon} text-3xl opacity-30"></i>
                    </div>
                `).join('');
            },

            renderList() {
                const tbody = document.getElementById('tableBody');
                const mob = document.getElementById('mobileCards');
                const empty = document.getElementById('emptyState');
                const desk = document.getElementById('desktopTable');

                tbody.innerHTML = '';
                mob.innerHTML = '';

                if (state.filteredUsers.length === 0) {
                    empty.classList.remove('hidden');
                    desk.classList.add('hidden');
                    return;
                }
                empty.classList.add('hidden');
                desk.classList.remove('hidden');

                const myLevel = ROLE_HIERARCHY[state.currentUserRole] || 0;

                state.filteredUsers.forEach(u => {
                    const userLevel = ROLE_HIERARCHY[u.role] || 0;
                    const canEdit = myLevel > userLevel;
                    const isMe = u.id === state.currentUser.id;

                    const roleBadgeClass = `badge-${u.role}`;
                    const avatar = u.photo_profil || `https://ui-avatars.com/api/?name=${encodeURIComponent(u.full_name)}&background=random`;
                    
                    const joined = new Date(u.date_joined).toLocaleDateString('fr-FR');

                    // Actions
                    let actions = `<span class="text-gray-400 text-xs italic">Aucune permission</span>`;
                    if (canEdit && !isMe) {
                        actions = `
                            <div class="flex justify-end gap-2">
                                <button onclick="app.openEditRoleModal(${u.id}, '${u.full_name.replace(/'/g,"\\'")}', '${u.role}')" class="w-8 h-8 rounded bg-brand-yellow/10 text-brand-dark hover:bg-brand-yellow hover:text-white flex items-center justify-center transition-colors" title="Modifier Rôle">
                                    <i class="fas fa-user-tag"></i>
                                </button>
                                <button onclick="app.deleteUser(${u.id}, '${u.full_name.replace(/'/g,"\\'")}')" class="w-8 h-8 rounded bg-red-50 text-red-600 hover:bg-red-100 flex items-center justify-center transition-colors" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    } else if (isMe) {
                        actions = `<span class="text-brand-yellow font-bold text-xs">Vous-même</span>`;
                    }

                    // Desktop Row
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-yellow-50/30 transition-colors border-b border-gray-50 last:border-0';
                    tr.innerHTML = `
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <img src="${avatar}" class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-sm">
                                <div>
                                    <div class="font-bold text-brand-dark">${u.full_name}</div>
                                    <div class="text-xs text-gray-500">${u.sexe === 'M' ? 'Homme' : 'Femme'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-gray-600">${u.email}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold capitalize ${roleBadgeClass}">${ROLE_LABELS[u.role] || u.role}</span></td>
                        <td class="px-6 py-4 font-mono text-xs text-gray-500">${joined}</td>
                        <td class="px-6 py-4 text-right">${actions}</td>
                    `;
                    tbody.appendChild(tr);

                    // Mobile Card
                    const card = document.createElement('div');
                    card.className = 'bg-white p-5 rounded-xl shadow-sm border border-gray-100';
                    card.innerHTML = `
                        <div class="flex items-center gap-3 mb-3">
                            <img src="${avatar}" class="w-12 h-12 rounded-full object-cover shadow-sm">
                            <div>
                                <h3 class="font-bold text-brand-dark">${u.full_name}</h3>
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${roleBadgeClass}">${ROLE_LABELS[u.role] || u.role}</span>
                            </div>
                        </div>
                        <div class="space-y-1 text-sm text-gray-600 mb-4">
                            <p><i class="fas fa-envelope w-5 text-center"></i> ${u.email}</p>
                            <p><i class="fas fa-calendar w-5 text-center"></i> Inscrit le ${joined}</p>
                        </div>
                        <div class="border-t border-gray-100 pt-3 flex justify-end">
                            ${actions.replace('justify-end', '')} 
                        </div>
                    `;
                    mob.appendChild(card);
                });
            },

            handleSearch(query) {
                const q = query.toLowerCase();
                state.filteredUsers = state.users.filter(u => 
                    u.full_name.toLowerCase().includes(q) || 
                    u.email.toLowerCase().includes(q)
                );
                this.renderList();
            },

            /* --- WIZARD FORM --- */

            openAddModal() {
                state.currentStep = 1;
                document.getElementById('addUserForm').reset();
                document.getElementById('modalError').classList.add('hidden');
                document.getElementById('photoLabel').textContent = "Cliquez pour ajouter une photo";
                
                // Populate roles based on hierarchy
                const select = document.getElementById('roleSelect');
                const myLevel = ROLE_HIERARCHY[state.currentUserRole] || 0;
                select.innerHTML = '';
                Object.entries(ROLE_HIERARCHY).forEach(([role, level]) => {
                    if (level < myLevel) {
                        select.innerHTML += `<option value="${role}">${ROLE_LABELS[role] || role}</option>`;
                    }
                });

                this.updateStepUI();
                document.getElementById('formModal').classList.remove('hidden');
                document.getElementById('formModal').classList.add('flex');
            },

            closeModal(id) {
                document.getElementById(id).classList.add('hidden');
                document.getElementById(id).classList.remove('flex');
            },

            updateStepUI() {
                [1, 2, 3].forEach(s => {
                    document.getElementById(`step-${s}`).classList.add('hidden');
                    const dot = document.getElementById(`step-dot-${s}`);
                    dot.className = 'step-dot w-8 h-1.5 rounded-full bg-gray-600';
                });

                document.getElementById(`step-${state.currentStep}`).classList.remove('hidden');

                for(let i=1; i<=3; i++) {
                    const dot = document.getElementById(`step-dot-${i}`);
                    if(i < state.currentStep) dot.classList.add('completed');
                    else if(i === state.currentStep) dot.classList.add('active');
                }

                const prev = document.getElementById('btnPrev');
                const next = document.getElementById('btnNext');
                const save = document.getElementById('btnSave');

                prev.disabled = state.currentStep === 1;

                if (state.currentStep === 3) {
                    next.classList.add('hidden');
                    save.classList.remove('hidden');
                } else {
                    next.classList.remove('hidden');
                    save.classList.add('hidden');
                }
            },

            nextStep() {
                const f = document.getElementById('addUserForm');
                // Validation simple
                if (state.currentStep === 1) {
                    if (!f.prenom.value || !f.nom.value) return alert("Veuillez remplir le nom et prénom.");
                }
                if (state.currentStep === 2) {
                    if (!f.email.value || !f.password1.value) return alert("Email et mot de passe requis.");
                    if (f.password1.value !== f.password2.value) return alert("Les mots de passe ne correspondent pas.");
                }
                if (state.currentStep < 3) {
                    state.currentStep++;
                    this.updateStepUI();
                }
            },

            prevStep() {
                if (state.currentStep > 1) {
                    state.currentStep--;
                    this.updateStepUI();
                }
            },

            handleFileLabel(input) {
                if(input.files[0]) document.getElementById('photoLabel').textContent = input.files[0].name;
            },

            async submitAddUser() {
                const btn = document.getElementById('btnSave');
                const oldTxt = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Création...';
                document.getElementById('modalError').classList.add('hidden');

                try {
                    const fd = new FormData(document.getElementById('addUserForm'));
                    fd.append('universite_slug', CONFIG.UNIV_SLUG);
                    fd.append('type', 'standard'); // Base Django type

                    // Note: 'role' is already in formData from the select

                    const token = localStorage.getItem('authToken');
                    const res = await fetch(`${CONFIG.API_URL}/auth/register-via-universite/`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: fd
                    });

                    const data = await res.json();
                    if(!res.ok) throw new Error(JSON.stringify(data));

                    alert("Utilisateur créé avec succès !");
                    this.closeModal('formModal');
                    await this.loadUsers(token);
                    this.renderApp();

                } catch(e) {
                    let msg = e.message;
                    try {
                        // Parse Django error object to string
                        const obj = JSON.parse(msg);
                        msg = Object.entries(obj).map(([k,v]) => `${k}: ${v}`).join('<br>');
                    } catch(err){}
                    
                    const box = document.getElementById('modalError');
                    box.innerHTML = msg;
                    box.classList.remove('hidden');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = oldTxt;
                }
            },

            /* --- EDIT ROLE & DELETE --- */

            openEditRoleModal(id, name, currentRole) {
                document.getElementById('editUserId').value = id;
                document.getElementById('editUserName').value = name;
                document.getElementById('editRoleError').classList.add('hidden');
                
                const select = document.getElementById('editUserRole');
                const myLevel = ROLE_HIERARCHY[state.currentUserRole] || 0;
                select.innerHTML = '';
                
                Object.entries(ROLE_HIERARCHY).forEach(([role, level]) => {
                    if (level < myLevel) {
                        const sel = role === currentRole ? 'selected' : '';
                        select.innerHTML += `<option value="${role}" ${sel}>${ROLE_LABELS[role] || role}</option>`;
                    }
                });

                document.getElementById('editRoleModal').classList.remove('hidden');
                document.getElementById('editRoleModal').classList.add('flex');
            },

            async submitEditRole() {
                const id = document.getElementById('editUserId').value;
                const newRole = document.getElementById('editUserRole').value;
                const token = localStorage.getItem('authToken');

                try {
                    const res = await fetch(`${CONFIG.API_URL}/auth/${CONFIG.UNIV_SLUG}/users/${id}/role/`, {
                        method: 'PATCH',
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ role: newRole })
                    });
                    if(!res.ok) throw new Error("Erreur modification");

                    alert("Rôle mis à jour");
                    this.closeModal('editRoleModal');
                    await this.loadUsers(token);
                    this.renderList();
                    this.renderStats();

                } catch(e) {
                    alert(e.message);
                }
            },

            async deleteUser(id, name) {
                if(!confirm(`SUPPRIMER DÉFINITIVEMENT ${name} ?`)) return;

                const token = localStorage.getItem('authToken');
                try {
                    const res = await fetch(`${CONFIG.API_URL}/auth/${CONFIG.UNIV_SLUG}/users/${id}/`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if(!res.ok) throw new Error("Erreur suppression");

                    state.users = state.users.filter(u => u.id !== id);
                    state.filteredUsers = state.filteredUsers.filter(u => u.id !== id);
                    this.renderList();
                    this.renderStats();

                } catch(e) {
                    alert(e.message);
                }
            },

            logout() {
                localStorage.clear();
                window.location.href = '/login.html';
            }
        };

        // Init
        window.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>