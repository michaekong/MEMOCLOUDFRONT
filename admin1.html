<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - MemoCloud</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Configuration Tailwind -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: { yellow: '#ffb606', dark: '#3a3a3a', light: '#f5f7fa' }
            },
            animation: { 'fade-in': 'fadeIn 0.3s ease-out', 'slide-up': 'slideUp 0.3s ease-out' },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
            }
          }
        }
      }
    </script>

    <!-- Styles CSS -->
    <style>
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
      
      /* Gestion Sidebar Responsive */
      @media (max-width: 768px) {
        .sidebar-desktop { display: none; }
        .sidebar-mobile { transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        .sidebar-mobile.active { transform: translateX(0); }
      }
      @media (min-width: 769px) {
        .sidebar-mobile { display: none; }
        .sidebar-collapsed { width: 80px; }
        .sidebar-collapsed .sidebar-text { display: none; }
        .sidebar-collapsed .group:hover .sidebar-text { 
            display: block; position: absolute; left: 100%; top: 0; 
            background: #3a3a3a; padding: 0.5rem 1rem; border-radius: 0.5rem; 
            white-space: nowrap; z-index: 50; 
        }
      }

      /* Iframe Container */
      .iframe-container { width: 100%; height: 100%; border: none; background: white; border-radius: 0.75rem; }
      
      /* Cards & UI */
      .domaine-card { position: relative; transition: all 0.2s; }
      .domaine-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
      .toast { animation: slideUp 0.3s ease-out; }
      
      /* Chart Containers */
      .chart-container { position: relative; width: 100%; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.2",
    "react-dom/": "https://esm.sh/react-dom@^19.2.2/",
    "react/": "https://esm.sh/react@^19.2.2/"
  }
}
</script>
</head>
<body class="bg-brand-light text-brand-dark overflow-hidden flex h-screen">

    <!-- Mobile Overlay -->
    <div id="mobileOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar-desktop w-72 bg-brand-dark text-white flex flex-col shadow-2xl z-50 h-full fixed md:relative transition-all duration-300">
        <!-- Logo -->
        <div class="h-20 flex items-center px-6 border-b border-white/10 gap-3">
            <div class="w-10 h-10 rounded-lg bg-brand-yellow flex items-center justify-center text-brand-dark font-bold text-xl shadow-lg shrink-0"><i class="fas fa-graduation-cap"></i></div>
            <h1 class="text-xl font-bold tracking-tight whitespace-nowrap overflow-hidden sidebar-text">Memo<span class="text-brand-yellow">Cloud</span></h1>
            <a href="index.html" target="_blank" class="ml-4 text-sm bg-white/10 hover:bg-white/20 px-3 py-1 rounded-md text-white">Voir le site</a>
            <button onclick="toggleSidebar()" class="ml-auto md:hidden text-gray-400"><i class="fas fa-times"></i></button>
        </div>

        <!-- Menu -->
        <nav class="flex-1 py-6 px-3 space-y-1 overflow-y-auto">
            <button onclick="app.nav('dashboard')" class="menu-item w-full flex items-center gap-4 px-4 py-3 rounded-lg text-left transition-colors group text-white bg-white/10 border-l-4 border-brand-yellow" data-target="dashboard">
                <i class="fas fa-chart-pie w-6 text-center text-brand-yellow"></i><span class="font-medium sidebar-text">Tableau de bord</span>
            </button>
            <div class="pt-4 pb-2 px-4 text-xs font-bold text-gray-500 uppercase sidebar-text">Gestion</div>
            <button onclick="app.nav('users')" class="menu-item w-full flex items-center gap-4 px-4 py-3 rounded-lg text-left hover:bg-white/10 transition-colors group text-gray-300" data-target="users">
                <i class="fas fa-users w-6 text-center text-gray-400 group-hover:text-brand-yellow"></i><span class="font-medium sidebar-text">Utilisateurs</span>
            </button>
            <button onclick="app.nav('memoires')" class="menu-item w-full flex items-center gap-4 px-4 py-3 rounded-lg text-left hover:bg-white/10 transition-colors group text-gray-300" data-target="memoires">
                <i class="fas fa-book w-6 text-center text-gray-400 group-hover:text-brand-yellow"></i><span class="font-medium sidebar-text">M√©moires</span>
            </button>
            <button onclick="app.nav('domaines')" class="menu-item w-full flex items-center gap-4 px-4 py-3 rounded-lg text-left hover:bg-white/10 transition-colors group text-gray-300" data-target="domaines">
                <i class="fas fa-tags w-6 text-center text-gray-400 group-hover:text-brand-yellow"></i><span class="font-medium sidebar-text">Domaines</span>
            </button>
             <button onclick="app.nav('interactions')" class="menu-item w-full flex items-center gap-4 px-4 py-3 rounded-lg text-left hover:bg-white/10 transition-colors group text-gray-300" data-target="interactions">
                <i class="fas fa-tags w-6 text-center text-gray-400 group-hover:text-brand-yellow"></i><span class="font-medium sidebar-text">Interactions</span>
            </button>
            <button onclick="app.nav('old-students')" class="menu-item w-full flex items-center gap-4 px-4 py-3 rounded-lg text-left hover:bg-white/10 transition-colors group text-gray-300" data-target="old-students">
    <i class="fas fa-user-graduate w-6 text-center text-gray-400 group-hover:text-brand-yellow"></i>
    <span class="font-medium sidebar-text"> Temoignages Anciens √âtudiants</span>
</button>
            <div class="pt-4 pb-2 px-4 text-xs font-bold text-gray-500 uppercase sidebar-text">Communication</div>
            <button onclick="app.nav('news')" class="menu-item w-full flex items-center gap-4 px-4 py-3 rounded-lg text-left hover:bg-white/10 transition-colors group text-gray-300" data-target="news">
                <i class="fas fa-newspaper w-6 text-center text-gray-400 group-hover:text-brand-yellow"></i><span class="font-medium sidebar-text">Actualit√©s</span>
            </button>
        </nav>

        <!-- User Footer -->
        <div class="p-4 border-t border-white/10">
            <div class="flex items-center gap-3">
                <div id="userAvatar" class="w-10 h-10 rounded-full bg-brand-yellow text-brand-dark flex items-center justify-center font-bold text-lg shrink-0">U</div>
                <div class="flex-1 overflow-hidden sidebar-text">
                    <p id="userName" class="font-bold text-sm truncate">Chargement...</p>
                    <p id="userRole" class="text-xs text-gray-400 truncate">...</p>
                </div>
                <button onclick="app.logout()" class="text-gray-400 hover:text-white" title="D√©connexion"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
        
        <!-- Desktop Collapse Button -->
        <button onclick="toggleDesktopSidebar()" class="hidden md:flex absolute -right-3 top-24 w-6 h-6 bg-brand-yellow text-brand-dark rounded-full items-center justify-center shadow-md hover:scale-110 transition-transform">
            <i class="fas fa-chevron-left text-xs" id="toggleIcon"></i>
        </button>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-screen overflow-hidden w-full">
        <!-- Header -->
        <header class="h-20 bg-white shadow-sm flex items-center justify-between px-4 md:px-8 z-40 shrink-0">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden text-brand-dark text-xl p-2"><i class="fas fa-bars"></i></button>
                <div>
                    <h2 id="pageTitle" class="text-xl md:text-2xl font-bold text-brand-dark">Tableau de bord</h2>
                    <p class="text-xs md:text-sm text-gray-500">Vue d'ensemble</p>
                </div>
            </div>
            <div class="bg-brand-light px-3 py-1.5 md:px-4 md:py-2 rounded-full text-xs md:text-sm font-medium text-gray-600">
                <i class="fas fa-university mr-2 text-brand-yellow"></i>
                <span id="univNameDisplay">√âcole des Travaux</span>
            </div>
        </header>

        <!-- Main Scroll Area -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8 relative">
            
            <!-- Dashboard Section (Inject√© par dashboard-analytics.js) -->
            <div id="section-dashboard" class="section-content animate-fade-in h-full">
                <!-- Contenu charg√© via JS -->
            </div>

            <!-- SECTION: USERS (Iframe Integration) -->
            <div id="section-users" class="section-content hidden h-full">
                <iframe src="admin.html" class="iframe-container shadow-sm border border-gray-200"></iframe>
            </div>

            <!-- SECTION: MEMOIRES (Iframe Integration) -->
            <div id="section-memoires" class="section-content hidden h-full">
                <iframe src="admin-memoires.html" class="iframe-container shadow-sm border border-gray-200"></iframe>
            </div><div id="section-interactions" class="section-content hidden h-full">
              <iframe src="admin_interactions.html" class="iframe-container shadow-sm border border-gray-200"></iframe>
            </div>
            <!-- SECTION: NEWS -->
            <div id="section-news" class="section-content hidden animate-fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <div class="relative w-full md:w-96 group">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="searchNews" placeholder="Rechercher..." class="w-full pl-10 pr-4 py-3 bg-gray-50 border-2 border-transparent rounded-lg focus:bg-white focus:border-brand-yellow/50 outline-none">
                    </div>
                    <button onclick="newsManager.openModal()" class="w-full md:w-auto px-6 py-3 bg-brand-yellow text-brand-dark font-bold rounded-lg shadow flex items-center justify-center gap-2"><i class="fas fa-plus"></i> <span>Ajouter</span></button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-x-auto border border-gray-100">
                    <table class="w-full text-left min-w-[600px]">
                        <thead class="bg-gray-50 text-gray-500 uppercase text-xs font-bold border-b border-gray-100">
                            <tr><th class="px-6 py-4">Titre</th><th class="px-6 py-4">Cat√©gorie</th><th class="px-6 py-4">Statut</th><th class="px-6 py-4 text-right">Actions</th></tr>
                        </thead>
                        <tbody id="newsTableBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
            <!-- SECTION: ANCIENS √âTUDIANTS -->
<div id="section-old-students" class="section-content hidden h-full">
    <iframe src="old_student_admin.html" class="iframe-container shadow-sm border border-gray-200"></iframe>
</div>
            <!-- SECTION: DOMAINES -->
            <div id="section-domaines" class="section-content hidden animate-fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <div class="relative w-full md:w-96 group">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input id="domaine-search" type="text" placeholder="Rechercher un domaine..." class="w-full pl-10 pr-4 py-3 bg-gray-50 border-2 border-transparent rounded-lg focus:bg-white focus:border-brand-yellow/50 outline-none">
                        <ul id="suggestions-box" class="absolute top-full left-0 w-full bg-white border border-gray-200 rounded-lg mt-1 shadow-lg hidden z-10 max-h-60 overflow-y-auto"></ul>
                    </div>
                    <button data-action="open-add-modal" class="w-full md:w-auto px-6 py-3 bg-brand-yellow text-brand-dark font-bold rounded-lg shadow flex items-center justify-center gap-2"><i class="fas fa-plus"></i> <span>Nouveau Domaine</span></button>
                </div>
                <div id="domaines-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                <div id="empty-domaine-tpl" class="hidden"><div class="col-span-full flex flex-col items-center justify-center text-gray-400 py-12"><i class="fas fa-folder-open text-4xl mb-3"></i><p>Aucun domaine trouv√©</p></div></div>
            </div>
        </main>
    </div>

    <!-- News Modal -->
    <div id="newsModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-brand-dark/80 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh] animate-slide-up">
            <div class="flex justify-between items-center p-6 border-b"><h2 id="newsModalTitle" class="text-xl font-bold">Actualit√©</h2><button onclick="newsManager.closeModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center"><i class="fas fa-times"></i></button></div>
            <div class="p-6 overflow-y-auto flex-1">
                <form id="newsForm" class="space-y-5" onsubmit="return false;">
                    <input type="hidden" id="newsId">
                    <div><label class="block text-sm font-bold mb-1">Titre *</label><input type="text" name="title" required class="w-full p-3 border-2 rounded-lg outline-none focus:border-brand-yellow"></div>
                    <div><label class="block text-sm font-bold mb-1">Contenu *</label><textarea name="body" required class="w-full p-3 border-2 rounded-lg outline-none focus:border-brand-yellow h-32"></textarea></div>
                    <div><label class="block text-sm font-bold mb-1">Cat√©gorie</label><select name="topics" class="w-full p-3 border-2 rounded-lg outline-none bg-white"><option value="general">G√©n√©ral</option><option value="event">√âv√©nement</option><option value="award">R√©compense</option><option value="research">Recherche</option></select></div>
                    <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg"><input type="checkbox" name="is_published" class="w-5 h-5 text-brand-yellow"><span class="font-bold">Publier</span></label>
                </form>
            </div>
            <div class="p-4 border-t flex justify-end gap-3"><button onclick="newsManager.closeModal()" class="px-5 py-2 rounded-lg hover:bg-gray-100 font-bold">Annuler</button><button onclick="newsManager.submit()" class="px-6 py-2 bg-brand-yellow font-bold rounded-lg shadow">Enregistrer</button></div>
        </div>
    </div>

    <!-- Domaine Modal -->
    <div id="add-domaine-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-brand-dark/80 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-slide-up">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Domaine</h3><span class="modal-close cursor-pointer text-gray-400 text-2xl">&times;</span></div>
            <form id="add-domaine-form" class="space-y-4">
                <div><label class="block text-sm font-bold mb-1">Nom</label><input id="new-domaine-nom" type="text" required class="w-full p-3 border-2 rounded-lg outline-none focus:border-brand-yellow"><small id="slug-preview" class="text-xs text-gray-500 mt-1 block"></small></div>
                <div class="flex justify-end gap-3"><button type="button" class="modal-close px-4 py-2 hover:bg-gray-100 rounded-lg font-bold">Annuler</button><button type="submit" class="px-4 py-2 bg-brand-yellow font-bold rounded-lg shadow">Enregistrer</button></div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-[70] flex flex-col gap-2 pointer-events-none"></div>

    <!-- IMPORT MODULE DASHBOARD -->
    <script src="./static/js/dashboard-analytics.js"></script>

    <!-- JavaScript Logic -->
    <script>
        // CONFIG
        const CONFIG = { API_BASE: 'https://mcb.reimca-app.com/api', UNIV_SLUG: 'ecole-des-travaux', TOKEN: localStorage.getItem('authToken') || '' };
        
        // UTILS
        const Utils = {
            getHeaders: () => ({ 'Authorization': `Bearer ${CONFIG.TOKEN}`, 'Content-Type': 'application/json' }),
            showToast: (msg, type='info') => {
                const c = document.getElementById('toast-container');
                const t = document.createElement('div');
                t.className = `toast px-4 py-3 rounded-lg shadow-lg text-white font-medium flex items-center gap-2 pointer-events-auto ${type==='success'?'bg-green-600':type==='error'?'bg-red-600':'bg-blue-600'}`;
                if(type==='warning') t.className = `toast px-4 py-3 rounded-lg shadow-lg bg-brand-yellow text-brand-dark font-medium flex items-center gap-2 pointer-events-auto`;
                t.innerHTML = `<span>${msg}</span>`;
                c.appendChild(t); setTimeout(()=>t.remove(), 3000);
            },
            escapeHtml: (str) => (str||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))
        };

        // GLOBAL APP
        const app = {
            init: async function() {
    // üîí V√©rification s√©curis√©e AVANT tout chargement
    const token = localStorage.getItem('authToken');

    if (!token) {
        window.location.replace('/register.html');
        return;
    }

    try {
        const res = await fetch(`${CONFIG.API_BASE}/universites/auth/${CONFIG.UNIV_SLUG}/my-role/`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error("Invalid role response");

        const data = await res.json();
        const role = data.role;

        if (!['admin', 'superadmin', 'bigboss'].includes(role)) {
            window.location.replace('/register.html');
            return;
        }

        // ‚úÖ Acc√®s autoris√© ‚Üí on continue
        this.user = { full_name: "Admin V√©rifi√©", prenom: "Admin", role: role };
        document.getElementById('userName').textContent = this.user.full_name;
        document.getElementById('userAvatar').textContent = this.user.prenom[0];
        document.getElementById('userRole').textContent = role;

        // --- INIT MODULES ---
        if (window.DashboardAnalytics) {
            const dashboard = new DashboardAnalytics({
                apiBase: CONFIG.API_BASE,
                univSlug: CONFIG.UNIV_SLUG,
                token: CONFIG.TOKEN,
                containerId: 'section-dashboard'
            });
            dashboard.init();
        } else {
            console.error("DashboardAnalytics not loaded");
        }

        domaineManager.init();

    } catch (e) {
        console.error("Secure access error:", e);
        window.location.replace('/register.html');
    }
},
            nav: function(section) {
                // Menu Active State
                document.querySelectorAll('.menu-item').forEach(b => {
                    b.className = `menu-item w-full flex items-center gap-4 px-4 py-3 rounded-lg text-left hover:bg-white/10 transition-colors group text-gray-300`;
                    b.querySelector('i').className = `fas ${b.querySelector('i').className.split(' ')[1]} w-6 text-center text-gray-400 group-hover:text-brand-yellow`;
                    if(b.dataset.target === section) {
                        b.className = `menu-item w-full flex items-center gap-4 px-4 py-3 rounded-lg text-left transition-colors group bg-white/10 text-white border-l-4 border-brand-yellow`;
                        b.querySelector('i').className = `fas ${b.querySelector('i').className.split(' ')[1]} w-6 text-center text-brand-yellow`;
                    }
                });
                
                // Show Section
                document.querySelectorAll('.section-content').forEach(s => s.classList.add('hidden'));
                const target = document.getElementById(`section-${section}`);
                if(target) target.classList.remove('hidden');
                
                // Titles
                const titles = {
    dashboard: 'Tableau de bord',
    users: 'Utilisateurs',
    memoires: 'M√©moires',
    news: 'Actualit√©s',
    domaines: 'Domaines',
    interactions: 'Interactions',
    old_students: 'Anciens √âtudiants'
};
                document.getElementById('pageTitle').innerText = titles[section] || 'Administration';
                
                // Load Data specific logic
                if(section === 'news') newsManager.load();
                if(section === 'domaines') domaineManager.loadDomaines();
                if(section === 'old-students') {
  
}
                // Mobile Sidebar Logic
                const sb = document.getElementById('sidebar');
                if(sb.classList.contains('sidebar-mobile') && sb.classList.contains('active')) toggleSidebar();
            },
            logout: function() { localStorage.removeItem('authToken'); window.location.reload(); }
        };

        // NEWS MANAGER
        const newsManager = {
            data: [],
            load: async function() {
                const tbody = document.getElementById('newsTableBody');
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Chargement...</td></tr>';
                try {
                    const res = await fetch(`${CONFIG.API_BASE}/universites/universities/${CONFIG.UNIV_SLUG}/news/`, { headers: Utils.getHeaders() });
                    if(res.ok) this.data = await res.json();
                    else this.data = []; 
                } catch(e) { this.data = []; }
                this.render();
            },
            render: function() {
                const tbody = document.getElementById('newsTableBody');
                if(!this.data.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">Aucune actualit√©</td></tr>'; return; }
                tbody.innerHTML = this.data.map(n => `
                    <tr class="hover:bg-gray-50 border-b border-gray-50">
                        <td class="px-6 py-4 font-bold">${Utils.escapeHtml(n.title)}</td>
                        <td class="px-6 py-4 text-gray-600">${n.topics}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${n.is_published?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}">${n.is_published?'Publi√©':'Brouillon'}</span></td>
                        <td class="px-6 py-4 text-right"><button onclick="newsManager.edit(${n.id})" class="text-blue-600 hover:bg-blue-50 p-2 rounded"><i class="fas fa-edit"></i></button><button onclick="newsManager.del(${n.id})" class="text-red-600 hover:bg-red-50 p-2 rounded"><i class="fas fa-trash"></i></button></td>
                    </tr>`).join('');
            },
            openModal: function(id=null) {
                const m = document.getElementById('newsModal'); m.classList.remove('hidden'); m.classList.add('flex');
                document.getElementById('newsForm').reset(); document.getElementById('newsId').value = id||'';
                document.getElementById('newsModalTitle').innerText = id?"Modifier":"Ajouter";
            },
            closeModal: function() { const m = document.getElementById('newsModal'); m.classList.add('hidden'); m.classList.remove('flex'); },
            edit: function(id) {
                const n = this.data.find(x=>x.id===id); if(!n) return;
                this.openModal(id);
                const f = document.getElementById('newsForm'); f.title.value = n.title; f.body.value = n.body; f.topics.value = n.topics; f.is_published.checked = n.is_published;
            },
            submit: async function() { Utils.showToast('Sauvegard√© (Simul√©)', 'success'); this.closeModal(); },
            del: async function(id) { if(confirm('Supprimer ?')) Utils.showToast('Supprim√© (Simul√©)', 'success'); }
        };

      class DomaineManager {
    constructor() {
        this.domaines = [];
        this.editingSlug = null; // slug en cours d'√©dition
        this.DOM = {
            listBox: document.getElementById('domaines-container'),
            search: document.getElementById('domaine-search'),
            suggest: document.getElementById('suggestions-box'),
            modal: document.getElementById('add-domaine-modal'),
            form: document.getElementById('add-domaine-form'),
            input: document.getElementById('new-domaine-nom'),
            slug: document.getElementById('slug-preview'),
        };
    }

    init() {
        this.DOM.search.addEventListener('input', e => this.onSearch(e.target.value));
        this.DOM.form.addEventListener('submit', e => this.onSubmit(e));
        this.DOM.input.addEventListener('input', () => this.previewSlug());
        document.querySelector('[data-action="open-add-modal"]').addEventListener('click', () => this.openModal(true));
        this.DOM.listBox.addEventListener('click', e => {
            const editBtn = e.target.closest('[data-action="edit"]');
            const delBtn = e.target.closest('[data-action="delete"]');
            if (editBtn) this.onEdit(editBtn.dataset.slug);
            if (delBtn) this.onDelete(delBtn.dataset.slug);
        });
        this.DOM.modal.querySelectorAll('.modal-close').forEach(el =>
            el.addEventListener('click', () => this.openModal(false))
        );
    }

    /* ----------  CHARGEMENT  ---------- */
    async loadDomaines() {
        try {
            const res = await fetch(
                `${CONFIG.API_BASE}/universites/universites/${CONFIG.UNIV_SLUG}/domaines/`,
                { headers: Utils.getHeaders() }
            );
            if (!res.ok) throw new Error();
            this.domaines = await res.json();
        } catch {
            Utils.showToast("Erreur lors du chargement des domaines", "error");
            this.domaines = [];
        }
        this.render();
    }

    /* ----------  AFFICHAGE  ---------- */
    render() {
        const box = this.DOM.listBox;
        if (!this.domaines.length) {
            box.innerHTML = document.getElementById('empty-domaine-tpl').innerHTML;
            return;
        }
        box.innerHTML = this.domaines
            .map(d => `
                <div class="domaine-card bg-white p-5 rounded-xl border border-gray-100 relative group">
                    <h4 class="font-bold text-lg">${Utils.escapeHtml(d.nom)}</h4>
                    <small class="text-gray-400 text-xs font-mono">${d.slug}</small>
                    <div class="flex flex-wrap gap-2 mt-2">
                        ${d.universites.map(u =>
                            `<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold">${u.acronyme || u.nom}</span>`
                        ).join('')}
                    </div>
                    <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="w-8 h-8 rounded bg-yellow-100 text-yellow-700 flex items-center justify-center" data-action="edit" data-slug="${d.slug}">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                        <button class="w-8 h-8 rounded bg-red-100 text-red-700 flex items-center justify-center" data-action="delete" data-slug="${d.slug}">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>`)
            .join('');
    }

    /* ----------  RECHERCHE LOCALE  ---------- */
    onSearch(q) {
        const filtered = this.domaines.filter(d =>
            d.nom.toLowerCase().includes(q.toLowerCase())
        );
        this.DOM.listBox.innerHTML = filtered.length
            ? filtered.map(d => `
                <div class="domaine-card bg-white p-5 rounded-xl border border-gray-100">
                    <h4 class="font-bold text-lg">${Utils.escapeHtml(d.nom)}</h4>
                    <small class="text-gray-400 text-xs font-mono">${d.slug}</small>
                    <div class="flex flex-wrap gap-2 mt-2">
                        ${d.universites.map(u =>
                            `<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">${u.acronyme || u.nom}</span>`
                        ).join('')}
                    </div>
                </div>`).join('')
            : document.getElementById('empty-domaine-tpl').innerHTML;
    }

    /* ----------  MODAL  ---------- */
    openModal(show) {
        if (show) {
            this.DOM.modal.classList.remove('hidden');
            this.DOM.modal.classList.add('flex');
            this.DOM.input.focus();
        } else {
            this.DOM.modal.classList.add('hidden');
            this.DOM.modal.classList.remove('flex');
            this.DOM.form.reset();
            this.DOM.slug.textContent = '';
            this.editingSlug = null;
        }
    }

    previewSlug() {
        const s = this.DOM.input.value.trim()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/\W+/g, '-').toLowerCase();
        this.DOM.slug.textContent = s ? `Slug: ${s}` : '';
    }

    /* ----------  √âDITION  ---------- */
    onEdit(slug) {
        const d = this.domaines.find(x => x.slug === slug);
        if (!d) return;
        this.editingSlug = slug;
        this.openModal(true);
        this.DOM.input.value = d.nom;
        this.previewSlug();
    }

    /* ----------  SOUMISSION (CREATE / UPDATE)  ---------- */
    async onSubmit(e) {
        e.preventDefault();
        const nom = this.DOM.input.value.trim();
        if (!nom) return Utils.showToast("Nom requis", "warning");

        const payload = { nom };
        const isEdit = !!this.editingSlug;
        const url = isEdit
            ? `${CONFIG.API_BASE}/universites/universites/${CONFIG.UNIV_SLUG}/domaines/${this.editingSlug}/update/`
            : `${CONFIG.API_BASE}/universites/universites/${CONFIG.UNIV_SLUG}/domaines/create/`;
        const method = isEdit ? 'PATCH' : 'POST';

        try {
            const res = await fetch(url, {
                method,
                headers: {
                    ...Utils.getHeaders(),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });
            if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);

            Utils.showToast(isEdit ? 'Domaine modifi√©' : 'Domaine cr√©√©', 'success');
            this.openModal(false);
            this.loadDomaines();
        } catch (err) {
            console.error(err);
            Utils.showToast("Erreur lors de l'enregistrement", "error");
        }
    }

    /* ----------  SUPPRESSION  ---------- */
    async onDelete(slug) {
        if (!confirm('Supprimer ce domaine ?')) return;
        try {
            const res = await fetch(
                `${CONFIG.API_BASE}/universites/universites/${CONFIG.UNIV_SLUG}/domaines/${slug}/`,
                { method: 'DELETE', headers: Utils.getHeaders() }
            );
            if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);

            Utils.showToast('Domaine supprim√©', 'success');
            this.loadDomaines();
        } catch (err) {
            console.error(err);
            Utils.showToast("Erreur lors de la suppression", "error");
        }
    }
}

/* ----------  INITIALISATION  ---------- */
const domaineManager = new DomaineManager();

        // UI HELPERS
        function toggleSidebar() {
            const sb = document.getElementById('sidebar'); const ov = document.getElementById('mobileOverlay');
            sb.classList.remove('sidebar-desktop'); sb.classList.add('sidebar-mobile');
            if(sb.classList.contains('active')) { sb.classList.remove('active'); ov.classList.add('hidden'); }
            else { sb.classList.add('active'); ov.classList.remove('hidden'); }
        }
        function toggleDesktopSidebar() {
            const sb = document.getElementById('sidebar'); const ic = document.getElementById('toggleIcon');
            if(sb.classList.contains('w-72')) { sb.classList.remove('w-72'); sb.classList.add('sidebar-collapsed'); ic.className="fas fa-chevron-right text-xs"; }
            else { sb.classList.add('w-72'); sb.classList.remove('sidebar-collapsed'); ic.className="fas fa-chevron-left text-xs"; }
        }

        // INIT
        document.addEventListener('DOMContentLoaded', ()=>app.init());
    </script>
</body>
</html>