<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Utilisateur - MemoCloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                yellow: '#ffb606',
                dark: '#3a3a3a',
                light: '#f5f7fa',
              }
            },
            animation: {
              'fade-in': 'fadeIn 0.3s ease-out',
              'slide-up': 'slideUp 0.3s ease-out',
              'scale-in': 'scaleIn 0.2s ease-out',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              slideUp: {
                '0%': { transform: 'translateY(20px)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              },
              scaleIn: {
                '0%': { transform: 'scale(0.95)', opacity: '0' },
                '100%': { transform: 'scale(1)', opacity: '1' },
              }
            }
          }
        }
      }
    </script>

    <style>
      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf0 100%);
        color: #3a3a3a;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

      .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }

      .stat-card {
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }

      .profile-tab {
        position: relative;
        padding-bottom: 0.5rem;
      }

      .profile-tab.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: #ffb606;
        border-radius: 3px 3px 0 0;
      }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="min-h-screen">
        <!-- Loading -->
        <div class="fixed inset-0 flex items-center justify-center bg-brand-light z-50" id="initialLoader">
            <div class="flex flex-col items-center gap-4">
                <i class="fas fa-circle-notch fa-spin text-5xl text-brand-yellow"></i>
                <p class="text-brand-dark font-bold animate-pulse">Chargement du profil...</p>
            </div>
        </div>
    </div>

    <!-- Header Template -->
    <template id="header-template">
        <header class="bg-brand-dark text-white shadow-lg sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-brand-yellow flex items-center justify-center text-brand-dark font-bold text-xl">
                        <i class="fas fa-user"></i>
                    </div>
                    <h1 class="text-xl font-bold">Profil<span class="text-brand-yellow">Utilisateur</span></h1>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="window.location.href='/dashboard.html'" class="text-gray-300 hover:text-white transition-colors">
                        <i class="fas fa-home mr-2"></i>Accueil
                    </button>
                    <button onclick="app.logout()" class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>D√©connexion
                    </button>
                </div>
            </div>
        </header>
    </template>

    <!-- Main Template -->
    <template id="main-template">
        <main class="max-w-7xl mx-auto px-4 py-8 animate-fade-in">
            
            <!-- Profile Header -->
            <div class="glass-card rounded-2xl shadow-xl p-8 mb-8 animate-scale-in">
                <div class="flex flex-col md:flex-row items-center md:items-start gap-8">
                    <!-- Photo de profil -->
                    <div class="relative group">
                        <div id="profilePhoto" class="w-40 h-40 rounded-full bg-gradient-to-br from-brand-yellow to-orange-400 flex items-center justify-center text-white text-5xl font-bold shadow-2xl overflow-hidden">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="absolute inset-0 rounded-full bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <i class="fas fa-camera text-white text-2xl"></i>
                        </div>
                    </div>

                    <!-- Infos principales -->
                    <div class="flex-1 text-center md:text-left">
                        <h2 id="userName" class="text-4xl font-bold text-brand-dark mb-2"></h2>
                        <p id="userEmail" class="text-gray-600 mb-4 flex items-center justify-center md:justify-start gap-2">
                            <i class="fas fa-envelope"></i>
                            <span></span>
                        </p>
                        
                        <div class="flex flex-wrap gap-3 justify-center md:justify-start mb-4">
                            <span id="userRole" class="px-4 py-2 bg-brand-yellow/20 text-brand-dark rounded-full font-bold text-sm">
                                <i class="fas fa-user-tag mr-1"></i>
                            </span>
                            <span id="userSexe" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-full font-bold text-sm">
                                <i class="fas fa-venus-mars mr-1"></i>
                            </span>
                            <span id="userUniv" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-full font-bold text-sm">
                                <i class="fas fa-university mr-1"></i>
                            </span>
                        </div>

                        <div id="linkedinContainer" class="hidden">
                            <a id="linkedinLink" href="#" target="_blank" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fab fa-linkedin"></i>
                                Voir mon LinkedIn
                            </a>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center">
                            <div id="totalMemoires" class="text-3xl font-bold text-brand-yellow">0</div>
                            <div class="text-xs text-gray-600">M√©moires</div>
                        </div>
                        <div class="text-center">
                            <div id="totalEncadrements" class="text-3xl font-bold text-green-600">0</div>
                            <div class="text-xs text-gray-600">Encadrements</div>
                        </div>
                        <div class="text-center">
                            <div id="totalComments" class="text-3xl font-bold text-blue-600">0</div>
                            <div class="text-xs text-gray-600">Commentaires</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="bg-white rounded-xl shadow-md p-4 mb-8">
                <div class="flex overflow-x-auto gap-6 text-sm font-bold">
                    <button onclick="app.switchTab('overview')" class="profile-tab active whitespace-nowrap px-4 py-2 text-brand-dark" data-tab="overview">
                        <i class="fas fa-chart-line mr-2"></i>Vue d'ensemble
                    </button>
                    <button onclick="app.switchTab('memoires')" class="profile-tab whitespace-nowrap px-4 py-2 text-gray-600 hover:text-brand-dark transition-colors" data-tab="memoires">
                        <i class="fas fa-book mr-2"></i>Mes M√©moires
                    </button>
                    <button onclick="app.switchTab('encadrements')" class="profile-tab whitespace-nowrap px-4 py-2 text-gray-600 hover:text-brand-dark transition-colors" data-tab="encadrements">
                        <i class="fas fa-chalkboard-teacher mr-2"></i>Encadrements
                    </button>
                    <button onclick="app.switchTab('interactions')" class="profile-tab whitespace-nowrap px-4 py-2 text-gray-600 hover:text-brand-dark transition-colors" data-tab="interactions">
                        <i class="fas fa-comments mr-2"></i>Interactions
                    </button>
                    <button onclick="app.switchTab('stats')" class="profile-tab whitespace-nowrap px-4 py-2 text-gray-600 hover:text-brand-dark transition-colors" data-tab="stats">
                        <i class="fas fa-trophy mr-2"></i>Classements
                    </button>
                </div>
            </div>

            <!-- Tab Content -->
            <div id="tabContent" class="animate-fade-in"></div>

        </main>
    </template>

    <script>
        const CONFIG = {
            API_URL: 'https://mcb.reimca-app.com//api',
            UNIV_SLUG: 'ecole-des-travaux'
        };

        const state = {
            currentUser: null,
            userProfile: null,
            memoires: [],
            encadrements: [],
            comments: [],
            likes: [],
            telechargements: [],
            notations: [],
            topContributors: [],
            currentTab: 'overview'
        };

        const app = {
            async init() {
                const token = localStorage.getItem('authToken');
                if (!token) return this.redirectLogin();

                // Get user ID from URL or use current user
                const urlParams = new URLSearchParams(window.location.search);
                const userId = urlParams.get('id');

                try {
                    await this.loadCurrentUser(token);
                    await this.loadUserProfile(token, userId);
                    await this.loadAllData(token, userId);
                    this.renderApp();
                } catch (e) {
                    console.error(e);
                    alert("Erreur de chargement du profil");
                    this.redirectLogin();
                }
            },

            redirectLogin() {
                window.location.href = '/register.html';
            },

            async loadCurrentUser(token) {
                const res = await fetch(`${CONFIG.API_URL}/auth/me/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('User fetch failed');
                state.currentUser = await res.json();
            },

            async loadUserProfile(token, userId) {
                const targetId = userId || state.currentUser.id;
                const res = await fetch(`${CONFIG.API_URL}/auth/${CONFIG.UNIV_SLUG}/users/profile/${targetId}/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Profile fetch failed');
                state.userProfile = await res.json();
            },

            async loadAllData(token, userId) {
                const headers = { 'Authorization': `Bearer ${token}` };
                const targetId = userId || state.currentUser.id;

                // Charger tous les m√©moires de l'universit√©
                const memoiresRes = await fetch(`${CONFIG.API_URL}/memoires/universites/${CONFIG.UNIV_SLUG}/memoires/`, { headers });
                const allMemoires = await memoiresRes.json();

                // Filtrer les m√©moires de l'auteur
                state.memoires = allMemoires.filter(m => m.auteur.id === targetId);

                // Filtrer les encadrements
                state.encadrements = allMemoires.filter(m => 
                    m.encadreurs.some(e => e.id === targetId)
                );

                // Charger les commentaires
                const commentsRes = await fetch(`${CONFIG.API_URL}/interactions/universites/${CONFIG.UNIV_SLUG}/interactions/commentaires/`, { headers });
                const allComments = await commentsRes.json();
                state.comments = allComments.filter(c => c.utilisateur.id === targetId);

                // Charger les likes
                const likesRes = await fetch(`${CONFIG.API_URL}/interactions/universites/${CONFIG.UNIV_SLUG}/interactions/likes/`, { headers });
                const allLikes = await likesRes.json();
                state.likes = allLikes.filter(l => l.utilisateur === targetId);

                // Charger les t√©l√©chargements
                const dlRes = await fetch(`${CONFIG.API_URL}/interactions/universites/${CONFIG.UNIV_SLUG}/interactions/telechargements/`, { headers });
                const allDl = await dlRes.json();
                state.telechargements = allDl.filter(t => t.utilisateur === targetId);

                // Charger les notations
                const notationsRes = await fetch(`${CONFIG.API_URL}/interactions/universites/${CONFIG.UNIV_SLUG}/interactions/notations/`, { headers });
                const allNotations = await notationsRes.json();
                state.notations = allNotations.filter(n => n.utilisateur === targetId);

                // Top contributeurs
                const topRes = await fetch(`${CONFIG.API_URL}/auth/${CONFIG.UNIV_SLUG}/users/top-contrib/`, { headers });
                state.topContributors = await topRes.json();
            },

            renderApp() {
                document.getElementById('initialLoader').remove();

                const headerTmpl = document.getElementById('header-template').content.cloneNode(true);
                document.getElementById('app').appendChild(headerTmpl);

                const mainTmpl = document.getElementById('main-template').content.cloneNode(true);
                document.getElementById('app').appendChild(mainTmpl);

                this.renderProfileHeader();
                this.renderTab('overview');
            },

            renderProfileHeader() {
                const profile = state.userProfile;

                // Photo
                const photoDiv = document.getElementById('profilePhoto');
                if (profile.photo_profil) {
                    photoDiv.innerHTML = `<img src="${profile.photo_profil}" class="w-full h-full object-cover">`;
                } else {
                    const initials = (profile.prenom[0] + profile.nom[0]).toUpperCase();
                    photoDiv.innerHTML = initials;
                }

                // Infos
                document.getElementById('userName').textContent = `${profile.prenom} ${profile.nom}`;
                document.getElementById('userEmail').querySelector('span').textContent = profile.email;
                document.getElementById('userRole').innerHTML = `<i class="fas fa-user-tag mr-1"></i>${profile.role}`;
                document.getElementById('userSexe').innerHTML = `<i class="fas fa-venus-mars mr-1"></i>${profile.sexe === 'M' ? 'Homme' : 'Femme'}`;
                document.getElementById('userUniv').innerHTML = `<i class="fas fa-university mr-1"></i>${profile.universite}`;

                // LinkedIn
                if (profile.realisation_linkedin) {
                    document.getElementById('linkedinContainer').classList.remove('hidden');
                    document.getElementById('linkedinLink').href = profile.realisation_linkedin;
                }

                // Quick stats
                document.getElementById('totalMemoires').textContent = state.memoires.length;
                document.getElementById('totalEncadrements').textContent = state.encadrements.length;
                document.getElementById('totalComments').textContent = state.comments.length;
            },

            switchTab(tabName) {
                state.currentTab = tabName;
                
                // Update active tab
                document.querySelectorAll('.profile-tab').forEach(tab => {
                    if (tab.dataset.tab === tabName) {
                        tab.classList.add('active', 'text-brand-dark');
                        tab.classList.remove('text-gray-600');
                    } else {
                        tab.classList.remove('active', 'text-brand-dark');
                        tab.classList.add('text-gray-600');
                    }
                });

                this.renderTab(tabName);
            },

            renderTab(tabName) {
                const container = document.getElementById('tabContent');
                container.innerHTML = '';

                switch(tabName) {
                    case 'overview':
                        this.renderOverview(container);
                        break;
                    case 'memoires':
                        this.renderMemoires(container);
                        break;
                    case 'encadrements':
                        this.renderEncadrements(container);
                        break;
                    case 'interactions':
                        this.renderInteractions(container);
                        break;
                    case 'stats':
                        this.renderStats(container);
                        break;
                }
            },

            renderOverview(container) {
                const totalDl = state.memoires.reduce((sum, m) => sum + m.nb_telechargements, 0);
                const totalLikes = state.memoires.reduce((sum, m) => sum + m.nb_likes, 0);
                const avgNote = state.memoires.reduce((sum, m) => sum + m.note_moyenne, 0) / Math.max(state.memoires.length, 1);

                container.innerHTML = `
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card glass-card rounded-xl p-6 shadow-lg">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                                    <i class="fas fa-book text-blue-600 text-xl"></i>
                                </div>
                                <span class="text-3xl font-bold text-brand-dark">${state.memoires.length}</span>
                            </div>
                            <p class="text-gray-600 font-medium">M√©moires publi√©s</p>
                            <p class="text-xs text-gray-500 mt-1">En tant qu'auteur</p>
                        </div>

                        <div class="stat-card glass-card rounded-xl p-6 shadow-lg">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                                    <i class="fas fa-chalkboard-teacher text-green-600 text-xl"></i>
                                </div>
                                <span class="text-3xl font-bold text-brand-dark">${state.encadrements.length}</span>
                            </div>
                            <p class="text-gray-600 font-medium">Encadrements</p>
                            <p class="text-xs text-gray-500 mt-1">Projets supervis√©s</p>
                        </div>

                        <div class="stat-card glass-card rounded-xl p-6 shadow-lg">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center">
                                    <i class="fas fa-download text-purple-600 text-xl"></i>
                                </div>
                                <span class="text-3xl font-bold text-brand-dark">${totalDl}</span>
                            </div>
                            <p class="text-gray-600 font-medium">T√©l√©chargements</p>
                            <p class="text-xs text-gray-500 mt-1">Total des DL</p>
                        </div>

                        <div class="stat-card glass-card rounded-xl p-6 shadow-lg">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center">
                                    <i class="fas fa-star text-brand-yellow text-xl"></i>
                                </div>
                                <span class="text-3xl font-bold text-brand-dark">${avgNote.toFixed(1)}</span>
                            </div>
                            <p class="text-gray-600 font-medium">Note moyenne</p>
                            <p class="text-xs text-gray-500 mt-1">Sur 5 √©toiles</p>
                        </div>
                    </div>

                    <!-- Activity Timeline -->
                    <div class="glass-card rounded-xl p-6 shadow-lg mb-8">
                        <h3 class="text-xl font-bold text-brand-dark mb-6 flex items-center gap-2">
                            <i class="fas fa-chart-line text-brand-yellow"></i>
                            Activit√© r√©cente
                        </h3>
                        <div class="space-y-4" id="activityTimeline"></div>
                    </div>

                    <!-- Best Memoires -->
                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-bold text-brand-dark mb-6 flex items-center gap-2">
                            <i class="fas fa-trophy text-brand-yellow"></i>
                            M√©moires les plus populaires
                        </h3>
                        <div class="space-y-4" id="bestMemoires"></div>
                    </div>
                `;

                // Activity timeline
                this.renderActivityTimeline();
                
                // Best memoires
                this.renderBestMemoires();
            },

            renderActivityTimeline() {
                const timeline = document.getElementById('activityTimeline');
                const activities = [];

                // Ajouter les activit√©s
                state.memoires.forEach(m => {
                    activities.push({
                        date: new Date(m.created_at),
                        icon: 'fa-book',
                        color: 'blue',
                        text: `Publi√© le m√©moire "${m.titre}"`,
                        type: 'memoire'
                    });
                });

                state.comments.forEach(c => {
                    activities.push({
                        date: new Date(c.date),
                        icon: 'fa-comment',
                        color: 'green',
                        text: `Comment√© : "${c.contenu.substring(0, 50)}..."`,
                        type: 'comment'
                    });
                });

                // Trier par date d√©croissante
                activities.sort((a, b) => b.date - a.date);

                // Afficher les 10 derni√®res
                activities.slice(0, 10).forEach(activity => {
                    const date = activity.date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
                    timeline.innerHTML += `
                        <div class="flex items-start gap-4 p-4 hover:bg-gray-50 rounded-lg transition-colors">
                            <div class="w-10 h-10 rounded-full bg-${activity.color}-100 flex items-center justify-center flex-shrink-0">
                                <i class="fas ${activity.icon} text-${activity.color}-600"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-gray-800 font-medium">${activity.text}</p>
                                <p class="text-xs text-gray-500 mt-1">${date}</p>
                            </div>
                        </div>
                    `;
                });

                if (activities.length === 0) {
                    timeline.innerHTML = '<p class="text-gray-400 text-center py-8">Aucune activit√© r√©cente</p>';
                }
            },

            renderBestMemoires() {
                const container = document.getElementById('bestMemoires');
                const sorted = [...state.memoires].sort((a, b) => b.nb_telechargements - a.nb_telechargements);

                sorted.slice(0, 5).forEach((m, index) => {
                    container.innerHTML += `
                        <div class="flex items-center gap-4 p-4 hover:bg-gray-50 rounded-lg transition-colors">
                            <div class="w-8 h-8 rounded-full bg-brand-yellow flex items-center justify-center font-bold text-brand-dark">
                                ${index + 1}
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-brand-dark">${m.titre}</h4>
                                <p class="text-sm text-gray-500">${m.annee}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-brand-yellow">${m.nb_telechargements}</p>
                                <p class="text-xs text-gray-500">t√©l√©chargements</p>
                            </div>
                        </div>
                    `;
                });

                if (sorted.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 text-center py-8">Aucun m√©moire publi√©</p>';
                }
            },

            renderMemoires(container) {
                container.innerHTML = `
                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-bold text-brand-dark mb-6">Mes m√©moires (${state.memoires.length})</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="memoiresList"></div>
                    </div>
                `;

                const list = document.getElementById('memoiresList');
                state.memoires.forEach(m => {
                    list.innerHTML += `
                        <div class="bg-white rounded-xl p-5 shadow-md hover:shadow-xl transition-all border border-gray-100">
                            <h4 class="font-bold text-brand-dark mb-2 line-clamp-2">${m.titre}</h4>
                            <p class="text-sm text-gray-600 mb-4 line-clamp-3">${m.resume}</p>
                            <div class="flex items-center justify-between text-xs text-gray-500 mb-4">
                                <span><i class="fas fa-calendar"></i> ${m.annee}</span>
                                <span><i class="fas fa-star text-brand-yellow"></i> ${m.note_moyenne.toFixed(1)}/5</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-center text-xs">
                                <div class="bg-blue-50 rounded p-2">
                                    <div class="font-bold text-blue-600">${m.nb_telechargements}</div>
                                    <div class="text-gray-500">DL</div>
                                </div>
                                <div class="bg-red-50 rounded p-2">
                                    <div class="font-bold text-red-600">${m.nb_likes}</div>
                                    <div class="text-gray-500">Likes</div>
                                </div>
                                <div class="bg-green-50 rounded p-2">
                                    <div class="font-bold text-green-600">${m.nb_commentaires}</div>
                                    <div class="text-gray-500">Com.</div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                if (state.memoires.length === 0) {
                    list.innerHTML = '<div class="col-span-3 text-center py-12 text-gray-400"><i class="fas fa-folder-open text-5xl mb-4"></i><p>Aucun m√©moire publi√©</p></div>';
                }
            },

            renderEncadrements(container) {
                container.innerHTML = `
                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-bold text-brand-dark mb-6">Mes encadrements (${state.encadrements.length})</h3>
                        <div class="space-y-4" id="encadrementsList"></div>
                    </div>
                `;

                const list = document.getElementById('encadrementsList');
                state.encadrements.forEach(m => {
                    list.innerHTML += `
                        <div class="bg-white rounded-xl p-5 shadow-md hover:shadow-xl transition-all border border-gray-100">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h4 class="font-bold text-brand-dark mb-2">${m.titre}</h4>
                                    <p class="text-sm text-gray-600 mb-2">Auteur: ${m.auteur.nom}</p>
                                    <div class="flex items-center gap-4 text-xs text-gray-500">
                                        <span><i class="fas fa-calendar"></i> ${m.annee}</span>
                                        <span><i class="fas fa-download text-blue-600"></i> ${m.nb_telechargements} DL</span>
                                        <span><i class="fas fa-star text-brand-yellow"></i> ${m.note_moyenne.toFixed(1)}/5</span>
                                    </div>
                                </div>
                                <div class="bg-green-50 rounded-full px-3 py-1 text-xs font-bold text-green-700">
                                    Encadr√©
                                </div>
                            </div>
                        </div>
                    `;
                });

                if (state.encadrements.length === 0) {
                    list.innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-chalkboard-teacher text-5xl mb-4"></i><p>Aucun encadrement</p></div>';
                }
            },

            renderInteractions(container) {
                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Commentaires -->
                        <div class="glass-card rounded-xl p-6 shadow-lg">
                            <h3 class="text-xl font-bold text-brand-dark mb-6 flex items-center gap-2">
                                <i class="fas fa-comments text-green-600"></i>
                                Mes commentaires (${state.comments.length})
                            </h3>
                            <div class="space-y-4 max-h-96 overflow-y-auto" id="commentsList"></div>
                        </div>

                        <!-- Likes -->
                        <div class="glass-card rounded-xl p-6 shadow-lg">
                            <h3 class="text-xl font-bold text-brand-dark mb-6 flex items-center gap-2">
                                <i class="fas fa-heart text-red-600"></i>
                                M√©moires lik√©s (${state.likes.length})
                            </h3>
                            <div class="space-y-4 max-h-96 overflow-y-auto" id="likesList"></div>
                        </div>

                        <!-- T√©l√©chargements -->
                        <div class="glass-card rounded-xl p-6 shadow-lg">
                            <h3 class="text-xl font-bold text-brand-dark mb-6 flex items-center gap-2">
                                <i class="fas fa-download text-blue-600"></i>
                                T√©l√©chargements (${state.telechargements.length})
                            </h3>
                            <div class="space-y-4 max-h-96 overflow-y-auto" id="downloadsList"></div>
                        </div>

                        <!-- Notations -->
                        <div class="glass-card rounded-xl p-6 shadow-lg">
                            <h3 class="text-xl font-bold text-brand-dark mb-6 flex items-center gap-2">
                                <i class="fas fa-star text-brand-yellow"></i>
                                Mes notations (${state.notations.length})
                            </h3>
                            <div class="space-y-4 max-h-96 overflow-y-auto" id="notationsList"></div>
                        </div>
                    </div>
                `;

                // Commentaires
                const commentsList = document.getElementById('commentsList');
                state.comments.slice(0, 10).forEach(c => {
                    const date = new Date(c.date).toLocaleDateString('fr-FR');
                    commentsList.innerHTML += `
                        <div class="bg-white rounded-lg p-4 border border-gray-100">
                            <p class="text-sm text-gray-700 mb-2">"${c.contenu}"</p>
                            <p class="text-xs text-gray-500"><i class="fas fa-clock"></i> ${date}</p>
                        </div>
                    `;
                });
                if (state.comments.length === 0) {
                    commentsList.innerHTML = '<p class="text-gray-400 text-center py-8">Aucun commentaire</p>';
                }

                // Likes
                const likesList = document.getElementById('likesList');
                state.likes.slice(0, 10).forEach(l => {
                    const date = new Date(l.date).toLocaleDateString('fr-FR');
                    likesList.innerHTML += `
                        <div class="bg-white rounded-lg p-4 border border-gray-100 flex items-center gap-3">
                            <i class="fas fa-heart text-red-500"></i>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-700">${l.memoire_titre}</p>
                                <p class="text-xs text-gray-500">${date}</p>
                            </div>
                        </div>
                    `;
                });
                if (state.likes.length === 0) {
                    likesList.innerHTML = '<p class="text-gray-400 text-center py-8">Aucun like</p>';
                }

                // T√©l√©chargements
                const downloadsList = document.getElementById('downloadsList');
                state.telechargements.slice(0, 10).forEach(t => {
                    const date = new Date(t.date).toLocaleDateString('fr-FR');
                    downloadsList.innerHTML += `
                        <div class="bg-white rounded-lg p-4 border border-gray-100 flex items-center gap-3">
                            <i class="fas fa-download text-blue-500"></i>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-700">${t.memoire_titre}</p>
                                <p class="text-xs text-gray-500">${date}</p>
                            </div>
                        </div>
                    `;
                });
                if (state.telechargements.length === 0) {
                    downloadsList.innerHTML = '<p class="text-gray-400 text-center py-8">Aucun t√©l√©chargement</p>';
                }

                // Notations
                const notationsList = document.getElementById('notationsList');
                state.notations.forEach(n => {
                    const date = new Date(n.created_at).toLocaleDateString('fr-FR');
                    notationsList.innerHTML += `
                        <div class="bg-white rounded-lg p-4 border border-gray-100 flex items-center gap-3">
                            <div class="flex items-center gap-1">
                                ${Array(5).fill(0).map((_, i) => 
                                    `<i class="fas fa-star ${i < n.note ? 'text-brand-yellow' : 'text-gray-300'}"></i>`
                                ).join('')}
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-700">Note: ${n.note}/5</p>
                                <p class="text-xs text-gray-500">${date}</p>
                            </div>
                        </div>
                    `;
                });
                if (state.notations.length === 0) {
                    notationsList.innerHTML = '<p class="text-gray-400 text-center py-8">Aucune notation</p>';
                }
            },

            renderStats(container) {
                const userRank = state.topContributors.findIndex(c => c.id === state.userProfile.id) + 1;
                const totalUsers = state.topContributors.length;

                container.innerHTML = `
                    <!-- Mon classement -->
                    <div class="glass-card rounded-xl p-8 shadow-lg mb-8 text-center">
                        <div class="inline-block mb-6">
                            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-brand-yellow to-orange-400 flex items-center justify-center text-white text-4xl font-bold shadow-xl">
                                #${userRank || '?'}
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-brand-dark mb-2">Votre classement</h3>
                        <p class="text-gray-600">Sur ${totalUsers} contributeurs</p>
                        ${userRank <= 3 ? `
                            <div class="mt-4 inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-yellow-400 to-orange-400 text-white rounded-full font-bold shadow-lg">
                                <i class="fas fa-trophy"></i>
                                Top 3 Contributeur !
                            </div>
                        ` : ''}
                    </div>

                    <!-- Top 10 Contributeurs -->
                    <div class="glass-card rounded-xl p-6 shadow-lg mb-8">
                        <h3 class="text-xl font-bold text-brand-dark mb-6 flex items-center gap-2">
                            <i class="fas fa-ranking-star text-brand-yellow"></i>
                            Top 10 Contributeurs
                        </h3>
                        <div class="space-y-3" id="topContributorsList"></div>
                    </div>

                    <!-- Graphiques -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="glass-card rounded-xl p-6 shadow-lg">
                            <h3 class="text-lg font-bold text-brand-dark mb-4">R√©partition des activit√©s</h3>
                            <canvas id="activityChart"></canvas>
                        </div>
                        <div class="glass-card rounded-xl p-6 shadow-lg">
                            <h3 class="text-lg font-bold text-brand-dark mb-4">Performance vs Moyenne</h3>
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>
                `;

                // Top contributeurs
                const topList = document.getElementById('topContributorsList');
                state.topContributors.slice(0, 10).forEach((c, index) => {
                    const isCurrentUser = c.id === state.userProfile.id;
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                    
                    topList.innerHTML += `
                        <div class="flex items-center gap-4 p-4 rounded-lg ${isCurrentUser ? 'bg-brand-yellow/20 border-2 border-brand-yellow' : 'bg-white border border-gray-100'}">
                            <div class="w-10 h-10 rounded-full bg-brand-dark text-white flex items-center justify-center font-bold">
                                ${medal || (index + 1)}
                            </div>
                            <div class="flex-1">
                                <p class="font-bold text-brand-dark">${c.prenom} ${c.nom} ${isCurrentUser ? '(Vous)' : ''}</p>
                                <p class="text-xs text-gray-500">${c.nb_memoires} m√©moires ‚Ä¢ ${c.nb_telechargements} t√©l√©chargements</p>
                            </div>
                            ${isCurrentUser ? '<i class="fas fa-star text-brand-yellow text-xl"></i>' : ''}
                        </div>
                    `;
                });

                // Graphique activit√©s
                this.renderActivityChart();
                
                // Graphique comparaison
                this.renderComparisonChart();
            },

            renderActivityChart() {
                const ctx = document.getElementById('activityChart');
                if (!ctx) return;

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['M√©moires', 'Encadrements', 'Commentaires', 'Likes', 'T√©l√©chargements'],
                        datasets: [{
                            data: [
                                state.memoires.length,
                                state.encadrements.length,
                                state.comments.length,
                                state.likes.length,
                                state.telechargements.length
                            ],
                            backgroundColor: [
                                '#3b82f6',
                                '#10b981',
                                '#8b5cf6',
                                '#ef4444',
                                '#f59e0b'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            },

            renderComparisonChart() {
                const ctx = document.getElementById('comparisonChart');
                if (!ctx) return;

                // Calculer les moyennes
                const avgMemoires = state.topContributors.reduce((sum, c) => sum + c.nb_memoires, 0) / state.topContributors.length;
                const avgDl = state.topContributors.reduce((sum, c) => sum + c.nb_telechargements, 0) / state.topContributors.length;
                
                const totalDl = state.memoires.reduce((sum, m) => sum + m.nb_telechargements, 0);

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['M√©moires', 'T√©l√©chargements'],
                        datasets: [
                            {
                                label: 'Vous',
                                data: [state.memoires.length, totalDl],
                                backgroundColor: '#ffb606'
                            },
                            {
                                label: 'Moyenne',
                                data: [avgMemoires, avgDl],
                                backgroundColor: '#3a3a3a'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            },

            logout() {
                localStorage.removeItem('authToken');
                window.location.href = '/register.html';
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>