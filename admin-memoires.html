<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemoCloud Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: { yellow: '#ffb606', dark: '#3a3a3a', light: '#f5f7fa' }
            },
            animation: {
              'fade-in': 'fadeIn 0.4s ease-out',
              'slide-up': 'slideUp 0.4s ease-out',
              'slide-down': 'slideDown 0.3s ease-out',
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'bounce-subtle': 'bounceSubtle 2s infinite',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              slideUp: { '0%': { transform: 'translateY(30px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
              slideDown: { '0%': { transform: 'translateY(-20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
              bounceSubtle: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } }
            }
          }
        }
      }
    </script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
      
      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
        color: #3a3a3a;
        font-family: 'Inter', sans-serif;
      }
      
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
      ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; transition: background 0.3s; }
      ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

      .glass-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
      }
      
      .step-dot.active { 
        @apply bg-brand-yellow ring-4 ring-brand-yellow/30 scale-125;
        box-shadow: 0 0 20px rgba(255, 182, 6, 0.5);
      }
      .step-dot.completed { 
        @apply bg-green-500 ring-2 ring-green-300;
      }

      .compress-progress { transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

      @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
      }

      .shimmer {
        animation: shimmer 2s infinite;
        background: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
        background-size: 1000px 100%;
      }

      .card-hover {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .card-hover:hover {
        transform: translateY(-4px) scale(1.01);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
      }

      .gradient-border {
        position: relative;
        background: linear-gradient(white, white) padding-box,
                    linear-gradient(135deg, #ffb606, #ff8f00) border-box;
        border: 2px solid transparent;
      }

      @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
      }

      .float-animation {
        animation: float 3s ease-in-out infinite;
      }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="app" class="flex-1 flex flex-col">
        <!-- Enhanced Loading Spinner -->
        <div class="fixed inset-0 flex items-center justify-center bg-gradient-to-br from-brand-light via-white to-gray-100 z-50" id="initialLoader">
            <div class="flex flex-col items-center gap-6">
                <div class="relative">
                    <div class="w-24 h-24 border-4 border-brand-yellow/20 rounded-full"></div>
                    <div class="w-24 h-24 border-4 border-brand-yellow border-t-transparent rounded-full animate-spin absolute top-0"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <i class="fas fa-graduation-cap text-2xl text-brand-yellow animate-pulse"></i>
                    </div>
                </div>
                <div class="text-center">
                    <p class="text-brand-dark font-bold text-lg animate-pulse">Chargement de l'administration</p>
                    <p class="text-gray-500 text-sm mt-1">Préparation de votre espace...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Header Template -->
    <template id="header-template">
        <header class="bg-gradient-to-r from-brand-dark via-gray-900 to-brand-dark text-white shadow-2xl sticky top-0 z-40 backdrop-blur-sm">
            <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-brand-yellow to-yellow-500 flex items-center justify-center text-brand-dark font-bold text-2xl shadow-xl transform hover:scale-110 hover:rotate-3 transition-all duration-300">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-extrabold tracking-tight">Admin<span class="text-brand-yellow">Mémoires</span></h1>
                        <p class="text-xs text-gray-400 font-medium">Gestion intelligente</p>
                    </div>
                </div>
                <div class="flex items-center gap-4 bg-white/10 backdrop-blur-md px-5 py-2.5 rounded-full border border-white/20 hover:bg-white/15 transition-all">
                    <div class="flex flex-col items-end">
                        <span class="text-sm font-bold text-brand-yellow" id="header-username">User</span>
                        <span class="text-[10px] text-gray-300 uppercase tracking-wider bg-black/40 px-2 py-0.5 rounded-full" id="header-role">Role</span>
                    </div>
                    <button onclick="app.logout()" class="text-gray-300 hover:text-white transition-all p-2.5 hover:bg-white/10 rounded-full hover:rotate-12 transform duration-300" title="Déconnexion">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>
    </template>

    <!-- Main Content Template -->
    <template id="main-template">
        <main class="flex-1 max-w-7xl w-full mx-auto px-4 py-6 sm:py-8 animate-fade-in">
            <!-- Enhanced Stats Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="bg-gradient-to-br from-white to-blue-50 p-5 rounded-2xl shadow-lg border border-blue-100 hover:shadow-xl transition-all duration-300 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Total</p>
                            <p class="text-3xl font-black text-brand-dark mt-1" id="stat-total">0</p>
                        </div>
                        <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform">
                            <i class="fas fa-book text-white text-2xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-white to-green-50 p-5 rounded-2xl shadow-lg border border-green-100 hover:shadow-xl transition-all duration-300 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Publics</p>
                            <p class="text-3xl font-black text-green-600 mt-1" id="stat-public">0</p>
                        </div>
                        <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform">
                            <i class="fas fa-globe text-white text-2xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-white to-red-50 p-5 rounded-2xl shadow-lg border border-red-100 hover:shadow-xl transition-all duration-300 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Confidentiels</p>
                            <p class="text-3xl font-black text-red-600 mt-1" id="stat-confidential">0</p>
                        </div>
                        <div class="w-14 h-14 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform">
                            <i class="fas fa-lock text-white text-2xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-white to-yellow-50 p-5 rounded-2xl shadow-lg border border-yellow-100 hover:shadow-xl transition-all duration-300 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Cette année</p>
                            <p class="text-3xl font-black text-brand-yellow mt-1" id="stat-year">0</p>
                        </div>
                        <div class="w-14 h-14 bg-gradient-to-br from-brand-yellow to-yellow-500 rounded-xl flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform">
                            <i class="fas fa-calendar text-white text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Controls -->
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8 bg-white p-5 rounded-2xl shadow-lg border border-gray-100">
                <div class="relative w-full md:w-96 group">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-brand-yellow transition-all pointer-events-none group-focus-within:scale-110"></i>
                    <input type="text" id="searchInput" placeholder="Rechercher par titre ou auteur..." 
                           class="w-full pl-12 pr-4 py-3.5 bg-gray-50 border-2 border-transparent rounded-xl focus:bg-white focus:border-brand-yellow focus:ring-0 transition-all outline-none text-sm font-medium hover:bg-gray-100"
                           onkeyup="app.handleSearch(this.value)">
                </div>
                <button onclick="app.openFormModal()" 
                        class="w-full md:w-auto px-7 py-3.5 bg-gradient-to-r from-brand-yellow via-yellow-500 to-brand-yellow text-brand-dark font-bold rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all flex items-center justify-center gap-2 whitespace-nowrap hover:scale-105 duration-300">
                    <i class="fas fa-plus-circle text-lg"></i> <span>Nouveau Mémoire</span>
                </button>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-24 text-gray-400 bg-white rounded-2xl border-2 border-dashed border-gray-200">
                <div class="w-32 h-32 bg-gradient-to-br from-gray-50 to-gray-100 rounded-full flex items-center justify-center mb-6 float-animation">
                    <i class="fas fa-folder-open text-6xl text-gray-300"></i>
                </div>
                <p class="text-xl font-bold text-gray-600 mb-2">Aucun mémoire trouvé</p>
                <p class="text-sm text-gray-400">Modifiez votre recherche ou ajoutez un nouveau mémoire</p>
            </div>

            <!-- Table (Desktop) -->
            <div id="desktopTable" class="hidden lg:block bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gradient-to-r from-gray-50 via-gray-100 to-gray-50 text-gray-600 uppercase text-xs font-black tracking-wider border-b-2 border-gray-200">
                            <tr>
                                <th class="px-6 py-5">Titre</th>
                                <th class="px-6 py-5">Auteur</th>
                                <th class="px-6 py-5">Année</th>
                                <th class="px-6 py-5">Statut</th>
                                <th class="px-6 py-5 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- Cards (Mobile/Tablet) -->
            <div id="mobileCards" class="lg:hidden grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
        </main>
    </template>

    <!-- Enhanced Modal Form -->
    <div id="formModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-md animate-fade-in overflow-y-auto">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-3xl my-8 flex flex-col max-h-[90vh] animate-slide-up">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-brand-dark via-gray-900 to-brand-dark text-white p-6 flex justify-between items-center shrink-0 rounded-t-3xl">
                <div>
                    <h2 class="text-2xl font-black" id="formTitle">Nouveau mémoire</h2>
                    <div class="flex gap-3 mt-4">
                        <div class="step-dot w-12 h-2 rounded-full bg-white/20 transition-all duration-500" id="step-dot-1"></div>
                        <div class="step-dot w-12 h-2 rounded-full bg-white/20 transition-all duration-500" id="step-dot-2"></div>
                        <div class="step-dot w-12 h-2 rounded-full bg-white/20 transition-all duration-500" id="step-dot-3"></div>
                    </div>
                </div>
                <button onclick="app.closeModal()" class="w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-all hover:rotate-90 duration-500 hover:scale-110">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Compression Progress -->
            <div id="compressionProgress" class="hidden bg-gradient-to-r from-brand-yellow/10 via-yellow-50 to-brand-yellow/10 p-5 border-b border-brand-yellow/30 animate-slide-down">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-brand-yellow/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-compress text-brand-yellow animate-pulse text-lg"></i>
                    </div>
                    <div class="flex-1">
                        <span class="text-sm font-bold text-brand-dark block" id="compressionText">Compression en cours...</span>
                        <p class="text-xs text-gray-600 mt-0.5" id="compressionDetails"></p>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner">
                    <div id="compressionBar" class="compress-progress bg-gradient-to-r from-brand-yellow via-yellow-400 to-brand-yellow h-3 rounded-full shadow-lg" style="width: 0%"></div>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto flex-1">
                <form id="memoireForm" onsubmit="return false;">
                    
                    <!-- STEP 1 -->
                    <div id="step-1" class="space-y-6">
                        <div class="form-group">
                            <label class="block text-sm font-bold text-brand-dark mb-2 flex items-center gap-2">
                                <i class="fas fa-heading text-brand-yellow"></i>
                                Titre du mémoire <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="titre" required class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-brand-yellow focus:ring-0 outline-none transition-all hover:border-gray-300 font-medium" placeholder="Titre complet du mémoire">
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-bold text-brand-dark mb-2 flex items-center gap-2">
                                <i class="fas fa-align-left text-brand-yellow"></i>
                                Résumé <span class="text-red-500">*</span>
                            </label>
                            <textarea name="resume" required class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-brand-yellow focus:ring-0 outline-none transition-all hover:border-gray-300 h-36 resize-none font-medium" placeholder="Description détaillée et complète du contenu du mémoire..."></textarea>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                            <div class="form-group">
                                <label class="block text-sm font-bold text-brand-dark mb-2 flex items-center gap-2">
                                    <i class="fas fa-calendar text-brand-yellow"></i>
                                    Année <span class="text-red-500">*</span>
                                </label>
                                <input type="number" name="annee" required min="2000" max="2100" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-brand-yellow focus:ring-0 outline-none transition-all hover:border-gray-300 font-bold text-lg">
                            </div>
                            <div class="form-group">
                                <input type="hidden" name="auteur_id" id="auteurIdInput">
                                <div id="author-select-container"></div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 2 -->
                    <div id="step-2" class="hidden space-y-6">
                        <div id="encadreurs-multiselect-container"></div>
                        <hr class="border-gray-200">
                        <div id="domaines-multiselect-container"></div>
                    </div>

                    <!-- STEP 3 -->
                    <div id="step-3" class="hidden space-y-6">
                        <div class="relative group">
                            <div class="p-10 border-3 border-dashed border-gray-300 rounded-2xl hover:border-brand-yellow hover:bg-gradient-to-br hover:from-brand-yellow/5 hover:to-yellow-50 transition-all cursor-pointer relative overflow-hidden">
                                <input type="file" name="fichier_pdf" id="pdfInput" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="app.handleFileSelect(this, 'pdfLabel')">
                                <div class="text-center pointer-events-none">
                                    <div class="w-20 h-20 mx-auto mb-5 bg-gradient-to-br from-red-50 to-red-100 rounded-2xl flex items-center justify-center group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 shadow-lg">
                                        <i class="fas fa-file-pdf text-4xl text-red-500"></i>
                                    </div>
                                    <p class="font-black text-brand-dark mb-2 text-lg">Fichier PDF du mémoire</p>
                                    <p class="text-sm text-gray-600 font-medium" id="pdfLabel">Glisser-déposer ou cliquer pour sélectionner</p>
                                    <p class="text-xs text-brand-yellow mt-3 font-semibold">✨ Compression automatique ultra-optimisée</p>
                                </div>
                            </div>
                        </div>

                        <div class="relative group">
                            <div class="p-10 border-3 border-dashed border-gray-300 rounded-2xl hover:border-brand-yellow hover:bg-gradient-to-br hover:from-brand-yellow/5 hover:to-yellow-50 transition-all cursor-pointer relative overflow-hidden">
                                <input type="file" name="images" id="imgInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="app.handleFileSelect(this, 'imgLabel')">
                                <div class="text-center pointer-events-none">
                                    <div class="w-20 h-20 mx-auto mb-5 bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl flex items-center justify-center group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 shadow-lg">
                                        <i class="fas fa-image text-4xl text-blue-500"></i>
                                    </div>
                                    <p class="font-black text-brand-dark mb-2 text-lg">Image de couverture</p>
                                    <p class="text-sm text-gray-600 font-medium" id="imgLabel">Optionnel - Format JPG, PNG</p>
                                    <p class="text-xs text-brand-yellow mt-3 font-semibold">✨ Optimisation automatique de l'image</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </form>
            </div>

            <!-- Modal Footer -->
            <div class="p-5 bg-gradient-to-r from-gray-50 to-gray-100 border-t border-gray-200 flex justify-between shrink-0 rounded-b-3xl">
                <button id="btnPrev" onclick="app.prevStep()" class="px-7 py-3 rounded-xl text-gray-600 font-bold hover:bg-white disabled:opacity-30 disabled:cursor-not-allowed transition-all flex items-center gap-2 hover:shadow-md" disabled>
                    <i class="fas fa-arrow-left text-sm"></i> Précédent
                </button>
                <button id="btnNext" onclick="app.nextStep()" class="px-7 py-3 rounded-xl bg-gradient-to-r from-brand-yellow to-yellow-500 text-brand-dark font-bold hover:shadow-xl transition-all flex items-center gap-2 hover:scale-105">
                    Suivant <i class="fas fa-arrow-right text-sm"></i>
                </button>
                <button id="btnSave" onclick="app.submitForm()" class="hidden px-7 py-3 rounded-xl bg-gradient-to-r from-green-600 to-green-700 text-white font-bold hover:from-green-700 hover:to-green-800 shadow-xl transition-all flex items-center gap-2 hover:scale-105">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-md animate-fade-in overflow-y-auto">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-5xl my-8 overflow-hidden animate-slide-up">
            <button onclick="document.getElementById('detailModal').classList.add('hidden')" class="absolute top-6 right-6 z-10 w-14 h-14 bg-white hover:bg-gray-100 rounded-full shadow-2xl flex items-center justify-center text-gray-600 hover:text-red-500 transition-all hover:rotate-90 duration-500 hover:scale-110">
                <i class="fas fa-times text-xl font-bold"></i>
            </button>
            
            <div id="detailContent"></div>
        </div>
    </div>

    <script>
        const CONFIG = {
            API_URL: 'https://mcb.reimca-app.com/api',
            UNIV_SLUG: 'ecole-des-travaux',
            ALLOWED_ROLES: ['admin', 'superadmin', 'bigboss']
        };

        const state = {
            currentUser: null,
            users: [],
            domaines: [],
            memoires: [],
            filteredMemoires: [],
            currentStep: 1,
            editingId: null,
            initialData: null,
            form: { encadreurs: [], domaines: [] }
        };

        /* ===== COMPRESSION UTILITIES ===== */
        
        async function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth || height > maxWidth) {
                            if (width > height) {
                                height = (height / width) * maxWidth;
                                width = maxWidth;
                            } else {
                                width = (width / height) * maxWidth;
                                height = maxWidth;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob(blob => {
                            if (!blob) {
                                reject(new Error('Compression échouée'));
                                return;
                            }
                            
                            if (blob.size > 300 * 1024) {
                                canvas.toBlob(resolve, 'image/jpeg', quality * 0.5);
                            } else {
                                resolve(blob);
                            }
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function compressPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                
                // Remove metadata
                pdfDoc.setTitle('');
                pdfDoc.setSubject('');
                pdfDoc.setKeywords([]);
                pdfDoc.setProducer('');
                pdfDoc.setCreator('');
                
                const bytes = await pdfDoc.save({
                    useObjectStreams: true,
                    addDefaultPage: false,
                    objectsPerTick: 50
                });
                
                return new Blob([bytes], { type: 'application/pdf' });
            } catch (error) {
                console.error('Erreur compression PDF:', error);
                return file;
            }
        }

        function showCompressionProgress(show = true, text = '', progress = 0, details = '') {
            const progressDiv = document.getElementById('compressionProgress');
            const progressBar = document.getElementById('compressionBar');
            const progressText = document.getElementById('compressionText');
            const progressDetails = document.getElementById('compressionDetails');
            
            if (show) {
                progressDiv.classList.remove('hidden');
                progressText.textContent = text;
                progressBar.style.width = progress + '%';
                progressDetails.textContent = details;
            } else {
                progressDiv.classList.add('hidden');
            }
        }

        function updateStats() {
            const total = state.memoires.length;
            const publics = state.memoires.filter(m => !m.est_confidentiel).length;
            const confidential = state.memoires.filter(m => m.est_confidentiel).length;
            const currentYear = new Date().getFullYear();
            const thisYear = state.memoires.filter(m => m.annee === currentYear).length;
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-public').textContent = publics;
            document.getElementById('stat-confidential').textContent = confidential;
            document.getElementById('stat-year').textContent = thisYear;
        }

        /* ===== MULTI-SELECT COMPONENT ===== */
        
        class MultiSelect {
            constructor(containerId, label, items, selectedValues, onChange, valueKey = 'id', labelKey = 'nom') {
                this.container = document.getElementById(containerId);
                this.items = items;
                this.selected = new Set(selectedValues);
                this.onChange = onChange;
                this.valueKey = valueKey;
                this.labelKey = labelKey;
                this.label = label;
                this.filter = '';
                this.render();
            }

            render() {
                const filtered = this.items.filter(item => 
                    (item[this.labelKey] || item.full_name || '').toLowerCase().includes(this.filter.toLowerCase())
                );

                this.container.innerHTML = `
                    <div class="flex flex-col gap-3">
                        <label class="text-sm font-bold text-brand-dark flex items-center gap-2">
                            <i class="fas fa-users text-brand-yellow"></i>
                            ${this.label}
                        </label>
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-3.5 text-gray-400 pointer-events-none"></i>
                            <input type="text" placeholder="Rechercher..." class="ms-search w-full pl-10 pr-4 py-3 rounded-xl border-2 border-gray-200 focus:border-brand-yellow outline-none transition-all text-sm font-medium hover:border-gray-300" value="${this.filter}">
                        </div>
                        <div class="h-52 overflow-y-auto border-2 border-gray-200 rounded-xl p-2 space-y-1.5 bg-gray-50">
                            ${filtered.map(item => {
                                const val = item[this.valueKey];
                                const isActive = this.selected.has(val);
                                const label = item.full_name || item[this.labelKey];
                                return `
                                    <div class="ms-option cursor-pointer px-4 py-3 rounded-lg flex items-center justify-between transition-all ${isActive ? 'bg-gradient-to-r from-brand-yellow to-yellow-500 text-brand-dark font-bold shadow-md transform scale-105' : 'bg-white hover:bg-gray-100'}" data-val="${val}">
                                        <span class="text-sm">${label}</span>
                                        ${isActive ? '<i class="fas fa-check-circle text-lg"></i>' : ''}
                                    </div>
                                `;
                            }).join('')}
                            ${filtered.length === 0 ? '<div class="text-center text-gray-400 text-sm py-12">Aucun résultat</div>' : ''}
                        </div>
                        <div class="flex flex-wrap gap-2 min-h-[36px] bg-white p-3 rounded-xl border-2 border-gray-200">
                            ${Array.from(this.selected).length === 0 ? '<span class="text-gray-400 text-sm italic">Aucune sélection</span>' : ''}
                            ${Array.from(this.selected).map(val => {
                                const item = this.items.find(i => i[this.valueKey] == val);
                                if(!item) return '';
                                return `
                                    <span class="inline-flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-brand-dark to-gray-800 text-white text-xs rounded-full animate-fade-in font-semibold shadow-md hover:shadow-lg transition-all">
                                        ${item.full_name || item[this.labelKey]}
                                        <button type="button" class="ms-remove hover:text-brand-yellow hover:scale-125 transition-all" data-val="${val}">
                                            <i class="fas fa-times-circle"></i>
                                        </button>
                                    </span>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;

                const searchInput = this.container.querySelector('.ms-search');
                searchInput.addEventListener('input', (e) => {
                    this.filter = e.target.value;
                    this.render(); 
                    this.container.querySelector('.ms-search').focus();
                });

                this.container.querySelectorAll('.ms-option').forEach(el => {
                    el.addEventListener('click', () => {
                        const val = el.dataset.val;
                        const parsedVal = isNaN(val) ? val : Number(val);
                        
                        if(this.selected.has(parsedVal)) this.selected.delete(parsedVal);
                        else this.selected.add(parsedVal);
                        this.onChange(Array.from(this.selected));
                        this.render();
                        this.container.querySelector('.ms-search').focus();
                    });
                });

                this.container.querySelectorAll('.ms-remove').forEach(el => {
                    el.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        const val = el.dataset.val;
                        const parsedVal = isNaN(val) ? val : Number(val);
                        this.selected.delete(parsedVal);
                        this.onChange(Array.from(this.selected));
                        this.render();
                    });
                });
            }
        }

        /* ===== SEARCHABLE SELECT ===== */
        
        class SearchableSelect {
            constructor(containerId, label, items, selectedValue, onChange) {
                this.container = document.getElementById(containerId);
                this.label = label;
                this.items = items || [];
                this.value = selectedValue; 
                this.onChange = onChange;
                this.filter = '';
                this.isOpen = false;
                this.render();
                
                document.addEventListener('click', (e) => {
                    if (!document.body.contains(this.container)) return;
                    if (this.container && !this.container.contains(e.target)) {
                        if(this.isOpen) {
                            this.isOpen = false;
                            this.render();
                        }
                    }
                });
            }

            render() {
                const selectedItem = this.items.find(i => String(i.id) === String(this.value));
                const filtered = this.items.filter(i => {
                    const txt = (i.label || i.nom || i.full_name || '').toLowerCase();
                    return txt.includes(this.filter.toLowerCase());
                });

                this.container.innerHTML = `
                    <label class="block text-sm font-bold text-brand-dark mb-2 flex items-center gap-2">
                        <i class="fas fa-user text-brand-yellow"></i>
                        ${this.label} <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <div class="ss-trigger w-full p-4 border-2 ${this.isOpen ? 'border-brand-yellow shadow-lg' : 'border-gray-200'} rounded-xl bg-white flex items-center justify-between cursor-pointer transition-all hover:border-gray-300">
                            <span class="${selectedItem ? 'text-brand-dark font-bold' : 'text-gray-400'}">
                                ${selectedItem ? (selectedItem.label || selectedItem.full_name || selectedItem.nom) : 'Sélectionner un auteur...'}
                            </span>
                            <i class="fas fa-chevron-${this.isOpen ? 'up' : 'down'} text-gray-400 transition-transform"></i>
                        </div>

                        ${this.isOpen ? `
                        <div class="absolute z-20 w-full mt-2 bg-white border-2 border-brand-yellow rounded-xl shadow-2xl max-h-64 overflow-hidden flex flex-col animate-slide-down">
                            <div class="p-3 border-b border-gray-100 bg-gradient-to-r from-yellow-50 to-brand-yellow/10">
                                <input type="text" class="ss-search w-full p-2.5 bg-white rounded-lg border-2 border-gray-200 focus:border-brand-yellow outline-none text-sm font-medium" placeholder="Rechercher..." value="${this.filter}">
                            </div>
                            <div class="overflow-y-auto flex-1">
                                ${filtered.map(item => `
                                    <div class="ss-option px-4 py-3 hover:bg-gradient-to-r hover:from-brand-yellow/10 hover:to-yellow-50 cursor-pointer text-sm transition-all ${String(item.id) === String(this.value) ? 'bg-brand-yellow/20 font-bold text-brand-dark border-l-4 border-brand-yellow' : 'text-gray-600'}" data-val="${item.id}">
                                        <i class="fas fa-user-circle text-gray-400 mr-2"></i>
                                        ${item.label || item.full_name || item.nom}
                                    </div>
                                `).join('')}
                                ${filtered.length === 0 ? '<div class="p-8 text-center text-gray-400 text-sm italic">Aucun résultat trouvé</div>' : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;

                const trigger = this.container.querySelector('.ss-trigger');
                if (trigger) trigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.isOpen = !this.isOpen;
                    this.filter = ''; 
                    this.render();
                    if (this.isOpen) {
                        setTimeout(() => {
                            const inp = this.container.querySelector('.ss-search');
                            if(inp) inp.focus();
                        }, 100);
                    }
                });

                if (this.isOpen) {
                    const inp = this.container.querySelector('.ss-search');
                    if (inp) {
                        inp.addEventListener('input', (e) => {
                            this.filter = e.target.value;
                            this.render();
                            setTimeout(() => {
                                const searchInput = this.container.querySelector('.ss-search');
                                if(searchInput) searchInput.focus();
                            }, 0);
                        });
                        inp.addEventListener('click', e => e.stopPropagation());
                    }

                    this.container.querySelectorAll('.ss-option').forEach(opt => {
                        opt.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.value = opt.dataset.val;
                            this.isOpen = false;
                            this.onChange(this.value);
                            this.render();
                        });
                    });
                }
            }
        }

        /* ===== MAIN APP ===== */
        
        const app = {
            async init() {
                window.scrollTo({ top: 0, behavior: 'instant' });
                
                const token = localStorage.getItem('authToken');
                console.log(token)
                if (!token) return this.redirectLogin();

                try {
                    await this.loadCurrentUser(token);
                    await this.loadData(token);
                    this.renderApp();
                } catch (e) {
                    console.error(e);
                    alert("Erreur d'authentification ou de connexion");
                    this.redirectLogin();
                }
            },

            redirectLogin() {
                window.location.href = '/register.html';
            },

            async loadCurrentUser(token) {
                const resMe = await fetch(`${CONFIG.API_URL}/auth/me/`, { 
                    headers: { 'Authorization': `Bearer ${token}` } 
                });
                if (!resMe.ok) throw new Error('User fetch failed');
                state.currentUser = await resMe.json();

                const resRole = await fetch(`${CONFIG.API_URL}/universites/auth/${CONFIG.UNIV_SLUG}/my-role/`, { 
                    headers: { 'Authorization': `Bearer ${token}` } 
                });
                if (!resRole.ok) throw new Error('Role fetch failed');
                const roleData = await resRole.json();

                if (!CONFIG.ALLOWED_ROLES.includes(roleData.role)) {
                    document.body.innerHTML = `
                        <div class="h-screen flex flex-col items-center justify-center bg-gradient-to-br from-red-50 to-red-100 text-center p-4">
                            <i class="fas fa-shield-alt text-red-500 text-8xl mb-6 animate-bounce-subtle"></i>
                            <h1 class="text-3xl font-black text-brand-dark mb-2">Accès Interdit</h1>
                            <p class="text-gray-600 mt-2 text-lg">Vous n'avez pas les droits administrateur requis.</p>
                            <button onclick="app.logout()" class="mt-6 px-8 py-3 bg-brand-dark text-white rounded-xl font-bold hover:bg-black shadow-lg hover:shadow-xl transition-all">Déconnexion</button>
                        </div>
                    `;
                    throw new Error('Forbidden');
                }
                state.currentUser.role = roleData.role;
            },

            async loadData(token) {
                const headers = { 'Authorization': `Bearer ${token}` };
                
                const [usersRes, domainesRes, memoiresRes] = await Promise.all([
                    fetch(`${CONFIG.API_URL}/auth/${CONFIG.UNIV_SLUG}/users/?ordering=-id`, { headers }),
                    fetch(`${CONFIG.API_URL}/universites/domaines/`, { headers }),
                    fetch(`${CONFIG.API_URL}/memoires/universites/${CONFIG.UNIV_SLUG}/memoires/`, { headers })
                ]);

                const rawUsers = await usersRes.json();
                state.users = rawUsers.map(u => ({
                    ...u,
                    label: u.full_name || `${u.prenom} ${u.nom}` || u.email
                }));

                const rawDomaines = await domainesRes.json();
                state.domaines = rawDomaines.map(d => ({
                    ...d,
                    label: d.nom || d.name || d.label || d.slug
                }));

                state.memoires = await memoiresRes.json();
                state.filteredMemoires = state.memoires;
            },

            renderApp() {
                document.getElementById('initialLoader').remove();
                
                const headerTmpl = document.getElementById('header-template').content.cloneNode(true);
                headerTmpl.querySelector('#header-username').textContent = state.currentUser.full_name || state.currentUser.nom;
                headerTmpl.querySelector('#header-role').textContent = state.currentUser.role;
                document.getElementById('app').appendChild(headerTmpl);

                const mainTmpl = document.getElementById('main-template').content.cloneNode(true);
                document.getElementById('app').appendChild(mainTmpl);

                updateStats();
                this.renderMemoiresList();
            },

            renderMemoiresList() {
                const tbody = document.getElementById('tableBody');
                const mobileContainer = document.getElementById('mobileCards');
                const emptyState = document.getElementById('emptyState');
                const desktopTable = document.getElementById('desktopTable');

                tbody.innerHTML = '';
                mobileContainer.innerHTML = '';

                if (state.filteredMemoires.length === 0) {
                    emptyState.classList.remove('hidden');
                    desktopTable.classList.add('hidden');
                    return;
                } else {
                    emptyState.classList.add('hidden');
                    desktopTable.classList.remove('hidden');
                }

                state.filteredMemoires.forEach(m => {
                    const statusClass = m.est_confidentiel ? 'bg-gradient-to-r from-red-500 to-red-600 text-white' : 'bg-gradient-to-r from-green-500 to-green-600 text-white';
                    const statusText = m.est_confidentiel ? 'Confidentiel' : 'Public';
                    const statusIcon = m.est_confidentiel ? 'fa-lock' : 'fa-globe';
                    const authorName = m.auteur ? (m.auteur.nom || m.auteur.full_name) : 'Inconnu';
                    
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gradient-to-r hover:from-yellow-50 hover:to-orange-50 transition-all duration-300 border-b border-gray-100 last:border-0 group';
                    tr.innerHTML = `
                        <td class="px-6 py-5">
                            <div class="font-bold text-brand-dark group-hover:text-brand-yellow transition-colors">${m.titre}</div>
                        </td>
                        <td class="px-6 py-5">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-user-circle text-gray-400"></i>
                                <span class="text-gray-600 font-medium">${authorName}</span>
                            </div>
                        </td>
                        <td class="px-6 py-5">
                            <span class="font-mono text-gray-500 font-bold bg-gray-100 px-3 py-1 rounded-lg">${m.annee}</span>
                        </td>
                        <td class="px-6 py-5">
                            <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold ${statusClass} shadow-md">
                                <i class="fas ${statusIcon}"></i> ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-5 text-right">
                            <div class="flex justify-end gap-2">
                                <button onclick="app.viewDetails(${m.id})" class="w-9 h-9 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-500 hover:text-white flex items-center justify-center transition-all transform hover:scale-110 shadow-sm hover:shadow-md" title="Voir détails">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="app.editMemoire(${m.id})" class="w-9 h-9 rounded-lg bg-yellow-50 text-brand-yellow hover:bg-brand-yellow hover:text-brand-dark flex items-center justify-center transition-all transform hover:scale-110 shadow-sm hover:shadow-md" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="app.deleteMemoire(${m.id})" class="w-9 h-9 rounded-lg bg-red-50 text-red-600 hover:bg-red-500 hover:text-white flex items-center justify-center transition-all transform hover:scale-110 shadow-sm hover:shadow-md" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);

                    const card = document.createElement('div');
                    card.className = 'bg-white p-6 rounded-2xl shadow-md border border-gray-100 card-hover';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold ${statusClass} shadow-md">
                                <i class="fas ${statusIcon}"></i> ${statusText}
                            </span>
                            <span class="font-mono text-xs text-gray-400 bg-gray-100 px-3 py-1 rounded-lg font-bold">${m.annee}</span>
                        </div>
                        <h3 class="font-bold text-brand-dark mb-2 text-lg">${m.titre}</h3>
                        <p class="text-sm text-gray-500 mb-4 flex items-center gap-2">
                            <i class="fas fa-user-circle"></i> Par ${authorName}
                        </p>
                        <div class="flex justify-end gap-2 border-t border-gray-100 pt-4">
                            <button onclick="app.viewDetails(${m.id})" class="p-3 text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-500 hover:text-white transition-all transform hover:scale-110"><i class="fas fa-eye"></i></button>
                            <button onclick="app.editMemoire(${m.id})" class="p-3 text-brand-yellow bg-yellow-50 rounded-lg hover:bg-brand-yellow hover:text-brand-dark transition-all transform hover:scale-110"><i class="fas fa-edit"></i></button>
                            <button onclick="app.deleteMemoire(${m.id})" class="p-3 text-red-600 bg-red-50 rounded-lg hover:bg-red-500 hover:text-white transition-all transform hover:scale-110"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    mobileContainer.appendChild(card);
                });
            },

            handleSearch(query) {
                const lower = query.toLowerCase();
                state.filteredMemoires = state.memoires.filter(m => 
                    m.titre.toLowerCase().includes(lower) || 
                    (m.auteur?.nom || '').toLowerCase().includes(lower) ||
                    (m.auteur?.full_name || '').toLowerCase().includes(lower)
                );
                this.renderMemoiresList();
            },

            logout() {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userRole');
                window.location.reload();
            },

            openFormModal(id = null) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                state.editingId = id;
                state.currentStep = 1;
                state.form = { encadreurs: [], domaines: [] };
                
                const form = document.getElementById('memoireForm');
                form.reset();
                document.getElementById('auteurIdInput').value = "";

                let selectedAuthorId = "";

                if (id) {
                    document.getElementById('formTitle').textContent = 'Modifier le mémoire';
                    const m = state.memoires.find(i => i.id === id);
                    if(!m) return;
                    
                    state.initialData = m;
                    form.titre.value = m.titre;
                    form.resume.value = m.resume;
                    form.annee.value = m.annee;
                    
                    if (m.auteur) {
                        selectedAuthorId = m.auteur.id;
                        document.getElementById('auteurIdInput').value = selectedAuthorId;
                    }
                    
                    state.form.encadreurs = m.encadreurs.map(e => e.id);
                    state.form.domaines = m.domaines_list;
                } else {
                    document.getElementById('formTitle').textContent = 'Nouveau mémoire';
                    form.annee.value = new Date().getFullYear();
                    state.initialData = null;
                }

                new SearchableSelect('author-select-container', 'Auteur', state.users, selectedAuthorId, (val) => {
                    document.getElementById('auteurIdInput').value = val;
                });

                new MultiSelect('encadreurs-multiselect-container', "Encadreurs", state.users, state.form.encadreurs, (vals) => state.form.encadreurs = vals);
                new MultiSelect('domaines-multiselect-container', "Domaines", state.domaines, state.form.domaines, (vals) => state.form.domaines = vals, 'slug', 'nom');

                this.updateStepUI();
                document.getElementById('formModal').classList.remove('hidden');
                document.getElementById('formModal').classList.add('flex');
            },

            closeModal() {
                document.getElementById('formModal').classList.add('hidden');
                document.getElementById('formModal').classList.remove('flex');
                showCompressionProgress(false);
            },

            updateStepUI() {
                [1, 2, 3].forEach(s => {
                    document.getElementById(`step-${s}`).classList.add('hidden');
                    const dot = document.getElementById(`step-dot-${s}`);
                    dot.classList.remove('active', 'completed', 'bg-brand-yellow', 'bg-green-500');
                    dot.classList.add('bg-white/20');
                });

                document.getElementById(`step-${state.currentStep}`).classList.remove('hidden');

                for(let i=1; i<=3; i++) {
                    const dot = document.getElementById(`step-dot-${i}`);
                    if(i < state.currentStep) {
                        dot.classList.remove('bg-white/20');
                        dot.classList.add('completed');
                    } else if (i === state.currentStep) {
                        dot.classList.remove('bg-white/20');
                        dot.classList.add('active');
                    }
                }

                const btnPrev = document.getElementById('btnPrev');
                const btnNext = document.getElementById('btnNext');
                const btnSave = document.getElementById('btnSave');

                btnPrev.disabled = state.currentStep === 1;
                
                if (state.currentStep === 3) {
                    btnNext.classList.add('hidden');
                    btnSave.classList.remove('hidden');
                } else {
                    btnNext.classList.remove('hidden');
                    btnSave.classList.add('hidden');
                }
            },

            nextStep() {
                const form = document.getElementById('memoireForm');
                if (state.currentStep === 1) {
                    const authId = document.getElementById('auteurIdInput').value;
                    if (!form.titre.value || !form.resume.value || !form.annee.value || !authId) {
                        alert("⚠️ Veuillez remplir tous les champs obligatoires");
                        return;
                    }
                }
                if (state.currentStep < 3) {
                    state.currentStep++;
                    this.updateStepUI();
                }
            },

            prevStep() {
                if (state.currentStep > 1) {
                    state.currentStep--;
                    this.updateStepUI();
                }
            },

            async handleFileSelect(input, labelId) {
                const label = document.getElementById(labelId);
                const file = input.files?.[0];
                if (!file) return;

                try {
                    const originalSize = (file.size / 1024 / 1024).toFixed(2);
                    label.textContent = `⏳ Compression en cours... (${originalSize} Mo)`;
                    
                    showCompressionProgress(true, `Compression de ${file.name}...`, 20, `Taille originale: ${originalSize} Mo`);

                    let compressedBlob;
                    let compressedFile;

                    if (file.type.startsWith('image/')) {
                        showCompressionProgress(true, 'Optimisation de l\'image...', 50, 'Réduction de la résolution et qualité');
                        compressedBlob = await compressImage(file);
                        compressedFile = new File([compressedBlob], file.name.replace(/\.\w+$/, '.jpg'), {
                            type: 'image/jpeg'
                        });
                    } else if (file.type === 'application/pdf') {
                        showCompressionProgress(true, 'Compression du PDF...', 50, 'Suppression des métadonnées et optimisation');
                        compressedBlob = await compressPDF(file);
                        compressedFile = new File([compressedBlob], file.name, {
                            type: 'application/pdf'
                        });
                    } else {
                        compressedFile = file;
                    }

                    const compressedSize = (compressedFile.size / 1024 / 1024).toFixed(2);
                    const reduction = ((1 - compressedFile.size / file.size) * 100).toFixed(1);

                    showCompressionProgress(true, '✅ Compression terminée !', 100, `${compressedSize} Mo (${reduction}% de réduction)`);

                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(compressedFile);
                    input.files = dataTransfer.files;

                    label.textContent = `✅ ${file.name.substring(0, 30)}... - ${compressedSize} Mo (↓${reduction}%)`;
                    label.classList.add('text-green-600', 'font-bold');

                    setTimeout(() => {
                        showCompressionProgress(false);
                    }, 2000);

                } catch (error) {
                    console.error('Erreur de compression :', error);
                    label.textContent = '⚠️ Erreur de compression';
                    label.classList.add('text-red-600', 'font-bold');
                    showCompressionProgress(false);
                }
            },

            async submitForm() {
                const btn = document.getElementById('btnSave');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Enregistrement...';

                try {
                    const form = document.getElementById('memoireForm');
                    const formData = new FormData(form);
                    
                    state.form.encadreurs.forEach(id => formData.append('encadreurs_ids', id));
                    state.form.domaines.forEach(slug => formData.append('domaines_slugs', slug));

                    const token = localStorage.getItem('authToken');
                    const headers = { 'Authorization': `Bearer ${token}` };

                    if (state.editingId && state.initialData) {
                        const init = state.initialData;
                        const eq = (a, b) => String(a).trim() === String(b).trim();
                        
                        if (eq(formData.get('titre'), init.titre)) formData.delete('titre');
                        if (eq(formData.get('resume'), init.resume)) formData.delete('resume');
                        if (eq(formData.get('annee'), init.annee)) formData.delete('annee');
                        if (eq(formData.get('auteur_id'), init.auteur?.id)) formData.delete('auteur_id');
                        
                        const initEnc = init.encadreurs.map(e=>e.id).sort().join(',');
                        const newEnc = state.form.encadreurs.sort().join(',');
                        if (initEnc === newEnc) formData.delete('encadreurs_ids');

                        const initDom = (init.domaines_list || []).sort().join(',');
                        const newDom = state.form.domaines.sort().join(',');
                        if (initDom === newDom) formData.delete('domaines_slugs');

                        if (!formData.get('fichier_pdf')?.size) formData.delete('fichier_pdf');
                        if (!formData.get('images')?.size) formData.delete('images');
                        
                        const res = await fetch(`${CONFIG.API_URL}/memoires/universites/${CONFIG.UNIV_SLUG}/memoires/${state.editingId}/`, {
                            method: 'PATCH',
                            headers: headers,
                            body: formData
                        });
                        if (!res.ok) throw new Error(await res.text());

                    } else {
                        const res = await fetch(`${CONFIG.API_URL}/memoires/universites/${CONFIG.UNIV_SLUG}/memoires/`, {
                            method: 'POST',
                            headers: headers,
                            body: formData
                        });
                        if (!res.ok) throw new Error(await res.text());
                    }

                    await this.loadData(token);
                    updateStats();
                    this.renderMemoiresList();
                    this.closeModal();
                    
                    const successMsg = document.createElement('div');
                    successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-xl shadow-2xl animate-slide-down z-50';
                    successMsg.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Mémoire enregistré avec succès !';
                    document.body.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 3000);
                    
                } catch (e) {
                    alert("❌ Erreur: " + e.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            },

            async deleteMemoire(id) {
                if(!confirm("⚠️ Supprimer définitivement ce mémoire ? Cette action est irréversible.")) return;
                
                try {
                    const controller = new AbortController();
                    setTimeout(() => controller.abort(), 120_000); // 2 min
                    const token = localStorage.getItem('authToken');
                    const res = await fetch(`${CONFIG.API_URL}/memoires/universites/${CONFIG.UNIV_SLUG}/memoires/${id}/suppression-totale/`, {
                        method: 'DELETE',
                         signal: controller.signal,
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if(!res.ok) throw new Error(await res.text());
                    
                    state.memoires = state.memoires.filter(m => m.id !== id);
                    state.filteredMemoires = state.filteredMemoires.filter(m => m.id !== id);
                    updateStats();
                    this.renderMemoiresList();
                    
                    const successMsg = document.createElement('div');
                    successMsg.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-xl shadow-2xl animate-slide-down z-50';
                    successMsg.innerHTML = '<i class="fas fa-trash mr-2"></i> Mémoire supprimé avec succès';
                    document.body.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 3000);
                } catch(e) {
                    alert("❌ Erreur: " + e.message);
                }
            },

            async viewDetails(id) {
                const m = state.memoires.find(i => i.id === id);
                if(!m) return;
                
                const container = document.getElementById('detailContent');
                
                try {
                    const token = localStorage.getItem('authToken');
                    const res = await fetch(`${CONFIG.API_URL}/memoires/universites/${CONFIG.UNIV_SLUG}/memoires/${id}/`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const fullM = await res.json();
                    
                    container.innerHTML = `
                        <div class="h-64 bg-gradient-to-br from-gray-100 to-gray-200 w-full overflow-hidden relative">
                             ${fullM.images ? `<img src="${fullM.images}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-brand-dark to-gray-900 text-white/20"><i class="fas fa-book text-8xl"></i></div>'}
                             <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent flex items-end p-8">
                                <div>
                                    <h2 class="text-white text-3xl font-black drop-shadow-2xl mb-2">${fullM.titre}</h2>
                                    <p class="text-white/90 text-sm font-medium"><i class="fas fa-calendar-alt mr-2"></i>Année ${fullM.annee}</p>
                                </div>
                             </div>
                        </div>

                        <div class="p-8 space-y-8">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl text-center border border-blue-200">
                                    <p class="text-xs text-blue-600 uppercase font-bold mb-1">Année</p>
                                    <p class="font-mono font-black text-2xl text-blue-700">${fullM.annee}</p>
                                </div>
                                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-4 rounded-xl text-center border border-yellow-200">
                                    <p class="text-xs text-yellow-600 uppercase font-bold mb-1">Note</p>
                                    <p class="font-black text-2xl text-yellow-700">${fullM.note_moyenne || '-'}<span class="text-sm">/5</span></p>
                                </div>
                                <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl text-center border border-green-200">
                                    <p class="text-xs text-green-600 uppercase font-bold mb-1">Téléchargements</p>
                                    <p class="font-black text-2xl text-green-700">${fullM.nb_telechargements || 0}</p>
                                </div>
                                <div class="bg-gradient-to-br from-pink-50 to-pink-100 p-4 rounded-xl text-center border border-pink-200">
                                    <p class="text-xs text-pink-600 uppercase font-bold mb-1">Likes</p>
                                    <p class="font-black text-2xl text-pink-700">${fullM.nb_likes || 0}</p>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-sm font-black text-gray-400 uppercase mb-3 flex items-center gap-2">
                                    <i class="fas fa-align-left text-brand-yellow"></i> Résumé
                                </h3>
                                <div class="bg-gradient-to-br from-yellow-50 to-orange-50 p-6 rounded-2xl border-l-4 border-brand-yellow text-gray-700 leading-relaxed shadow-sm">
                                    ${fullM.resume}
                                </div>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-8">
                                <div>
                                    <h3 class="text-sm font-black text-gray-400 uppercase mb-4 flex items-center gap-2">
                                        <i class="fas fa-user text-brand-yellow"></i> Auteur
                                    </h3>
                                    <div class="flex items-center gap-4 bg-gradient-to-r from-gray-50 to-gray-100 p-4 rounded-xl border border-gray-200">
                                        <div class="w-14 h-14 rounded-full bg-gradient-to-br from-brand-dark to-gray-800 text-white flex items-center justify-center font-black text-xl shadow-lg">
                                            ${(fullM.auteur?.nom || 'U').charAt(0).toUpperCase()}
                                        </div>
                                        <div>
                                            <p class="font-bold text-brand-dark text-lg">${fullM.auteur?.nom || fullM.auteur?.full_name || 'Inconnu'}</p>
                                            <p class="text-xs text-gray-500 font-semibold uppercase">Étudiant</p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="text-sm font-black text-gray-400 uppercase mb-4 flex items-center gap-2">
                                        <i class="fas fa-users text-brand-yellow"></i> Encadreurs
                                    </h3>
                                    <div class="flex flex-wrap gap-2">
                                        ${fullM.encadreurs && fullM.encadreurs.length > 0 ? fullM.encadreurs.map(e => `
                                            <span class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 rounded-xl text-sm text-blue-700 font-semibold shadow-sm">
                                                <i class="fas fa-user-tie"></i> ${e.full_name || e.nom}
                                            </span>
                                        `).join('') : '<span class="text-gray-400 italic text-sm">Aucun encadreur</span>'}
                                    </div>
                                </div>
                            </div>

                            <div class="pt-6 border-t-2 border-gray-200 flex gap-4">
                                ${fullM.pdf_url ? `
                                    <a href="${fullM.pdf_url}" target="_blank" class="px-8 py-4 bg-gradient-to-r from-brand-dark to-gray-900 text-white rounded-xl hover:from-black hover:to-brand-dark transition-all flex items-center gap-3 font-bold shadow-xl hover:shadow-2xl hover:-translate-y-1 duration-300">
                                        <i class="fas fa-file-pdf text-red-400 text-xl"></i> Lire le document complet
                                    </a>
                                ` : '<span class="text-gray-400 italic font-medium">📄 Aucun PDF disponible</span>'}
                            </div>
                        </div>
                    `;

                    document.getElementById('detailModal').classList.remove('hidden');

                } catch(e) {
                    alert("❌ Impossible de charger les détails");
                    console.error(e);
                }
            },
            
            editMemoire(id) {
                this.openFormModal(id);
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>