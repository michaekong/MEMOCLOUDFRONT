<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portail des Lauréats - Excellence Polytechnique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Outfit:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --enstp-gold: #ffb606;
            --enstp-dark: #020617;
            --enstp-pink: #f472b6;
            --enstp-blue: #3b82f6;
        }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            scroll-behavior: smooth;
            overflow-x: hidden;
        }
        h1, h2, h3, h4, .font-outfit { font-family: 'Outfit', sans-serif; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--enstp-gold); border-radius: 10px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .mesh-gradient {
            background-color: #020617;
            background-image: 
                radial-gradient(at 0% 0%, rgba(255, 182, 6, 0.2) 0, transparent 60%), 
                radial-gradient(at 50% 0%, rgba(59, 130, 246, 0.15) 0, transparent 50%), 
                radial-gradient(at 100% 0%, rgba(244, 114, 182, 0.15) 0, transparent 50%);
            position: absolute;
            inset: 0;
            z-index: 0;
        }

        .glass-premium {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        @keyframes fade-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-up { animation: fade-up 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        .promo-scroll-container {
            mask-image: linear-gradient(to right, transparent, black 8%, black 92%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 8%, black 92%, transparent);
        }

        .testimonial-slide {
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (max-width: 768px) {
            .modal-content-wrapper {
                border-radius: 2rem 2rem 0 0 !important;
                height: 98vh !important;
            }
        }

        .hero-title-shadow {
            text-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .stat-card-glow {
            position: relative;
        }
        .stat-card-glow::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, var(--enstp-gold) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: -1;
            filter: blur(40px);
        }
        .stat-card-glow:hover::after {
            opacity: 0.15;
        }

        /* Active Ken Burns Effect */
        .active-slide-img {
            animation: kenburns 20s linear infinite alternate;
        }
        @keyframes kenburns {
            from { transform: scale(1); }
            to { transform: scale(1.15); }
        }
        /* Animations pour les boutons d'action */
.group:hover .group-hover\:scale-\[1\.02\] {
    transform: scale(1.02);
}

.group:active .group-active\:scale-95 {
    transform: scale(0.95);
}

/* Effet de pulse sur les compteurs */
@keyframes pulse-subtle {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

.pulse-subtle {
    animation: pulse-subtle 2s infinite;
}

/* Transition douce pour les icônes */
.fa-download, .fa-heart, .fa-eye {
    transition: transform 0.2s ease;
}

button:hover .fa-download,
button:hover .fa-heart,
button:hover .fa-eye {
    transform: scale(1.1);
}
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.0.0",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
    "htm": "https://esm.sh/htm@3.1.1",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import htm from 'htm';

        const html = htm.bind(React.createElement);
const BASE_URL = 'https://mcb.reimca-app.com/api';
const UNIV_SLUG = 'ecole-des-travaux';

// ⚡ on déclare les variables avant tout
let TOKEN             = localStorage.getItem('authToken');
let CURRENT_USER_ID   = null;
let CURRENT_USER_NAME = localStorage.getItem('userName') || 'Moi'; // let, pas const

        const ALUMNI_API = "https://mcb.reimca-app.com/api/memoires/universites/ecole-des-travaux/users-stats/";
        const TESTIMONIALS_API = "https://mcb.reimca-app.com/api/universites/universities/ecole-des-travaux/oldstudent/";
// ========== ACTIONS ALUMNI ==========

function viewMemoireDetails(memoireId) {
    window.location.href = `index.html?memoire=${memoireId}`;
}
// ----------  Petit helper  ----------
function getHeaders() {
    const h = { 'Content-Type': 'application/json' };
    if (TOKEN) h['Authorization'] = `Bearer ${TOKEN}`;
    return h;
}

async function likeMemoire(memoireId) {
    const token = localStorage.getItem('authToken');
    if (!token) {
        alert("Veuillez vous connecter pour liker.");
        return;
    }

    try {
        await fetch(`https://mcb.reimca-app.com/api/interactions/likes/toggle/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ memoire_id: memoireId })
        });
    } catch (err) {
        alert("Erreur lors du like.");
    }
}
        const App = () => {
            const [alumni, setAlumni] = useState([]);
            const [testimonials, setTestimonials] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedAlumnus, setSelectedAlumnus] = useState(null);
            const [selectedPromotion, setSelectedPromotion] = useState('All');
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [carouselIndex, setCarouselIndex] = useState(0);
            const [isAutoPlaying, setIsAutoPlaying] = useState(true);
            const [showOnlyProfessors, setShowOnlyProfessors] = useState(false);
           
            
            const promoScrollRef = useRef(null);

            useEffect(() => {
                const init = async () => {
                    setLoading(true);
                    try {
                        const [alumniRes, testRes] = await Promise.all([
                            fetch(ALUMNI_API).then(r => r.json()),
                            fetch(TESTIMONIALS_API).then(r => r.json())
                        ]);
                        setAlumni(alumniRes.utilisateurs_stats || []);
                        
                        // Enchérissement des témoignages si les textes sont trop courts
                        const enrichedTestimonials = (testRes || []).map(t => ({
                            ...t,
                            body: t.body.length < 100 
                                ? `${t.body}. Mon passage à l'École Polytechnique a été un catalyseur pour ma carrière, m'offrant la rigueur et l'audace nécessaires pour concevoir les infrastructures de demain.`
                                : t.body
                        }));
                        setTestimonials(enrichedTestimonials);
                    } catch (err) { console.error('API Error:', err); }
                    finally { setLoading(false); }
                };
                init();
            }, []);

            useEffect(() => {
                if (testimonials.length <= 1 || !isAutoPlaying) return;
                const interval = setInterval(() => {
                    setCarouselIndex(prev => (prev + 1) % testimonials.length);
                }, 10000);
                return () => clearInterval(interval);
            }, [testimonials, isAutoPlaying]);

            const alumniWithPromotions = useMemo(() => {
                return alumni.map(item => {
                    const years = item.memoires_details?.map(m => m.annee) || [];
                    const promoYear = years.length > 0 ? Math.min(...years) : null;
                    return { ...item, promoYear };
                });
            }, [alumni]);

            const promotionsList = useMemo(() => {
                const years = alumniWithPromotions
                    .map(a => a.promoYear)
                    .filter(y => y !== null);
                return ['All', ...new Set(years)].sort((a, b) => {
                    if (a === 'All') return -1;
                    if (b === 'All') return 1;
                    return a - b;
                });
            }, [alumniWithPromotions]);

            const filteredAlumni = useMemo(() => {
    const filtered = alumniWithPromotions.filter(item => {
        const fullName = `${item.utilisateur.prenom} ${item.utilisateur.nom}`.toLowerCase();
        const matchesSearch = fullName.includes(searchTerm.toLowerCase()) || 
                           item.utilisateur.email.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesPromo = selectedPromotion === 'All' || item.promoYear === selectedPromotion;
       const matchesProfessor = showOnlyProfessors ? item.utilisateur.role === 'professeur' : item.utilisateur.role !== 'professeur';
        return matchesSearch && matchesPromo && matchesProfessor;
    });
    return filtered.sort((a, b) => (a.promoYear || 0) - (b.promoYear || 0));
}, [alumniWithPromotions, searchTerm, selectedPromotion, showOnlyProfessors]);
            const globalStats = useMemo(() => ({
                totalAlumni: alumni.length,
                totalWorks: alumni.reduce((acc, curr) => acc + (curr.statistiques_globales?.total_memoires_lies || 0), 0),
                totalPromotions: promotionsList.length - 1,
                totalDownloads: alumni.reduce((acc, curr) => acc + (curr.statistiques_globales?.total_telechargements || 0), 0)
            }), [alumni, promotionsList]);
            const profsCount = useMemo(() =>
  alumniWithPromotions.filter(a => a.utilisateur.role === 'professeur').length,
  [alumniWithPromotions]
);
// APRÈS le render, brancher les écouteurs
useEffect(() => {
  if (!selectedAlumnus) return;

  document.querySelectorAll('[data-action]').forEach(btn => {
    const action = btn.dataset.action;
    const id = btn.dataset.id;

    btn.replaceWith(btn.cloneNode(true)); // enlève ancien écouteur
    const newBtn = document.querySelector(`[data-action="${action}"][data-id="${id}"]`);

    if (action === 'like') {
      newBtn.addEventListener('click', () => window.likeMemoire(id));
    }
    if (action === 'download') {
      newBtn.addEventListener('click', () => window.downloadMemoire(id));
    }
    if (action === 'view') {
      newBtn.addEventListener('click', () => window.viewMemoireDetails(id));
    }
  });
}, [selectedAlumnus]);
            return html`
                <div className="min-h-screen flex flex-col bg-slate-50">
                    <!-- Navigation -->
                    <header className="fixed top-0 left-0 w-full h-[70px] md:h-[90px] bg-white/95 backdrop-blur-xl z-[1000] border-b border-slate-100 flex items-center justify-between px-4 md:px-12 shadow-sm">
                        <div className="flex items-center gap-6 md:gap-10">
                            <div className="h-[40px] md:h-[50px] hover:scale-105 transition-transform cursor-pointer">
                                <img src="images/logo.png" alt="Logo" className="h-full object-contain" />
                            </div>
                            <nav className="hidden xl:block">
                                <ul className="flex items-center gap-10 font-bold text-[11px] uppercase tracking-[0.25em] text-slate-500">
                                    <li><a href="index.html" className="hover:text-[#ffb606] transition-colors relative group">Accueil<span className="absolute -bottom-1 left-0 w-0 h-0.5 bg-[#ffb606] transition-all group-hover:w-full"></span></a></li>
                                    <li><a href="#" className="hover:text-[#ffb606] transition-colors relative group">Formations<span className="absolute -bottom-1 left-0 w-0 h-0.5 bg-[#ffb606] transition-all group-hover:w-full"></span></a></li>
                                    <li><a href="#" className="text-[#ffb606] font-extrabold border-b-2 border-[#ffb606] pb-1">Lauréats</a></li>
                                    <li><a href="#" className="hover:text-[#ffb606] transition-colors relative group">Contact<span className="absolute -bottom-1 left-0 w-0 h-0.5 bg-[#ffb606] transition-all group-hover:w-full"></span></a></li>
                                </ul>
                            </nav>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="hidden lg:flex flex-col items-end mr-6">
                                <span className="text-[10px] font-black text-[#ffb606] uppercase tracking-widest leading-none">Centre d'Ingéniosité</span>
                                <span className="text-sm font-black text-slate-900 font-outfit tracking-tighter">(237) 222 23 09 44</span>
                            </div>
                            <button onClick=${() => setIsMenuOpen(true)} className="xl:hidden text-[#ffb606] text-2xl p-2"><i className="fa-solid fa-bars-staggered"></i></button>
                        </div>
                    </header>

                    <div className="mt-[70px] md:mt-[90px]">
                        <!-- Hero Section -->
                        <section className="relative pt-24 md:pt-48 pb-32 px-6 overflow-hidden bg-[#020617]">
                            <div className="mesh-gradient opacity-100"></div>
                            <div className="relative z-10 max-w-7xl mx-auto">
                                <div className="text-center animate-fade-up mb-20 md:mb-32">
                                    <span className="inline-flex items-center gap-3 px-8 py-3 rounded-full bg-white/5 border border-white/10 text-[#ffb606] font-black text-[11px] uppercase tracking-[0.5em] mb-12 shadow-2xl backdrop-blur-md">
                                        L'Ingéniosité en Héritage
                                    </span>
                                    <h1 className="text-6xl md:text-[10rem] font-black text-white mb-12 tracking-tighter leading-[0.8] uppercase hero-title-shadow">
                                        Talents <br/> <span className="text-[#ffb606] italic">Pluriels</span>
                                    </h1>
                                    <p className="text-slate-300 text-xl md:text-3xl max-w-4xl mx-auto mb-20 font-medium leading-relaxed opacity-90 tracking-tight">
                                        Découvrez les parcours de nos anciens lauréats et diplômés dont les travaux témoignent d'une créativité sans frontières. 
                                        <span className="text-slate-500 block mt-6 italic font-normal text-lg md:text-xl">Un demi-siècle d'ingéniosité pluridisciplinaire au service de la nation.</span>
                                    </p>
                                    
                                    <div className="flex flex-col sm:flex-row items-center justify-center gap-8">
                                        <button onClick=${() => document.getElementById('promo-grid').scrollIntoView({behavior:'smooth'})} className="px-12 py-6 bg-[#ffb606] text-white rounded-2xl font-black text-[12px] uppercase tracking-widest shadow-2xl shadow-yellow-500/40 hover:scale-105 active:scale-95 transition-all w-full sm:w-auto">
                                            Parcourir les Promotions
                                        </button>
                                        <button onClick=${() => document.getElementById('testimonials').scrollIntoView({behavior:'smooth'})} className="px-12 py-6 bg-white/5 border border-white/10 text-white rounded-2xl font-black text-[12px] uppercase tracking-widest hover:bg-white hover:text-slate-900 transition-all w-full sm:w-auto backdrop-blur-md">
                                            Histoires de Réussite
                                        </button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 md:grid-cols-4 gap-6 md:gap-10 animate-fade-up">
                                    ${[
                                        { label: 'Experts Certifiés', val: globalStats.totalAlumni, icon: 'fa-user-tie', color: 'text-white', subtitle: 'Membres actifs' },
                                        { label: 'Pôles d\'Innovation', val: globalStats.totalWorks, icon: 'fa-drafting-compass', color: 'text-[#ffb606]', subtitle: 'Projets livrés' },
                                        { label: 'Héritage Temporel', val: globalStats.totalPromotions, icon: 'fa-timeline', color: 'text-blue-400', subtitle: 'Ans d\'Excellence' },
                                        { label: 'Rayonnement Global', val: globalStats.totalDownloads, icon: 'fa-rocket', color: 'text-pink-500', subtitle: 'Impact Impact' }
                                    ].map((s, i) => html`
                                        <div key=${i} className="glass-premium stat-card-glow p-8 md:p-12 rounded-[3.5rem] text-center group">
                                            <div className="mb-6 text-slate-500 group-hover:text-[#ffb606] transition-all duration-500 transform group-hover:-translate-y-2">
                                                <i className=${`fa-solid ${s.icon} text-3xl md:text-4xl`}></i>
                                            </div>
                                            <div className=${`text-4xl md:text-6xl font-black mb-2 font-outfit tracking-tighter ${s.color}`}>${s.val.toLocaleString()}</div>
                                            <div className="text-white text-[11px] font-black uppercase tracking-[0.3em] mb-1 group-hover:text-[#ffb606] transition-colors">${s.label}</div>
                                            <div className="text-slate-600 text-[9px] font-bold uppercase tracking-widest opacity-60">${s.subtitle}</div>
                                        </div>
                                    `)}
                                </div>
                            </div>
                        </section>

                        <!-- Enhanced Filter Section -->
                        <section id="promo-grid" class="sticky top-[70px] md:top-[90px] z-40 w-full px-4 md:px-8 py-6 bg-white/60 backdrop-blur-2xl border-b border-white/70 shadow-lg shadow-slate-900/5">
  <div class="max-w-7xl mx-auto flex flex-col lg:flex-row items-center gap-6">

    <!-- Barre de recherche flottante -->
    <div class="relative group w-full lg:w-96">
      <i class="fa-solid fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-[#ffb606] transition-colors"></i>
      <input
        type="text"
        placeholder="Rechercher un lauréat..."
        value=${searchTerm}
        onInput=${e => setSearchTerm(e.target.value)}
        class="w-full pl-14 pr-6 py-4 bg-white/80 border border-white/60 rounded-3xl
               text-slate-800 font-semibold placeholder-slate-400
               focus:bg-white focus:border-[#ffb606] focus:ring-4 focus:ring-yellow-400/30
               shadow-md shadow-slate-200/50 transition-all"
      />
    </div>

    <!-- Bouton Professeurs (avec compteur) -->
    <button
      onClick=${() => setShowOnlyProfessors(p => !p)}
      class=${`flex items-center gap-3 px-5 py-3 rounded-3xl border-2 font-bold text-xs uppercase tracking-widest
                transition-all active:scale-95
                ${showOnlyProfessors
                  ? 'bg-[#ffb606] text-white border-[#ffb606] shadow-yellow-200 shadow-xl'
                  : 'bg-white text-slate-500 border-slate-200 hover:border-[#ffb606] hover:text-[#ffb606]'}`}
    >
      <i class="fa-solid fa-chalkboard-user"></i>
      <span>Enseignants</span>
      <span class="grid place-items-center min-w-[22px] h-[22px] px-1.5 text-[10px] rounded-full
                 ${showOnlyProfessors ? 'bg-white text-[#ffb606]' : 'bg-slate-100 text-slate-600'}">
        ${profsCount}
      </span>
    </button>

    <!-- Ligne des promotions (désactivée si professeurs actif) -->
    <div class="relative flex-1 w-full">
      <div class="flex items-center gap-4">
        <span class="hidden sm:block text-[10px] font-black text-slate-400 uppercase tracking-widest">
          Promotions
        </span>
        <span class="flex-1 h-px bg-slate-200"></span>
        ${showOnlyProfessors && html`
          <span class="text-[10px] font-bold text-slate-400">Filtre promotion désactivé</span>
        `}
      </div>

      <div
        class=${`mt-4 flex gap-3 overflow-x-auto pb-3 no-scrollbar scroll-smooth
                 ${showOnlyProfessors ? 'opacity-40 pointer-events-none' : ''}`}
      >
        ${promotionsList.map(year => html`
          <button
            onClick=${() => !showOnlyProfessors && setSelectedPromotion(year)}
            className=${`shrink-0 px-6 py-3 rounded-2xl text-[11px] font-black uppercase tracking-widest
                         border transition-all
                         ${selectedPromotion === year
                           ? 'bg-[#ffb606] text-white border-[#ffb606] shadow'
                           : 'bg-white text-slate-400 border-slate-200 hover:border-[#ffb606] hover:text-[#ffb606]'}`}
          >
            ${year === 'All' ? 'Toutes' : year}
          </button>
        `)}
      </div>
    </div>

  </div>
</section>
                        <!-- Alumni Grid -->
                        <main className="py-24 px-4 bg-white min-h-screen">
                            <div className="max-w-7xl mx-auto">
                                ${loading ? html`
                                    <div className="flex flex-col items-center py-48 gap-8">
                                        <div className="w-16 h-16 border-[5px] border-slate-100 border-t-[#ffb606] rounded-full animate-spin"></div>
                                        <p className="text-slate-400 font-black uppercase text-[12px] tracking-[0.5em]">Accès aux archives lauréats...</p>
                                    </div>
                                ` : html`
                                    <div className="flex flex-col md:flex-row items-center justify-between mb-16 gap-4">
                     <h3 class="text-slate-300 font-black uppercase tracking-[0.6em] text-xs">
  Archives des Diplômés
  <span class="text-[#ffb606]">
    (${filteredAlumni.length}${showOnlyProfessors ? ' Professeurs' : ''})
  </span>
</h3>
                                        <div className="h-px bg-slate-100 flex-1 mx-10 hidden md:block opacity-50"></div>
                                        <span className="text-slate-400 font-bold text-[11px] uppercase tracking-widest bg-slate-50 px-6 py-2 rounded-full">Ordre chronologique ascendant</span>
                                    </div>
                                   <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-5 md:gap-7">
  ${filteredAlumni.map((item, idx) => html`
    <div
      key=${item.utilisateur.id}
      class="group relative bg-white/80 backdrop-blur rounded-3xl p-4 border border-white/70
             hover:border-yellow-300 hover:shadow-2xl hover:shadow-yellow-500/10 
             hover:-translate-y-1 transition-all duration-300 cursor-pointer overflow-hidden"
      onClick=${() => setSelectedAlumnus(item)}
    >
 
      <div class="absolute -inset-1 bg-gradient-to-br from-yellow-300/20 via-transparent to-transparent
                  opacity-0 group-hover:opacity-100 transition-opacity duration-500 rounded-3xl"/>

      <div class="relative mb-3">
        <img
          src=${item.utilisateur.photo_profil || `https://ui-avatars.com/api/?name=${item.utilisateur.nom}&background=f1f5f9&color=64748b&bold=true&size=256`}
          class="w-full aspect-square rounded-2xl object-cover border-2 border-white shadow-lg
                 group-hover:scale-105 transition-transform duration-300"
        />
        <span class="absolute top-2 left-2 px-2 py-1 bg-white/90 backdrop-blur text-[9px] font-black text-slate-700 uppercase tracking-widest rounded-xl shadow-sm">
          Promo ${item.promoYear || '–'}
        </span>
        ${item.utilisateur.role === 'professeur' && html`
          <span class="absolute top-2 right-2 px-2 py-1 bg-gradient-to-r from-purple-400 to-pink-400 text-white text-[9px] font-black uppercase tracking-wider rounded-xl shadow">
            <i class="fa-solid fa-award mr-1"/> Prof
          </span>
        `}
      </div>

      <div class="text-center mb-3">
        <h3 class="text-sm font-black text-slate-800 uppercase tracking-tight truncate">
          ${item.utilisateur.prenom}<br/>${item.utilisateur.nom}
        </h3>
        <p class="text-[10px] text-slate-500 font-medium">
          ${item.utilisateur.role === 'professeur' ? 'Enseignant-chercheur' : 'Étudiant diplômé'}
        </p>
      </div>

   
      <div class="grid grid-cols-3 gap-2 mb-3 text-[10px] font-bold text-slate-500">
        <div class="flex flex-col items-center gap-1">
          <i class="fa-solid fa-file-lines text-blue-500 text-lg"/>
          <span class="text-base font-black text-slate-700">${item.statistiques_globales.total_memoires_lies}</span>

        </div>
        <div class="flex flex-col items-center gap-1">
          <i class="fa-solid fa-star text-yellow-500 text-lg"/>
          <span class="text-base font-black text-yellow-600">${item.statistiques_globales.note_moyenne_globale.toFixed(1)}</span>
      
        </div>
        <div class="flex flex-col items-center gap-1">
          <i class="fa-solid fa-heart text-pink-500 text-lg"/>
          <span class="text-base font-black text-pink-600">${item.statistiques_globales.total_likes}</span>
        
        </div>
      </div>


      <div class="w-full h-1 bg-slate-100 rounded-full overflow-hidden mb-3">
        <div 
          class="h-full bg-gradient-to-r from-yellow-400 to-orange-400 transition-all duration-500"
          style=${{ width: `${Math.min(100, item.statistiques_globales.note_moyenne_globale * 20)}%` }}
        />
      </div>


      <div class="flex justify-center">
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-300 to-yellow-600
                    grid place-items-center text-white shadow-lg
                    group-hover:scale-110 group-hover:shadow-xl transition-all">
          <i class="fa-solid fa-arrow-up-right-from-square text-xs"/>
        </div>
      </div>
    </div>
  `)}
</div>
                                `}
                            </div>
                        </main>

                        <!-- Enhanced Testimonials Section -->
                        <section id="testimonials" className="py-24 md:py-56 bg-[#020617] relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-10 opacity-5 pointer-events-none">
                                <i className="fa-solid fa-quote-right text-[20rem] md:text-[40rem] text-white"></i>
                            </div>

                            <div className="max-w-7xl mx-auto px-6 relative z-10">
                                <div className="text-center mb-16 md:mb-40">
                                    <span className="text-[#ffb606] font-black uppercase tracking-[0.6em] text-[12px] mb-8 block">Héritage d'Ingéniosité</span>
                                    <h2 className="text-5xl md:text-8xl font-black text-white tracking-tighter uppercase leading-tight">Portraits de Réussite</h2>
                                    <div className="w-32 h-2.5 bg-[#ffb606] mx-auto rounded-full mt-10 shadow-3xl shadow-yellow-500/30"></div>
                                </div>

                                <div className="relative max-w-6xl mx-auto" onMouseEnter=${() => setIsAutoPlaying(false)} onMouseLeave=${() => setIsAutoPlaying(true)}>
                                    <div className="relative min-h-[500px] md:min-h-[700px] rounded-[4rem] md:rounded-[6rem] overflow-hidden bg-white/5 backdrop-blur-3xl border border-white/10 shadow-3xl">
                                        ${testimonials.length > 0 && testimonials.map((t, i) => html`
                                            <div 
                                                key=${t.id} 
                                                className=${`absolute inset-0 flex flex-col md:flex-row w-full h-full testimonial-slide ${i === carouselIndex ? 'opacity-100 z-10 translate-x-0' : 'opacity-0 z-0 translate-x-20 pointer-events-none'}`}
                                            >
                                                <div className="w-full md:w-[45%] h-[250px] md:h-auto relative overflow-hidden shrink-0">
                                                    <img src=${t.cover_url} className="absolute inset-0 w-full h-full object-cover active-slide-img" />
                                                    <div className="absolute inset-0 bg-gradient-to-t md:bg-gradient-to-r from-[#020617] via-[#020617]/40 to-transparent opacity-90"></div>
                                                    
                                                    <div className="absolute bottom-10 left-10 md:hidden z-20">
                                                        <span className="px-5 py-2 rounded-full bg-[#ffb606] text-white text-[10px] font-black uppercase tracking-widest shadow-xl">Success Story</span>
                                                    </div>
                                                </div>
                                                <div className="w-full md:w-[55%] p-8 md:p-24 flex flex-col justify-center relative">
                                                    <i className="fa-solid fa-quote-left text-[#ffb606]/10 text-8xl md:text-[12rem] absolute top-8 left-8 md:top-20 md:left-20"></i>
                                                    
                                                    <div className="relative z-10 space-y-6 md:space-y-8">
                                                        <h3 className="text-2xl md:text-6xl font-black text-white tracking-tight uppercase leading-tight">${t.title}</h3>
                                                        <div className="w-16 h-1.5 bg-[#ffb606] rounded-full"></div>
                                                        <!-- Mobile visibility fix: Ensure p is visible and well spaced -->
                                                        <p className="text-slate-300 text-base md:text-3xl italic leading-relaxed font-light opacity-90 overflow-y-auto max-h-[150px] md:max-h-none">
                                                            "${t.body}"
                                                        </p>
                                                        
                                                        <div className="flex items-center gap-6 mt-8 pt-8 border-t border-white/10">
                                                            <div className="w-14 h-14 md:w-20 md:h-20 rounded-[2.5rem] bg-gradient-to-br from-[#ffb606] to-yellow-600 flex items-center justify-center text-white font-black text-xl md:text-2xl font-outfit shadow-2xl">E</div>
                                                            <div className="flex flex-col">
                                                                <span className="text-white font-bold text-xs md:text-sm uppercase tracking-wider">Patrimoine Lauréat</span>
                                                                <span className="text-slate-500 text-[10px] font-black uppercase tracking-[0.2em]">Excellence Polytechnique</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `)}
                                    </div>

                                    <!-- Navigation Arrows -->
                                    <div className="absolute top-1/2 -translate-y-1/2 -left-4 md:-left-16 z-20">
                                        <button onClick=${() => setCarouselIndex(prev => (prev - 1 + testimonials.length) % testimonials.length)} className="w-12 h-12 md:w-20 md:h-20 rounded-full bg-white/10 border border-white/20 text-white flex items-center justify-center hover:bg-[#ffb606] hover:border-[#ffb606] hover:scale-110 transition-all shadow-2xl backdrop-blur-xl group">
                                            <i className="fa-solid fa-chevron-left text-lg md:text-2xl transition-transform group-hover:-translate-x-1"></i>
                                        </button>
                                    </div>
                                    <div className="absolute top-1/2 -translate-y-1/2 -right-4 md:-right-16 z-20">
                                        <button onClick=${() => setCarouselIndex(prev => (prev + 1) % testimonials.length)} className="w-12 h-12 md:w-20 md:h-20 rounded-full bg-white/10 border border-white/20 text-white flex items-center justify-center hover:bg-[#ffb606] hover:border-[#ffb606] hover:scale-110 transition-all shadow-2xl backdrop-blur-xl group">
                                            <i className="fa-solid fa-chevron-right text-lg md:text-2xl transition-transform group-hover:translate-x-1"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Dynamic Progress Indicators -->
                                    <div className="flex justify-center gap-4 mt-12 md:mt-24">
                                        ${testimonials.map((_, i) => html`
                                            <button 
                                                key=${i} 
                                                onClick=${() => setCarouselIndex(i)} 
                                                className=${`h-2.5 transition-all duration-700 rounded-full ${i === carouselIndex ? 'w-24 md:w-48 bg-[#ffb606] shadow-lg shadow-yellow-500/30' : 'w-6 md:w-10 bg-white/10 hover:bg-white/20'}`}
                                            ></button>
                                        `)}
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>

                    <!-- Enhanced Footer -->
                    <footer className="bg-white py-32 border-t border-slate-100 text-center px-6">
                        <div className="max-w-7xl mx-auto">
                            <div className="w-24 h-24 bg-[#ffb606] rounded-[3rem] flex items-center justify-center text-white font-black mx-auto mb-16 shadow-3xl shadow-yellow-200 text-4xl font-outfit">E</div>
                            <h4 className="text-3xl font-black text-slate-900 uppercase tracking-tighter mb-8">Héritage des Diplômés & Lauréats</h4>
                            <p className="text-slate-400 text-lg max-w-2xl mx-auto mb-24 font-medium leading-relaxed opacity-80">
                                Des promotions d'anciens lauréats dont l'ingéniosité pluridisciplinaire façonne l'avenir.
                            </p>
                            <div className="pt-20 border-t border-slate-50 flex flex-col md:flex-row items-center justify-between gap-10">
                                <p className="text-slate-400 text-[12px] font-black uppercase tracking-[0.5em]">© 2025 École Polytechnique - Portail d'Ingéniosité</p>
                                <div className="flex gap-12 text-slate-300">
                                    <i className="fa-brands fa-facebook-f hover:text-[#ffb606] cursor-pointer transition-colors text-xl"></i>
                                    <i className="fa-brands fa-linkedin-in hover:text-[#ffb606] cursor-pointer transition-colors text-xl"></i>
                                    <i className="fa-brands fa-x-twitter hover:text-[#ffb606] cursor-pointer transition-colors text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </footer>

                    <!-- MODAL PROFILE (UPGRADED) -->
                    ${selectedAlumnus && html`
                        <div className="fixed inset-0 z-[2002] flex items-center justify-center p-0 md:p-4 overflow-hidden">
                            <div className="absolute inset-0 bg-slate-900/98 backdrop-blur-3xl transition-opacity" onClick=${() => setSelectedAlumnus(null)}></div>
                            
                            <div className="modal-content-wrapper relative bg-white w-full max-w-6xl rounded-none md:rounded-[5rem] shadow-3xl overflow-hidden flex flex-col h-full md:max-h-[96vh] animate-fade-up">
                                
                                <!-- Compact Profile Header Bar -->
                                <div className="modal-header-compact px-8 py-6 md:px-20 md:py-12 border-b border-slate-100 flex items-center justify-between shrink-0 bg-slate-50/30">
                                    <div className="flex items-center gap-8 md:gap-12">
                                        <div className="relative shrink-0">
                                            <img src=${selectedAlumnus.utilisateur.photo_profil || `https://ui-avatars.com/api/?name=${selectedAlumnus.utilisateur.nom}&background=ffb606&color=fff&bold=true&size=256`} className="w-20 h-20 md:w-36 md:h-36 rounded-[2.5rem] object-cover shadow-2xl border-4 border-white" />
                                            <div className="absolute -bottom-3 -right-3 bg-[#ffb606] text-white px-4 py-1.5 rounded-2xl text-[9px] md:text-[11px] font-black uppercase border-2 border-white shadow-xl">
                                                Diplômé ${selectedAlumnus.promoYear || '---'}
                                            </div>
                                        </div>
                                        <div className="min-w-0">
                                            <h3 className="text-2xl md:text-5xl font-black text-slate-800 tracking-tighter uppercase leading-tight truncate">
                                                ${selectedAlumnus.utilisateur.prenom} ${selectedAlumnus.utilisateur.nom}
                                            </h3>
                                            <div className="flex items-center gap-8 mt-3">
                                                <span className="text-[11px] md:text-[14px] font-bold text-slate-400 truncate opacity-80 font-outfit">${selectedAlumnus.utilisateur.email}</span>
                                                ${selectedAlumnus.utilisateur.linkedin && html`
                                                    <a href=${selectedAlumnus.utilisateur.linkedin} target="_blank" className="text-blue-600 text-lg md:text-2xl hover:scale-125 transition-transform">
                                                        <i className="fa-brands fa-linkedin"></i>
                                                    </a>
                                                `}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button onClick=${() => setSelectedAlumnus(null)} className="w-14 h-14 md:w-24 md:h-24 rounded-[2rem] bg-slate-100 text-slate-400 flex items-center justify-center hover:bg-red-50 hover:text-red-500 transition-all focus:outline-none shadow-sm">
                                        <i className="fa-solid fa-times text-xl md:text-3xl"></i>
                                    </button>
                                </div>

                                <div className="p-10 md:p-20 overflow-y-auto custom-scrollbar flex-1 bg-white">
                                    
                                    <!-- Statistics Matrix with New Icons & More Detail -->
                                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-6 md:gap-8 mb-20">
                                        ${[
                                            { label: 'Travaux Scientifiques', val: selectedAlumnus.statistiques_globales.total_memoires_auteur, icon: 'fa-microscope', color: 'text-blue-500' },
                                            { label: 'Indice d\'Excellence', val: selectedAlumnus.statistiques_globales.note_moyenne_globale.toFixed(1), icon: 'fa-star-half-stroke', color: 'text-yellow-400' },
                                            { label: 'Rayonnement Impact', val: selectedAlumnus.statistiques_globales.total_telechargements, icon: 'fa-rocket', color: 'text-blue-400' },
                                            { label: 'Reconnaissance Pair', val: selectedAlumnus.statistiques_globales.total_likes, icon: 'fa-heart', color: 'text-pink-500' },
                                            { label: 'Complexité Gérée', val: selectedAlumnus.statistiques_globales.total_memoires_encadres, icon: 'fa-gears', color: 'text-orange-500' },
                                            { label: 'Dialogues Techniques', val: selectedAlumnus.statistiques_globales.total_commentaires, icon: 'fa-comments', color: 'text-indigo-400' },
                                            { label: 'Évaluations Actives', val: selectedAlumnus.statistiques_globales.total_notations, icon: 'fa-check-double', color: 'text-emerald-500' },
                                            { label: 'Corpus Global', val: selectedAlumnus.statistiques_globales.total_memoires_lies, icon: 'fa-folder-open', color: 'text-[#ffb606]' }
                                        ].map((s, i) => html`
                                            <div key=${i} className="bg-slate-50/80 p-8 md:p-10 rounded-[3rem] border border-slate-100 text-center transition-all group hover:bg-white hover:shadow-2xl">
                                                <i className=${`fa-solid ${s.icon} ${s.color} text-xl md:text-3xl mb-5 opacity-40`}></i>
                                                <div className="text-3xl md:text-5xl font-black text-slate-800 font-outfit leading-none mb-2">${s.val}</div>
                                                <div className="text-[9px] md:text-[11px] font-black text-slate-400 uppercase tracking-widest leading-tight opacity-70">${s.label}</div>
                                            </div>
                                        `)}
                                    </div>

                                    <!-- Content Split Layout -->
                                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-12 md:gap-20">
                                        
                                        <!-- Expertise distribution (Visualisation Thématique) -->
                                        ${selectedAlumnus.statistiques_par_domaine && selectedAlumnus.statistiques_par_domaine.length > 0 && html`
                                            <div className="lg:col-span-4 space-y-12">
                                                <h4 className="text-[13px] font-black uppercase tracking-[0.7em] text-slate-300 flex items-center gap-8">
                                                    Domaines d'Influence
                                                    <span className="flex-1 h-px bg-slate-100"></span>
                                                </h4>
                                                <div className="space-y-8">
                                                    ${selectedAlumnus.statistiques_par_domaine.map((d, i) => html`
                                                        <div key=${i} className="bg-slate-50 p-8 rounded-[2.5rem] border border-slate-100 group hover:bg-white transition-all">
                                                            <div className="flex justify-between items-center mb-5">
                                                                <span className="font-black text-slate-800 uppercase text-xs tracking-wider">${d.domaine}</span>
                                                                <span className="text-[10px] font-black text-[#ffb606] uppercase tracking-widest">${d.nb_memoires} Projets</span>
                                                            </div>
                                                            <div className="w-full h-2 bg-slate-200 rounded-full overflow-hidden shadow-inner">
                                                                <div className="h-full bg-[#ffb606] transition-all duration-1000" style=${{width: `${Math.min(100, (d.nb_memoires / selectedAlumnus.statistiques_globales.total_memoires_lies) * 100)}%`}}></div>
                                                            </div>
                                                        </div>
                                                    `)}
                                                </div>
                                            </div>
                                        `}

                                      <div className=${selectedAlumnus.statistiques_par_domaine?.length ? "lg:col-span-8" : "lg:col-span-12"}>
  <h4 className="text-xs font-black uppercase tracking-[0.7em] text-slate-300 mb-10">
    Répertoire Scientifique
  </h4>

  <div className="space-y-10">
    ${selectedAlumnus.memoires_details.map(m => html`
      <div key=${m.id} className="bg-white p-10 rounded-[3rem] border border-slate-100 hover:border-yellow-400 transition">

        <div className="flex flex-col md:flex-row justify-between items-start gap-6">
          <div className="min-w-0">
            <h5 className="text-xl md:text-2xl font-black text-slate-800 uppercase tracking-tight mb-2">${m.titre}</h5>
            <span className="text-xs text-slate-400">${m.annee} · ${m.role}</span>
          </div>
<p className="text-xs text-slate-400 mb-2">Cliquez pour interagir :</p> 
          <!-- Actions unifiées -->
<div className="flex items-center gap-4 text-slate-500 mt-4">
  <button
    data-memoire-id=${m.id}
    data-action="like"
    data-id=${m.id}
    class="like-btn group flex items-center gap-2 px-3 py-2 rounded-2xl border border-slate-200 hover:bg-pink-50 transition"
  >
    <i class="fa-solid fa-heart text-slate-300 group-hover:text-pink-500 transition"></i>
    <span class="text-xs font-bold">${m.nb_likes}</span>
  </button>

  <!-- DOWNLOAD -->
  <button
    data-action="download"
    data-id=${m.id}
   data-pdfurl=${m.pdf_url?.startsWith('http')
              ? m.pdf_url
              : `https://mcb.reimca-app.com${m.pdf_url}`}
    class="group flex items-center gap-2 px-3 py-2 rounded-2xl border border-slate-200 hover:bg-green-50 transition"
  >
    <i class="fa-solid fa-arrow-down text-slate-300 group-hover:text-green-500 transition"></i>
    <span class="text-xs font-bold">${m.nb_telechargements}</span>
  </button>

  <button
    data-action="view"
    data-id=${m.id}
    class="group flex items-center gap-2 px-3 py-2 rounded-2xl border border-slate-200 hover:bg-blue-50 transition"
  >
    <i class="fa-solid fa-eye text-slate-300 group-hover:text-blue-500 transition"></i>
    <span class="text-xs font-bold">Voir</span>
  </button>
</div>
        </div>

        <!-- Note unique -->
        <div className="mt-4 text-xs text-slate-400">
          Note moyenne : ${m.note_moyenne.toFixed(1)}/5
        </div>

      </div>
    `)}
  </div>
</div>
                                    </div>
                                </div>
                                
                                <div className="p-10 md:p-14 bg-[#020617] flex items-center justify-between shrink-0 mt-auto">
                                    <div className="flex items-center gap-8">
                                        <div className="w-14 h-14 rounded-[2rem] bg-[#ffb606] flex items-center justify-center text-white font-black text-2xl font-outfit shadow-2xl">E</div>
                                        <span className="text-slate-500 text-[11px] font-black uppercase tracking-[0.7em] hidden sm:block">Patrimoine Scientifique Certifié</span>
                                    </div>
                                    <button onClick=${() => setSelectedAlumnus(null)} className="bg-[#ffb606] text-white px-12 py-5 rounded-2xl font-black text-[12px] uppercase tracking-widest hover:bg-yellow-500 transition-all shadow-xl active:scale-95">Quitter les Archives</button>
                                </div>
                            </div>
                        </div>
                    `}
                </div>
            `;
            
        };
/* ====== Délégation unique des clics sur la modale ====== */
document.addEventListener('click', async e => {
  const btn = e.target.closest('[data-action][data-id]'); // remonte jusqu’au bouton
  if (!btn) return;                                      // clic ailleurs → on ignore

  const action = btn.dataset.action;
  const id     = btn.dataset.id;
  const pdf_url = btn.dataset.pdfurl;
  const token  = localStorage.getItem('authToken');

  switch (action) {
    case 'like':
      if (!token) { alert('Connectez-vous pour liker.'); return; }
      await fetch(`${BASE_URL}/interactions/likes/toggle/`, {
        method : 'POST',
        headers: getHeaders(),
        body   : JSON.stringify({ memoire_id: id })
      });
      /* Mise à jour visuelle instantanée */
      const icon  = btn.querySelector('i');
      const count = btn.querySelector('span');
      const liked = icon.classList.contains('text-pink-500');
      icon.classList.toggle('text-pink-500', !liked);
      icon.classList.toggle('text-slate-300', liked);
      count.textContent = parseInt(count.textContent, 10) + (liked ? -1 : 1);
      break;

    case 'download':
  if (!token) { alert('Connectez-vous pour télécharger.'); return; }
  
  const pdfUrl = btn.dataset.pdfurl; // Récupère l'URL depuis data-pdfurl
  
  if (!pdfUrl) {
    alert('Aucun fichier PDF disponible pour ce mémoire.');
    return;
  }
  
  // Enregistre le téléchargement
  await fetch(`${BASE_URL}/interactions/telechargements/telecharger/`, {
    method: 'POST',
    headers: getHeaders(),
    body: JSON.stringify({ memoire: id })
  });
  
  // Ouvre le PDF dans un nouvel onglet
  window.open(pdfUrl, '_blank');
  break;

    case 'view':
      window.location.href = `index.html?memoire=${id}`;
      break;
  }
});
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
        // Rendre les fonctions globales (window)
window.likeMemoire = async (memoireId) => {
  const token = localStorage.getItem('authToken');
  if (!token) { alert("Connectez-vous pour liker."); return; }

  await fetch(`${BASE_URL}/interactions/likes/toggle/`, {
    method: 'POST',
    headers: getHeaders(),
    body: JSON.stringify({ memoire_id: memoireId })
  });

  // Mise à jour visuelle (toggle cœur + compteur)
  const btn = document.querySelector(`[data-memoire-id="${memoireId}"] .like-btn`);
  const icon = btn.querySelector('i');
  const count = btn.querySelector('span');
  const isLiked = icon.classList.contains('text-pink-500');
  icon.classList.toggle('text-pink-500', !isLiked);
  icon.classList.toggle('text-slate-300', isLiked);
  count.textContent = parseInt(count.textContent) + (isLiked ? -1 : 1);
};


window.viewMemoireDetails = (memoireId) => {
  window.location.href = `index.html?memoire=${memoireId}`;
};
// ====== Fonction globale de téléchargement (corrigée) ======
function downloadMemoire(e, id, url) {
    if(e) e.stopPropagation();
    if (!TOKEN) { showAuthPrompt(); return; }
    fetch(`${BASE_URL}/interactions/telechargements/telecharger/`, { method: 'POST', headers: getHeaders(), body: JSON.stringify({ memoire: id }) });
    window.open(url, '_blank');
}
// ====== Gestionnaire de téléchargement via data-attributes ======
window.handleDownload = async (memoireId, pdfUrl) => {
  if (!TOKEN) { 
    alert("Veuillez vous connecter pour télécharger.");
    return; 
  }

  try {
    // Enregistrer le téléchargement
    const res = await fetch(`${BASE_URL}/interactions/telechargements/telecharger/`, {
      method: 'POST',
      headers: getHeaders(),
      body: JSON.stringify({ memoire: memoireId })
    });

    if (!res.ok) throw new Error('Erreur lors de l\'enregistrement');

    // Ouvrir le PDF
    if (pdfUrl && pdfUrl !== 'undefined' && pdfUrl !== 'null') {
      window.open(pdfUrl, '_blank');
    } else {
      alert('Aucun fichier PDF disponible pour ce mémoire.');
    }
  } catch (err) {
    console.error('Erreur:', err);
    alert('Impossible de télécharger.');
  }
};
    </script>
</body>
</html>